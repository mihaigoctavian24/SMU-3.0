@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using SMU.Services
@inject NavigationManager Navigation
@inject IKeyboardShortcutService KeyboardService
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService
@implements IAsyncDisposable

<AuthorizeView>
    <Authorized Context="authContext">
        <RadzenLayout>
            <!-- Sidebar -->
            <RadzenSidebar @bind-Expanded="@SidebarExpanded" Style="width: 250px;">
                <RadzenStack Gap="0" Class="rz-h-full">
                    <!-- Logo -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem" Class="rz-p-3 rz-border-bottom" Style="height: 64px;">
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="width: 40px; height: 40px; background: linear-gradient(135deg, #4f46e5, #6366f1); border-radius: 12px;">
                            <RadzenIcon Icon="school" Style="color: white; font-size: 20px;" />
                        </RadzenStack>
                        @if (SidebarExpanded)
                        {
                            <RadzenText TextStyle="TextStyle.H6" Class="rz-m-0" Style="font-weight: 600;">SMU</RadzenText>
                        }
                    </RadzenStack>

                    <!-- Navigation Menu -->
                    <RadzenPanelMenu Class="rz-flex-grow-1">
                        <RadzenPanelMenuItem Text="@Localizer["Dashboard"]" Icon="dashboard" Path="/dashboard" />

                        @if (CanManageStudents(authContext))
                        {
                            <RadzenPanelMenuItem Text="@Localizer["Students"]" Icon="people" Path="/studenti" />
                        }

                        <RadzenPanelMenuItem Text="@Localizer["Grades"]" Icon="grading" Path="/note" />

                        @if (CanManageAttendance(authContext))
                        {
                            <RadzenPanelMenuItem Text="@Localizer["Attendance"]" Icon="event_available" Path="/prezente" />
                        }

                        <RadzenPanelMenuItem Text="@Localizer["Schedule"]" Icon="schedule" Path="/orar" />

                        @if (CanViewFaculties(authContext))
                        {
                            <RadzenPanelMenuItem Text="@Localizer["Faculties"]" Icon="business" Path="/facultati" />
                        }

                        <RadzenPanelMenuItem Text="@Localizer["Analytics"]" Icon="analytics" Path="@GetAnalyticsLink(authContext)" />


                        <RadzenPanelMenuItem Text="@Localizer["Export"]" Icon="download" Path="/export" />

                        @if (GetUserRole(authContext) == "Admin")
                        {
                            <RadzenPanelMenuItem Text="@Localizer["Admin"]" Icon="admin_panel_settings" Path="/admin/utilizatori" />
                            <RadzenPanelMenuItem Text="Activity Feed" Icon="bolt" Path="/admin/activity-feed" />
                        }

                        <RadzenPanelMenuItem Text="@Localizer["Settings"]" Icon="settings" Path="/setari" />
                    </RadzenPanelMenu>

                    <!-- User Info & Logout -->
                    <RadzenStack Class="rz-p-3 rz-border-top" Gap="0.5rem">
                        @if (SidebarExpanded)
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                                <RadzenGravatar Email="@GetFullName(authContext)" Style="width: 40px; height: 40px;" />
                                <RadzenStack Gap="0" Class="rz-flex-grow-1" Style="min-width: 0;">
                                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-m-0" Style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        @GetFullName(authContext)
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="rz-m-0 rz-color-secondary">
                                        @GetRoleDisplayName(authContext)
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenButton Text="@Localizer["Logout"]" Icon="logout" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Style="width: 100%;" Click="@Logout" />
                        }
                        else
                        {
                            <RadzenButton Icon="logout" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@Logout" title="@Localizer["Logout"]" />
                        }
                    </RadzenStack>
                </RadzenStack>
            </RadzenSidebar>

            <!-- Main Content Area -->
            <RadzenBody>
                <!-- Header -->
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-px-4 smu-header" Style="height: 64px; background: white;">
                    <!-- Left: Sidebar Toggle + Search -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenButton Icon="@(SidebarExpanded ? "menu_open" : "menu")" ButtonStyle="ButtonStyle.Light" Click="@ToggleSidebar" />
                        <RadzenTextBox Placeholder="@Localizer["SearchPlaceholder"]" Style="width: 250px;" @bind-Value="@SearchQuery" />
                    </RadzenStack>

                    <!-- Right: Date, Notifications, User Menu -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                        <!-- Current Date -->
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-px-3 rz-py-2 rz-background-color-base-200" Style="border-radius: 8px;">
                            <RadzenIcon Icon="calendar_today" Style="font-size: 16px;" />
                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-m-0">@CurrentDate</RadzenText>
                        </RadzenStack>

                        <!-- Notifications -->
                        <RadzenButton Icon="notifications" ButtonStyle="ButtonStyle.Light" />

                        <!-- User Avatar & Dropdown -->
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenGravatar Email="@GetFullName(authContext)" Style="width: 36px; height: 36px;" />
                            <RadzenStack Gap="0" Class="rz-display-none rz-display-sm-block">
                                <RadzenText TextStyle="TextStyle.Body2" Class="rz-m-0" Style="font-weight: 500;">@GetFullName(authContext)</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-m-0 rz-color-secondary">@GetUserRole(authContext)</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenStack>

                <!-- Page Content -->
                <RadzenContent Class="rz-p-4">
                    @Body
                </RadzenContent>
            </RadzenBody>
        </RadzenLayout>
        <RadzenComponents @rendermode="InteractiveServer" />
    </Authorized>
    <NotAuthorized>
        @Body
        <RadzenComponents @rendermode="InteractiveServer" />
    </NotAuthorized>
</AuthorizeView>

<div id="blazor-error-ui" data-nosnippet>
    A aparut o eroare neasteptata.
    <a href="." class="reload">Reincarca</a>
    <span class="dismiss">X</span>
</div>

@code {
    [Inject] private IStringLocalizer<SMU.Resources.SharedResources> Localizer { get; set; } = default!;

    private bool SidebarExpanded { get; set; } = true;
    private string SearchQuery { get; set; } = string.Empty;
    private string CurrentDate => DateTime.Now.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("ro-RO"));

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeKeyboardShortcuts();
        }
    }

    private async Task InitializeKeyboardShortcuts()
    {
        try
        {
            await KeyboardService.InitializeAsync();

            // Navigation Shortcuts
            await KeyboardService.RegisterShortcutAsync("G D", "Go to Dashboard", "Navigation",
                async () => { Navigation.NavigateTo("/dashboard"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G S", "Go to Students", "Navigation",
                async () => { Navigation.NavigateTo("/studenti"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G G", "Go to Grades", "Navigation",
                async () => { Navigation.NavigateTo("/note"); await Task.CompletedTask; });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to initialize keyboard shortcuts: {ex.Message}");
        }
    }

    private void ToggleSidebar()
    {
        SidebarExpanded = !SidebarExpanded;
    }

    private async Task Logout()
    {
        Navigation.NavigateTo("/logout", forceLoad: true);
        await Task.CompletedTask;
    }

    // Role helpers
    private string GetUserRole(AuthenticationState authState) =>
        authState.User.FindFirst("Role")?.Value ?? "Student";

    private string GetFullName(AuthenticationState authState) =>
        authState.User.FindFirst("FullName")?.Value ?? authState.User.Identity?.Name ?? "User";

    private string GetRoleDisplayName(AuthenticationState authState) => GetUserRole(authState) switch
    {
        "Admin" => "Administrator",
        "Rector" => "Rector",
        "Dean" => "Decan",
        "Secretary" => "Secretar",
        "Professor" => "Profesor",
        "Student" => "Student",
        _ => GetUserRole(authState)
    };

    private bool CanManageStudents(AuthenticationState authState)
    {
        var role = GetUserRole(authState);
        return role is "Secretary" or "Dean" or "Rector" or "Admin";
    }

    private bool CanManageAttendance(AuthenticationState authState)
    {
        var role = GetUserRole(authState);
        return role is "Professor" or "Secretary" or "Dean" or "Admin";
    }

    private bool CanViewFaculties(AuthenticationState authState)
    {
        var role = GetUserRole(authState);
        return role is "Dean" or "Rector" or "Admin";
    }

    private string GetAnalyticsLink(AuthenticationState authState) => GetUserRole(authState) switch
    {
        "Student" => "/analytics/student",
        "Professor" => "/analytics/professor",
        "Dean" => "/analytics/faculty",
        "Rector" => "/analytics/university",
        "Admin" => "/analytics/university",
        _ => "/analytics/student"
    };

    public async ValueTask DisposeAsync()
    {
        await Task.CompletedTask;
    }
}
