@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using SMU.Services
@inject NavigationManager Navigation
@inject IKeyboardShortcutService KeyboardService
@implements IAsyncDisposable

<AuthorizeView>
    <Authorized Context="authContext">
        <!-- Authenticated Layout with Sidebar and Header Components -->
        <div class="flex h-screen overflow-hidden bg-gray-50 dark:bg-gray-900">
            <!-- Sidebar Component -->
            <Sidebar
                Collapsed="@SidebarCollapsed"
                CollapsedChanged="@HandleSidebarCollapsedChanged"
                UserName="@GetFullName(authContext)"
                UserRole="@GetUserRole(authContext)" />

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Header Component -->
                <Header
                    UserName="@GetFullName(authContext)"
                    UserRole="@GetUserRole(authContext)"
                    OnMobileMenuToggle="@HandleMobileMenuToggle" />

                <!-- Page Content -->
                <main class="flex-1 overflow-auto p-6">
                    @Body
                </main>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay (for small screens) -->
        @if (ShowMobileMenu)
        {
            <div class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 lg:hidden" @onclick="CloseMobileMenu">
                <div class="fixed inset-y-0 left-0 w-64 z-50" @onclick:stopPropagation="true">
                    <Sidebar
                        Collapsed="false"
                        CollapsedChanged="@HandleSidebarCollapsedChanged"
                        UserName="@GetFullName(authContext)"
                        UserRole="@GetUserRole(authContext)" />
                </div>
            </div>
        }

        <!-- Keyboard Shortcuts Modals -->
        <ShortcutsHelpModal @bind-IsVisible="ShowShortcutsHelp" />
        <CommandPalette @bind-IsVisible="ShowCommandPalette" />
    </Authorized>
    <NotAuthorized>
        <!-- Simple layout for non-authenticated pages -->
        @Body
    </NotAuthorized>
</AuthorizeView>

<div id="blazor-error-ui" data-nosnippet>
    A aparut o eroare neasteptata.
    <a href="." class="reload">Reincarca</a>
    <span class="dismiss">X</span>
</div>

@code {
    private bool SidebarCollapsed { get; set; }
    private bool ShowMobileMenu { get; set; }
    private bool ShowShortcutsHelp { get; set; }
    private bool ShowCommandPalette { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeKeyboardShortcuts();
        }
    }

    private async Task InitializeKeyboardShortcuts()
    {
        try
        {
            await KeyboardService.InitializeAsync();

            // Navigation Shortcuts (G prefix sequences)
            await KeyboardService.RegisterShortcutAsync("G D", "Go to Dashboard", "Navigation",
                async () => { Navigation.NavigateTo("/dashboard"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G S", "Go to Students", "Navigation",
                async () => { Navigation.NavigateTo("/studenti"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G G", "Go to Grades", "Navigation",
                async () => { Navigation.NavigateTo("/note"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G A", "Go to Attendance", "Navigation",
                async () => { Navigation.NavigateTo("/prezente"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G R", "Go to Reports", "Navigation",
                async () => { Navigation.NavigateTo("/rapoarte"); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("G E", "Go to Export", "Navigation",
                async () => { Navigation.NavigateTo("/export"); await Task.CompletedTask; });

            // Action Shortcuts
            var isMac = await IsRunningOnMac();
            var modifierKey = isMac ? "Cmd" : "Ctrl";

            await KeyboardService.RegisterShortcutAsync($"{modifierKey}+K", "Open Command Palette", "Actions",
                async () => { ShowCommandPalette = true; StateHasChanged(); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("?", "Show Keyboard Shortcuts", "General",
                async () => { ShowShortcutsHelp = true; StateHasChanged(); await Task.CompletedTask; });

            await KeyboardService.RegisterShortcutAsync("Esc", "Close Modal/Dropdown", "General",
                async () =>
                {
                    if (ShowCommandPalette) ShowCommandPalette = false;
                    if (ShowShortcutsHelp) ShowShortcutsHelp = false;
                    if (ShowMobileMenu) ShowMobileMenu = false;
                    StateHasChanged();
                    await Task.CompletedTask;
                });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to initialize keyboard shortcuts: {ex.Message}");
        }
    }

    private async Task<bool> IsRunningOnMac()
    {
        // Simple platform detection - in production you'd use JSInterop
        return false; // Default to Windows/Linux for now
    }

    private void HandleSidebarCollapsedChanged(bool collapsed)
    {
        SidebarCollapsed = collapsed;
    }

    private void HandleMobileMenuToggle()
    {
        ShowMobileMenu = !ShowMobileMenu;
    }

    private void CloseMobileMenu()
    {
        ShowMobileMenu = false;
    }

    private string GetUserRole(AuthenticationState authState)
    {
        return authState.User.FindFirst("Role")?.Value ?? "Student";
    }

    private string GetFullName(AuthenticationState authState)
    {
        return authState.User.FindFirst("FullName")?.Value ?? authState.User.Identity?.Name ?? "User";
    }

    public async ValueTask DisposeAsync()
    {
        // Cleanup will happen automatically through service disposal
        await Task.CompletedTask;
    }
}
