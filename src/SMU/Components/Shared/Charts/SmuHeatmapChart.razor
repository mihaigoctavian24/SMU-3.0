@using ApexCharts

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
    @if (IsLoading)
    {
        <div class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
        </div>
    }
    else if (Data == null || !Data.Any())
    {
        <div class="flex flex-col items-center justify-center h-64 text-gray-400">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p class="text-sm">Nu sunt date de prezență disponibile</p>
        </div>
    }
    else
    {
        <ApexChart TItem="HeatmapDataPoint"
                   Title="@Title"
                   Options="options"
                   Height="@Height">
            @foreach (var week in GetWeeklyData())
            {
                <ApexPointSeries TItem="HeatmapDataPoint"
                                 Items="week.Data"
                                 Name="@week.WeekLabel"
                                 SeriesType="SeriesType.Heatmap"
                                 XValue="e => e.Day"
                                 YAggregate="e => e.Average(o => o.Value)"
                                 ShowDataLabels />
            }
        </ApexChart>
    }
</div>

@code {
    [Parameter] public string Title { get; set; } = "Attendance Heatmap";
    [Parameter] public Dictionary<DateTime, decimal> Data { get; set; } = new();
    [Parameter] public int Month { get; set; } = DateTime.Now.Month;
    [Parameter] public int Year { get; set; } = DateTime.Now.Year;
    [Parameter] public int Height { get; set; } = 350;
    [Parameter] public bool IsLoading { get; set; } = false;

    private ApexChartOptions<HeatmapDataPoint> options = new();

    protected override void OnParametersSet()
    {
        options = new ApexChartOptions<HeatmapDataPoint>
        {
            Theme = new Theme
            {
                Mode = Mode.Light
            },
            Chart = new Chart
            {
                Toolbar = new Toolbar
                {
                    Show = true,
                    Tools = new Tools
                    {
                        Download = true
                    }
                }
            },
            PlotOptions = new PlotOptions
            {
                Heatmap = new PlotOptionsHeatmap
                {
                    Radius = 2,
                    EnableShades = true,
                    ShadeIntensity = 0.5
                }
            },
            DataLabels = new DataLabels
            {
                Enabled = true,
                Style = new DataLabelsStyle
                {
                    FontSize = "10px",
                    FontWeight = "600",
                    Colors = new List<string> { "#000" }
                }
            },
            Xaxis = new XAxis
            {
                Type = XAxisType.Category,
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        FontSize = "12px",
                        FontWeight = "600"
                    }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Style = new AxisLabelStyle
                        {
                            FontSize = "12px",
                            FontWeight = "600"
                        }
                    }
                }
            },
            Tooltip = new Tooltip
            {
                Enabled = true
            },
            Legend = new Legend
            {
                Show = true,
                Position = LegendPosition.Bottom,
                FontSize = "12px"
            }
        };
    }

    private List<WeekData> GetWeeklyData()
    {
        var firstDay = new DateTime(Year, Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);
        var weekDataList = new List<WeekData>();

        var currentWeekStart = firstDay;
        var weekNumber = 1;

        while (currentWeekStart <= lastDay)
        {
            var weekEnd = currentWeekStart.AddDays(6);
            if (weekEnd > lastDay)
                weekEnd = lastDay;

            var weekData = new WeekData
            {
                WeekLabel = $"Săptămâna {weekNumber}",
                Data = new List<HeatmapDataPoint>()
            };

            for (var day = currentWeekStart; day <= weekEnd; day = day.AddDays(1))
            {
                var value = Data.ContainsKey(day) ? Data[day] : 0;
                weekData.Data.Add(new HeatmapDataPoint
                {
                    Day = day.ToString("ddd dd"),
                    Value = value
                });
            }

            weekDataList.Add(weekData);
            currentWeekStart = weekEnd.AddDays(1);
            weekNumber++;
        }

        return weekDataList;
    }

    public class HeatmapDataPoint
    {
        public string Day { get; set; } = string.Empty;
        public decimal Value { get; set; }
    }

    private class WeekData
    {
        public string WeekLabel { get; set; } = string.Empty;
        public List<HeatmapDataPoint> Data { get; set; } = new();
    }
}
