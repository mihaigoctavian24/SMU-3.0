@page "/facultati"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageFaculties")]
@inject IFacultyService FacultyService
@inject NavigationManager Navigation
@inject Radzen.DialogService DialogService

<PageTitle>Facultăți - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Facultăți</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Gestionează facultățile din universitate</RadzenText>
        </RadzenStack>
        <RadzenButton Text="Adaugă Facultate"
                      Icon="add"
                      ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/facultati/nou"))" />
    </RadzenStack>

    <!-- Filters & Search -->
    <RadzenCard Style="padding: 1.5rem;">
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="5">
                <RadzenFormField Text="Căutare" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="searchTerm"
                                   Placeholder="Nume sau cod facultate..."
                                   @oninput="HandleSearchKeyUp" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Status Filter -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedStatus"
                                    Data="@statusOptions"
                                    TextProperty="Text"
                                    ValueProperty="Value"
                                    AllowClear="true"
                                    Placeholder="Toate statusurile"
                                    Change="@(args => ApplyFilters())"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Export -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenStack JustifyContent="JustifyContent.End" Style="height: 100%;">
                    <RadzenButton Text="Export CSV"
                                  Icon="download"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@ExportToCSV"
                                  Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Faculties Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenStack>
        }
        else if (faculties.Items.Any())
        {
            <RadzenDataGrid Data="@faculties.Items" TItem="FacultyListDto" AllowSorting="true" Style="border: none;">
                <Columns>
                    <RadzenDataGridColumn TItem="FacultyListDto" Property="Name" Title="Nume" Sortable="true">
                        <Template Context="faculty">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@faculty.Name</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="FacultyListDto" Property="Code" Title="Cod" Width="100px" Sortable="true">
                        <Template Context="faculty">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-family: monospace;">@faculty.Code</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="FacultyListDto" Property="DeanName" Title="Decan">
                        <Template Context="faculty">
                            <RadzenText TextStyle="TextStyle.Body2" Style="@($"margin: 0; color: {(faculty.DeanName == null ? "var(--rz-text-disabled-color)" : "inherit")};")">
                                @(faculty.DeanName ?? "Neasignat")
                            </RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="FacultyListDto" Property="ProgramsCount" Title="Programe" Width="100px" TextAlign="TextAlign.Center">
                        <Template Context="faculty">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@faculty.ProgramsCount</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="FacultyListDto" Property="StudentsCount" Title="Studenți" Width="100px" TextAlign="TextAlign.Center">
                        <Template Context="faculty">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@faculty.StudentsCount</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="FacultyListDto" Property="IsActive" Title="Status" Width="100px">
                        <Template Context="faculty">
                            <RadzenBadge BadgeStyle="@(faculty.IsActive ? BadgeStyle.Success : BadgeStyle.Light)"
                                         Text="@(faculty.IsActive ? "Activ" : "Inactiv")"
                                         IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="FacultyListDto" Title="Acțiuni" Width="180px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="faculty">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                                <RadzenButton Icon="visibility"
                                              ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/facultati/{faculty.Id}"))"
                                              title="Vezi" />
                                <RadzenButton Icon="edit"
                                              ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/facultati/{faculty.Id}/editare"))"
                                              title="Editează" />
                                <RadzenButton Icon="delete"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => ConfirmDelete(faculty.Id))"
                                              title="Șterge" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <!-- Pagination -->
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--rz-border-color);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Afișează</RadzenText>
                        <RadzenDropDown @bind-Value="pageSize"
                                        Data="@pageSizeOptions"
                                        Change="@(args => ApplyFilters())"
                                        Style="width: 80px;" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">din @faculties.TotalCount facultăți</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenButton Text="Anterior"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@PreviousPage"
                                      Disabled="@(!faculties.HasPreviousPage)" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Pagina @faculties.Page din @faculties.TotalPages
                        </RadzenText>
                        <RadzenButton Text="Următorul"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@NextPage"
                                      Disabled="@(!faculties.HasNextPage)" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        }
        else
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenIcon Icon="business" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: var(--rz-text-secondary-color);">
                    Nu au fost găsite facultăți
                </RadzenText>
            </RadzenStack>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private PagedResult<FacultyListDto> faculties = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = "";
    private string? selectedStatus;
    private int currentPage = 1;
    private int pageSize = 25;

    // Options
    private List<int> pageSizeOptions = new() { 10, 25, 50 };
    private List<StatusOption> statusOptions = new()
    {
        new StatusOption { Text = "Activ", Value = "true" },
        new StatusOption { Text = "Inactiv", Value = "false" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadFaculties();
    }

    private async Task LoadFaculties()
    {
        isLoading = true;
        StateHasChanged();

        var filter = new FacultyFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        faculties = await FacultyService.GetAllAsync(filter, currentPage, pageSize);

        isLoading = false;
        StateHasChanged();
    }

    private System.Threading.Timer? searchTimer;

    private void HandleSearchKeyUp()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () => await LoadFaculties());
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadFaculties();
    }

    private async Task NextPage()
    {
        if (faculties.HasNextPage)
        {
            currentPage++;
            await LoadFaculties();
        }
    }

    private async Task PreviousPage()
    {
        if (faculties.HasPreviousPage)
        {
            currentPage--;
            await LoadFaculties();
        }
    }

    private async Task ConfirmDelete(Guid id)
    {
        var confirmed = await DialogService.Confirm(
            "Ești sigur că vrei să ștergi această facultate? Statusul va fi schimbat în \"Inactiv\".",
            "Confirmare Ștergere",
            new ConfirmOptions { OkButtonText = "Șterge", CancelButtonText = "Anulează" });

        if (confirmed == true)
        {
            var result = await FacultyService.DeleteAsync(id);
            if (result.Succeeded)
            {
                await LoadFaculties();
            }
        }
    }

    private async Task ExportToCSV()
    {
        var filter = new FacultyFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        var allFaculties = await FacultyService.ExportAsync(filter);

        var csv = "Nume,Cod,Decan,Programe,Studenți,Status\n";
        foreach (var faculty in allFaculties)
        {
            csv += $"{faculty.Name},{faculty.Code},{faculty.DeanName ?? "Neasignat"},{faculty.ProgramsCount},{faculty.StudentsCount},{(faculty.IsActive ? "Activ" : "Inactiv")}\n";
        }

        Console.WriteLine($"CSV Export: {allFaculties.Count} facultăți");
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }

    private class StatusOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
