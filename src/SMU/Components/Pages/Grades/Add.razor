@page "/note/adauga"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Policy = "CanManageGrades")]
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject IGradeService GradeService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService

<PageTitle>Adaugă Notă - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 64rem; margin: 0 auto;">
    <!-- Page Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Adaugă Notă</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Introdu notele pentru studenți</RadzenText>
        </RadzenStack>
        <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text" Click="NavigateBack" />
    </RadzenStack>

    <!-- Mode Selector -->
    <RadzenCard>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem">
            <RadzenButton Text="Notă Individuală" Icon="person"
                          ButtonStyle="@(!IsBulkMode ? ButtonStyle.Primary : ButtonStyle.Light)"
                          Click="@(() => IsBulkMode = false)" />
            <RadzenButton Text="Note în Bulk" Icon="groups"
                          ButtonStyle="@(IsBulkMode ? ButtonStyle.Primary : ButtonStyle.Light)"
                          Click="@(() => IsBulkMode = true)" />
        </RadzenStack>
    </RadzenCard>

    @if (ErrorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" AllowClose="true" Close="@(() => ErrorMessage = null)">
            @ErrorMessage
        </RadzenAlert>
    }

    @if (SuccessMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" AllowClose="true" Close="@(() => SuccessMessage = null)">
            @SuccessMessage
        </RadzenAlert>
    }

    <!-- Single Grade Form -->
    @if (!IsBulkMode)
    {
        <RadzenCard>
            <RadzenTemplateForm TItem="CreateGradeDto" Data="@SingleGrade" Submit="@HandleSingleSubmit">
                <RadzenStack Gap="1rem">
                    <!-- Course Selection -->
                    <RadzenFormField Text="Curs" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="SelectedCourseId" Data="@ProfessorCourses"
                                            TextProperty="Name" ValueProperty="Id"
                                            Placeholder="Selectează cursul..."
                                            Change="@OnCourseChange" Style="width: 100%;">
                                <Template Context="course">
                                    @course.Name (@course.Code)
                                </Template>
                            </RadzenDropDown>
                        </ChildContent>
                    </RadzenFormField>

                    <!-- Student Selection -->
                    <RadzenFormField Text="Student" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="SingleGrade.StudentId" Data="@CourseStudents"
                                            TextProperty="FullName" ValueProperty="Id"
                                            Placeholder="Selectează studentul..."
                                            Disabled="@(!SelectedCourseId.HasValue)"
                                            Style="width: 100%;">
                                <Template Context="student">
                                    @student.FullName (@student.StudentNumber)
                                </Template>
                            </RadzenDropDown>
                        </ChildContent>
                    </RadzenFormField>

                    <RadzenRow Gap="1rem" RowGap="1rem">
                        <!-- Grade Value -->
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Nota (1-10)" Variant="Variant.Outlined">
                                <RadzenNumeric @bind-Value="SingleGrade.Value" Min="1" Max="10" Step="0.01m" ShowUpDown="false" Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>

                        <!-- Grade Type -->
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Tip" Variant="Variant.Outlined">
                                <RadzenDropDown TValue="GradeType" @bind-Value="SingleGrade.Type" Data="@gradeTypeOptions" Style="width: 100%;">
                                    <Template Context="type">
                                        @GetGradeTypeText(type)
                                    </Template>
                                </RadzenDropDown>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Exam Date -->
                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="Data Examenului" />
                        <RadzenDatePicker @bind-Value="SingleGrade.ExamDate" DateFormat="dd.MM.yyyy" Style="width: 100%;" />
                    </RadzenStack>

                    <!-- Notes -->
                    <RadzenFormField Text="Observații" Variant="Variant.Outlined">
                        <RadzenTextArea @bind-Value="SingleGrade.Notes" Rows="3" Style="width: 100%;" />
                    </RadzenFormField>

                    <!-- Submit Button -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.75rem">
                        <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Light" Click="NavigateBack" />
                        <RadzenButton Text="Salvează Nota" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenCard>
    }
    else
    {
        <!-- Bulk Grades Form -->
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <!-- Course Selection -->
                <RadzenFormField Text="Curs" Variant="Variant.Outlined">
                    <RadzenDropDown @bind-Value="BulkCourseId" Data="@ProfessorCourses"
                                    TextProperty="Name" ValueProperty="Id"
                                    Placeholder="Selectează cursul..."
                                    Change="@OnBulkCourseChange" Style="width: 100%;">
                        <Template Context="course">
                            @course.Name (@course.Code)
                        </Template>
                    </RadzenDropDown>
                </RadzenFormField>

                <RadzenRow Gap="1rem" RowGap="1rem">
                    <!-- Grade Type -->
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Tip Notă" Variant="Variant.Outlined">
                            <RadzenDropDown TValue="GradeType" @bind-Value="BulkGradeType" Data="@gradeTypeOptions" Style="width: 100%;">
                                <Template Context="type">
                                    @GetGradeTypeText(type)
                                </Template>
                            </RadzenDropDown>
                        </RadzenFormField>
                    </RadzenColumn>

                    <!-- Exam Date -->
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Data Examenului" />
                            <RadzenDatePicker @bind-Value="BulkExamDate" DateFormat="dd.MM.yyyy" Style="width: 100%;" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Students Table -->
                @if (BulkCourseId.HasValue)
                {
                    <div style="margin-top: 1.5rem;">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0;">Studenți</RadzenText>
                        <RadzenDataGrid Data="@BulkStudents" TItem="BulkStudentGradeDto"
                                        AllowSorting="true" AllowPaging="false">
                            <Columns>
                                <RadzenDataGridColumn TItem="BulkStudentGradeDto" Property="FullName" Title="Student" />
                                <RadzenDataGridColumn TItem="BulkStudentGradeDto" Property="StudentNumber" Title="Nr. Matricol" Width="140px" />
                                <RadzenDataGridColumn TItem="BulkStudentGradeDto" Property="GradeValue" Title="Notă (1-10)" Width="140px">
                                    <Template Context="student">
                                        <RadzenNumeric @bind-Value="student.GradeValue" Min="1" Max="10" Step="0.01m" ShowUpDown="false" Style="width: 100%;" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </div>

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.75rem" Style="margin-top: 1rem;">
                        <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Light" Click="NavigateBack" />
                        <RadzenButton Text="Salvează Toate Notele" ButtonStyle="ButtonStyle.Primary" Click="@HandleBulkSubmit" />
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private List<Course> ProfessorCourses = new();
    private List<StudentDto> CourseStudents = new();
    private List<BulkStudentGradeDto> BulkStudents = new();

    private CreateGradeDto SingleGrade = new() { Type = GradeType.Exam, ExamDate = DateOnly.FromDateTime(DateTime.Today) };
    private Guid? SelectedCourseId;

    private bool IsBulkMode = false;
    private Guid? BulkCourseId;
    private GradeType BulkGradeType = GradeType.Exam;
    private DateOnly BulkExamDate = DateOnly.FromDateTime(DateTime.Today);

    private string? ErrorMessage;
    private string? SuccessMessage;
    private Guid CurrentUserId;

    private GradeType[] gradeTypeOptions = Enum.GetValues<GradeType>();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            CurrentUserId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "");
            await LoadProfessorCourses();
        }
    }

    private async Task LoadProfessorCourses()
    {
        var professor = await DbContext.Professors.FirstOrDefaultAsync(p => p.UserId == CurrentUserId);
        if (professor != null)
        {
            ProfessorCourses = await DbContext.Courses
                .Where(c => c.ProfessorId == professor.Id && c.IsActive)
                .OrderBy(c => c.Name)
                .ToListAsync();
        }
    }

    private async Task OnCourseChange()
    {
        if (SelectedCourseId.HasValue)
        {
            SingleGrade.CourseId = SelectedCourseId.Value;
            await LoadCourseStudents(SelectedCourseId.Value);
        }
        else
        {
            CourseStudents.Clear();
        }
    }

    private async Task OnBulkCourseChange()
    {
        if (BulkCourseId.HasValue)
        {
            await LoadBulkStudents(BulkCourseId.Value);
        }
        else
        {
            BulkStudents.Clear();
        }
    }

    private async Task LoadCourseStudents(Guid courseId)
    {
        var course = await DbContext.Courses
            .Include(c => c.Program)
                .ThenInclude(p => p.Groups)
                    .ThenInclude(g => g.Students)
                        .ThenInclude(s => s.User)
            .FirstOrDefaultAsync(c => c.Id == courseId);

        if (course?.Program?.Groups != null)
        {
            CourseStudents = course.Program.Groups
                .Where(grp => grp.Year == course.Year)
                .SelectMany(grp => grp.Students)
                .Where(s => s.Status == StudentStatus.Active)
                .Select(s => new StudentDto
                {
                    Id = s.Id,
                    FullName = $"{s.User.FirstName} {s.User.LastName}",
                    StudentNumber = s.StudentNumber
                })
                .OrderBy(s => s.FullName)
                .ToList();
        }
        else
        {
            CourseStudents.Clear();
        }
    }

    private async Task LoadBulkStudents(Guid courseId)
    {
        var course = await DbContext.Courses
            .Include(c => c.Program)
                .ThenInclude(p => p.Groups)
                    .ThenInclude(g => g.Students)
                        .ThenInclude(s => s.User)
            .FirstOrDefaultAsync(c => c.Id == courseId);

        if (course?.Program?.Groups != null)
        {
            BulkStudents = course.Program.Groups
                .Where(grp => grp.Year == course.Year)
                .SelectMany(grp => grp.Students)
                .Where(s => s.Status == StudentStatus.Active)
                .Select(s => new BulkStudentGradeDto
                {
                    StudentId = s.Id,
                    FullName = $"{s.User.FirstName} {s.User.LastName}",
                    StudentNumber = s.StudentNumber,
                    GradeValue = null
                })
                .OrderBy(s => s.FullName)
                .ToList();
        }
        else
        {
            BulkStudents.Clear();
        }
    }

    private async Task HandleSingleSubmit()
    {
        ErrorMessage = null;
        SuccessMessage = null;

        if (SingleGrade.StudentId == Guid.Empty || SingleGrade.CourseId == Guid.Empty)
        {
            ErrorMessage = "Vă rugăm să selectați cursul și studentul.";
            return;
        }

        var result = await GradeService.CreateAsync(SingleGrade, CurrentUserId);

        if (result.Succeeded)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succes",
                Detail = "Nota a fost adăugată cu succes!",
                Duration = 4000
            });
            SingleGrade = new() { Type = GradeType.Exam, ExamDate = DateOnly.FromDateTime(DateTime.Today) };
            SelectedCourseId = null;
            CourseStudents.Clear();
            StateHasChanged();
        }
        else
        {
            ErrorMessage = result.ErrorMessage;
        }
    }

    private async Task HandleBulkSubmit()
    {
        ErrorMessage = null;
        SuccessMessage = null;

        var gradesToCreate = BulkStudents
            .Where(s => s.GradeValue.HasValue && s.GradeValue >= 1 && s.GradeValue <= 10)
            .Select(s => new CreateGradeDto
            {
                StudentId = s.StudentId,
                CourseId = BulkCourseId!.Value,
                Value = s.GradeValue!.Value,
                Type = BulkGradeType,
                ExamDate = BulkExamDate,
                Notes = null
            })
            .ToList();

        if (gradesToCreate.Count == 0)
        {
            ErrorMessage = "Nu există note valide de adăugat.";
            return;
        }

        var result = await GradeService.BulkCreateAsync(gradesToCreate, CurrentUserId);

        if (result.Succeeded)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succes",
                Detail = $"{gradesToCreate.Count} note au fost adăugate cu succes!",
                Duration = 4000
            });
            BulkCourseId = null;
            BulkStudents.Clear();
            StateHasChanged();
        }
        else
        {
            ErrorMessage = result.ErrorMessage;
        }
    }

    private string GetGradeTypeText(GradeType type)
    {
        return type switch
        {
            GradeType.Exam => "Examen",
            GradeType.Lab => "Laborator",
            GradeType.Seminar => "Seminar",
            GradeType.Project => "Proiect",
            GradeType.Final => "Final",
            _ => type.ToString()
        };
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/note");
    }

    private class StudentDto
    {
        public Guid Id { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string StudentNumber { get; set; } = string.Empty;
    }

    private class BulkStudentGradeDto
    {
        public Guid StudentId { get; set; }
        public string FullName { get; set; } = string.Empty;
        public string StudentNumber { get; set; } = string.Empty;
        public decimal? GradeValue { get; set; }
    }
}
