@page "/note/aprobare"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Policy = "CanApproveGrades")]
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject IGradeService GradeService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject Radzen.DialogService DialogService

<PageTitle>Aprobare Note - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Page Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Aprobare Note</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Aprobă sau respinge notele în așteptare</RadzenText>
        </RadzenStack>
        <RadzenButton Icon="close"
                      ButtonStyle="ButtonStyle.Light"
                      Variant="Variant.Text"
                      Click="@(() => Navigation.NavigateTo("/note"))" />
    </RadzenStack>

    @if (ErrorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Small">
            @ErrorMessage
        </RadzenAlert>
    }

    @if (SuccessMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Small">
            @SuccessMessage
        </RadzenAlert>
    }

    <!-- Stats Cards -->
    <RadzenRow Gap="1.5rem" RowGap="1.5rem">
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard Style="padding: 1.5rem;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-warning-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                        <RadzenIcon Icon="schedule" Style="font-size: 1.5rem; color: var(--rz-warning);" />
                    </div>
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">În Așteptare</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">@PendingGrades.Count</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard Style="padding: 1.5rem;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-success-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                        <RadzenIcon Icon="check_circle" Style="font-size: 1.5rem; color: var(--rz-success);" />
                    </div>
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Aprobate Astăzi</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">@ApprovedToday</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard Style="padding: 1.5rem;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-danger-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                        <RadzenIcon Icon="cancel" Style="font-size: 1.5rem; color: var(--rz-danger);" />
                    </div>
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Respinse Astăzi</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">@RejectedToday</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Pending Grades Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--rz-border-color);">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Note în Așteptare</RadzenText>
                @if (SelectedGrades.Count > 0)
                {
                    <RadzenButton Text="@($"Aprobă Selectate ({SelectedGrades.Count})")"
                                  ButtonStyle="ButtonStyle.Success"
                                  Click="@BulkApprove" />
                }
            </RadzenStack>
        </div>

        @if (IsLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Se încarcă...</RadzenText>
            </RadzenStack>
        }
        else if (PendingGrades.Count == 0)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenIcon Icon="check_circle_outline" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: var(--rz-text-secondary-color);">
                    Nu există note în așteptare pentru aprobare.
                </RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenDataGrid Data="@PendingGrades" TItem="GradeListDto" Style="border: none;">
                <Columns>
                    <RadzenDataGridColumn TItem="GradeListDto" Width="50px" Sortable="false">
                        <HeaderTemplate>
                            <RadzenCheckBox TValue="bool" Value="@(SelectedGrades.Count == PendingGrades.Count && PendingGrades.Count > 0)"
                                            Change="@ToggleSelectAll" />
                        </HeaderTemplate>
                        <Template Context="grade">
                            <RadzenCheckBox TValue="bool" Value="@SelectedGrades.Contains(grade.Id)"
                                            Change="@(() => ToggleGradeSelection(grade.Id))" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Property="StudentName" Title="Student">
                        <Template Context="grade">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@grade.StudentName</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Property="CourseName" Title="Curs">
                        <Template Context="grade">
                            <RadzenStack Gap="0.125rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@grade.CourseName</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@grade.Credits credite</RadzenText>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Property="Value" Title="Nota" Width="100px">
                        <Template Context="grade">
                            <RadzenBadge BadgeStyle="@GetGradeBadgeStyle(grade.Value)"
                                         Text="@grade.Value.ToString("0.00")"
                                         IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Property="Type" Title="Tip" Width="100px">
                        <Template Context="grade">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@GetGradeTypeLabel(grade.Type)</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Property="EnteredByName" Title="Profesor">
                        <Template Context="grade">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@grade.EnteredByName</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Property="ExamDate" Title="Data" Width="110px">
                        <Template Context="grade">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@grade.ExamDate.ToString("dd.MM.yyyy")</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GradeListDto" Title="Acțiuni" Width="100px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="grade">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" JustifyContent="JustifyContent.End">
                                <RadzenButton Icon="check"
                                              ButtonStyle="ButtonStyle.Success"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => ApproveGrade(grade.Id))"
                                              title="Aprobă" />
                                <RadzenButton Icon="close"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => ShowRejectModal(grade.Id))"
                                              title="Respinge" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private List<GradeListDto> PendingGrades = new();
    private HashSet<Guid> SelectedGrades = new();
    private bool IsLoading = true;
    private Guid CurrentUserId;
    private Guid? FacultyId;

    private int ApprovedToday = 0;
    private int RejectedToday = 0;

    private string? ErrorMessage;
    private string? SuccessMessage;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            CurrentUserId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "");
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        IsLoading = true;
        StateHasChanged();

        // Get dean's faculty
        var professor = await DbContext.Professors
            .Include(p => p.Faculty)
            .FirstOrDefaultAsync(p => p.UserId == CurrentUserId);

        FacultyId = professor?.FacultyId;

        // Load pending grades
        PendingGrades = await GradeService.GetPendingForApprovalAsync(FacultyId);

        // Count today's approvals/rejections
        var today = DateTime.UtcNow.Date;
        ApprovedToday = await DbContext.Grades
            .Where(g => g.Status == GradeStatus.Approved && g.UpdatedAt.Date == today)
            .CountAsync();

        RejectedToday = await DbContext.Grades
            .Where(g => g.Status == GradeStatus.Rejected && g.UpdatedAt.Date == today)
            .CountAsync();

        IsLoading = false;
        StateHasChanged();
    }

    private void ToggleSelectAll(bool value)
    {
        if (value)
        {
            SelectedGrades = PendingGrades.Select(g => g.Id).ToHashSet();
        }
        else
        {
            SelectedGrades.Clear();
        }
    }

    private void ToggleGradeSelection(Guid gradeId)
    {
        if (SelectedGrades.Contains(gradeId))
        {
            SelectedGrades.Remove(gradeId);
        }
        else
        {
            SelectedGrades.Add(gradeId);
        }
    }

    private async Task ApproveGrade(Guid gradeId)
    {
        ErrorMessage = null;
        SuccessMessage = null;

        var result = await GradeService.ApproveAsync(gradeId, CurrentUserId);

        if (result.Succeeded)
        {
            SuccessMessage = "Nota a fost aprobată cu succes!";
            await LoadData();
            SelectedGrades.Clear();
        }
        else
        {
            ErrorMessage = result.ErrorMessage;
        }
    }

    private async Task BulkApprove()
    {
        ErrorMessage = null;
        SuccessMessage = null;

        int successCount = 0;
        int failCount = 0;

        foreach (var gradeId in SelectedGrades)
        {
            var result = await GradeService.ApproveAsync(gradeId, CurrentUserId);
            if (result.Succeeded)
                successCount++;
            else
                failCount++;
        }

        if (successCount > 0)
        {
            SuccessMessage = $"{successCount} note au fost aprobate cu succes!";
        }

        if (failCount > 0)
        {
            ErrorMessage = $"{failCount} note nu au putut fi aprobate.";
        }

        await LoadData();
        SelectedGrades.Clear();
    }

    private async Task ShowRejectModal(Guid gradeId)
    {
        var reason = await DialogService.OpenAsync<RejectGradeDialog>("Respinge Nota",
            new Dictionary<string, object>(),
            new DialogOptions { Width = "450px", Height = "auto" });

        if (!string.IsNullOrWhiteSpace(reason as string))
        {
            ErrorMessage = null;
            SuccessMessage = null;

            var result = await GradeService.RejectAsync(gradeId, CurrentUserId, reason as string);

            if (result.Succeeded)
            {
                SuccessMessage = "Nota a fost respinsă.";
                await LoadData();
            }
            else
            {
                ErrorMessage = result.ErrorMessage;
            }
        }
    }

    private BadgeStyle GetGradeBadgeStyle(decimal value) => value switch
    {
        >= 9 => BadgeStyle.Success,
        >= 7 => BadgeStyle.Info,
        >= 5 => BadgeStyle.Warning,
        _ => BadgeStyle.Danger
    };

    private string GetGradeTypeLabel(GradeType type) => type switch
    {
        GradeType.Exam => "Examen",
        GradeType.Lab => "Laborator",
        GradeType.Seminar => "Seminar",
        GradeType.Project => "Proiect",
        GradeType.Final => "Final",
        _ => type.ToString()
    };
}
