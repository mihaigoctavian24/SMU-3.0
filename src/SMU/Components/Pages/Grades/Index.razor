@page "/note"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject IGradeService GradeService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Note - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Page Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">
                @if (CurrentRole == UserRole.Student)
                {
                    <text>Notele Mele</text>
                }
                else
                {
                    <text>Note</text>
                }
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                @if (CurrentRole == UserRole.Student)
                {
                    <text>Vizualizează toate notele tale</text>
                }
                else if (CurrentRole == UserRole.Professor)
                {
                    <text>Gestionează notele studenților</text>
                }
                else if (CurrentRole == UserRole.Secretary)
                {
                    <text>Gestionează și procesează notele studenților</text>
                }
                else if (CurrentRole == UserRole.Dean)
                {
                    <text>Aprobă notele în așteptare</text>
                }
            </RadzenText>
        </RadzenStack>

        @if (CurrentRole == UserRole.Professor || CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Admin)
        {
            <RadzenButton Text="Adaugă Notă" Icon="add" ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => Navigation.NavigateTo("/note/adauga"))" />
        }
        @if (CurrentRole == UserRole.Dean)
        {
            <RadzenButton Text="Pagină Aprobare" Icon="check_circle" ButtonStyle="ButtonStyle.Success"
                          Click="@(() => Navigation.NavigateTo("/note/aprobare"))" />
        }
    </RadzenStack>

    <!-- Statistics Panel (for Secretary/Dean) -->
    @if ((CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean) && GradeStats != null)
    {
        <GradeStatistics Statistics="@GradeStats" />
    }

    <!-- Filters (for Professor/Secretary/Dean) -->
    @if (CurrentRole == UserRole.Professor || CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean)
    {
        <RadzenCard>
            <RadzenRow Gap="1rem" RowGap="1rem">
                @if (CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean)
                {
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Student" Variant="Variant.Outlined" Style="width: 100%;">
                            <RadzenDropDown @bind-Value="SelectedStudentId" Data="@StudentOptions" TextProperty="Text" ValueProperty="Value"
                                            Placeholder="Toți studenții" Style="width: 100%;" AllowClear="true" AllowFiltering="true" />
                        </RadzenFormField>
                    </RadzenColumn>
                }

                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Curs" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="SelectedCourseId" Data="@CourseOptions" TextProperty="Text" ValueProperty="Value"
                                        Placeholder="Toate cursurile" Style="width: 100%;" AllowClear="true" AllowFiltering="true" />
                    </RadzenFormField>
                </RadzenColumn>

                @if (CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean)
                {
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Profesor" Variant="Variant.Outlined" Style="width: 100%;">
                            <RadzenDropDown @bind-Value="SelectedProfessorId" Data="@ProfessorOptions" TextProperty="Text" ValueProperty="Value"
                                            Placeholder="Toți profesorii" Style="width: 100%;" AllowClear="true" AllowFiltering="true" />
                        </RadzenFormField>
                    </RadzenColumn>
                }

                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Tip Notă" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="SelectedGradeType" Data="@GradeTypeOptions" TextProperty="Text" ValueProperty="Value"
                                        Placeholder="Toate tipurile" Style="width: 100%;" AllowClear="true" />
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Semestru" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="SelectedSemester" Data="@SemesterOptions" TextProperty="Text" ValueProperty="Value"
                                        Style="width: 100%;" AllowClear="true" />
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="SelectedStatus" Data="@StatusOptions" TextProperty="Text" ValueProperty="Value"
                                        Placeholder="Toate statusurile" Style="width: 100%;" AllowClear="true" />
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenStack Style="height: 100%;" JustifyContent="JustifyContent.End" Gap="0.5rem">
                        <RadzenButton Text="Aplică Filtre" Icon="filter_list" ButtonStyle="ButtonStyle.Primary"
                                      Click="@ApplyFilters" Style="width: 100%;" />
                        <RadzenButton Text="Resetează" Icon="clear" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined"
                                      Click="@ResetFilters" Style="width: 100%;" />
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    }

    <!-- Grades Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (IsLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                    Se încarcă...
                </RadzenText>
            </RadzenStack>
        }
        else if (FilteredGrades.Count == 0)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="1rem">
                <RadzenIcon Icon="assignment" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
                    Nu există note înregistrate.
                </RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenDataGrid @ref="grid" Data="@FilteredGrades" TItem="GradeListDto"
                            AllowSorting="true" AllowPaging="false"
                            Style="border: none;">
                <Columns>
                    @if (CurrentRole != UserRole.Student)
                    {
                        <RadzenDataGridColumn TItem="GradeListDto" Property="StudentName" Title="Student" Sortable="true">
                            <Template Context="grade">
                                <RadzenStack Gap="0.125rem">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@grade.StudentName</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                        @grade.StudentNumber
                                    </RadzenText>
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    }
                    <RadzenDataGridColumn TItem="GradeListDto" Property="CourseName" Title="Curs" Sortable="true">
                        <Template Context="grade">
                            <RadzenStack Gap="0.125rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@grade.CourseName</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                    @grade.Credits credite • Sem. @grade.Semester
                                </RadzenText>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                    @if (CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean)
                    {
                        <RadzenDataGridColumn TItem="GradeListDto" Property="ProfessorName" Title="Profesor" Sortable="true">
                            <Template Context="grade">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@grade.ProfessorName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                    }
                    <RadzenDataGridColumn TItem="GradeListDto" Property="Value" Title="Nota" Width="100px" Sortable="true">
                        <Template Context="grade">
                            <RadzenBadge BadgeStyle="@GetGradeBadgeStyle(grade.Value)" Text="@grade.Value.ToString("0.00")" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="GradeListDto" Property="Type" Title="Tip" Width="120px" Sortable="true">
                        <Template Context="grade">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@GetGradeTypeLabel(grade.Type)</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="GradeListDto" Property="ExamDate" Title="Data" Width="120px" Sortable="true">
                        <Template Context="grade">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                @grade.ExamDate.ToString("dd.MM.yyyy")
                            </RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="GradeListDto" Property="Status" Title="Status" Width="130px" Sortable="true">
                        <Template Context="grade">
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(grade.Status)" Text="@GetStatusLabel(grade.Status)" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    @if (CurrentRole == UserRole.Professor || CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean)
                    {
                        <RadzenDataGridColumn TItem="GradeListDto" Title="Acțiuni" Width="140px" TextAlign="TextAlign.End" Sortable="false">
                            <Template Context="grade">
                                @if (grade.Status == GradeStatus.Pending && (CurrentRole == UserRole.Professor || CurrentRole == UserRole.Secretary))
                                {
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => ConfirmDeleteGrade(grade.Id))"
                                                  MouseEnter="@(args => ShowTooltip(args, "Șterge"))" />
                                }
                                @if (grade.Status == GradeStatus.Pending && CurrentRole == UserRole.Dean)
                                {
                                    <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => ApproveGrade(grade.Id))"
                                                  MouseEnter="@(args => ShowTooltip(args, "Aprobă"))" />
                                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => RejectGrade(grade.Id))"
                                                  MouseEnter="@(args => ShowTooltip(args, "Respinge"))" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    }
                </Columns>
            </RadzenDataGrid>

            <!-- Average Display (Student View) -->
            @if (CurrentRole == UserRole.Student && StudentAverage != null)
            {
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                             Class="rz-p-4" Style="border-top: 1px solid var(--rz-base-300); background: var(--rz-base-100);">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">
                            Media Generală (ponderată cu credite)
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                            @StudentAverage.TotalCredits credite acumulate • @StudentAverage.CompletedCourses cursuri finalizate
                        </RadzenText>
                    </RadzenStack>
                    <RadzenBadge BadgeStyle="@GetGradeBadgeStyle(StudentAverage.WeightedAverage)"
                                Text="@StudentAverage.WeightedAverage.ToString("0.00")"
                                IsPill="true" Style="font-size: 1.25rem; padding: 0.5rem 1rem;" />
                </RadzenStack>
            }
        }
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenDataGrid<GradeListDto>? grid;
    private List<GradeListDto> Grades = new();
    private List<GradeListDto> FilteredGrades = new();
    private List<Course> Courses = new();
    private StudentAverageDto? StudentAverage;
    private GradeStatisticsDto? GradeStats;
    private bool IsLoading = true;
    private UserRole CurrentRole;
    private Guid CurrentUserId;

    // Filter options
    private List<DropdownOption<string?>> StudentOptions = new();
    private List<DropdownOption<string?>> CourseOptions = new();
    private List<DropdownOption<string?>> ProfessorOptions = new();
    private List<DropdownOption<int>> SemesterOptions = new()
    {
        new() { Text = "Toate semestrele", Value = 0 },
        new() { Text = "Semestrul 1", Value = 1 },
        new() { Text = "Semestrul 2", Value = 2 }
    };
    private List<DropdownOption<string?>> StatusOptions = new()
    {
        new() { Text = "Toate statusurile", Value = null },
        new() { Text = "În așteptare", Value = "Pending" },
        new() { Text = "Aprobat", Value = "Approved" },
        new() { Text = "Respins", Value = "Rejected" }
    };
    private List<DropdownOption<string?>> GradeTypeOptions = new()
    {
        new() { Text = "Toate tipurile", Value = null },
        new() { Text = "Examen", Value = "Exam" },
        new() { Text = "Laborator", Value = "Lab" },
        new() { Text = "Seminar", Value = "Seminar" },
        new() { Text = "Proiect", Value = "Project" },
        new() { Text = "Final", Value = "Final" }
    };

    // Helper class for typed dropdown options
    private class DropdownOption<T>
    {
        public string Text { get; set; } = string.Empty;
        public T? Value { get; set; }
    }

    // Filters
    private string? SelectedStudentId;
    private string? SelectedCourseId;
    private string? SelectedProfessorId;
    private string? SelectedGradeType;
    private int SelectedSemester = 0;
    private string? SelectedStatus;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "");
            var roleClaim = user.FindFirst("Role")?.Value;

            CurrentUserId = userId;
            CurrentRole = Enum.Parse<UserRole>(roleClaim ?? "Student");

            await LoadData();
        }
    }

    private async Task LoadData()
    {
        IsLoading = true;

        if (CurrentRole == UserRole.Student)
        {
            var student = await DbContext.Students.FirstOrDefaultAsync(s => s.UserId == CurrentUserId);
            if (student != null)
            {
                Grades = await GradeService.GetByStudentAsync(student.Id);
                StudentAverage = await GradeService.GetStudentAverageAsync(student.Id);
            }
        }
        else if (CurrentRole == UserRole.Professor)
        {
            var professor = await DbContext.Professors.FirstOrDefaultAsync(p => p.UserId == CurrentUserId);
            if (professor != null)
            {
                Courses = await DbContext.Courses
                    .Where(c => c.ProfessorId == professor.Id)
                    .OrderBy(c => c.Name)
                    .ToListAsync();

                // Build course options for dropdown
                CourseOptions = new List<DropdownOption<string?>> { new() { Text = "Toate cursurile", Value = null } };
                CourseOptions.AddRange(Courses.Select(c => new DropdownOption<string?> { Text = c.Name, Value = c.Id.ToString() }));

                // Load all grades for professor's courses
                var professorCourseIds = Courses.Select(c => c.Id).ToList();
                Grades = await DbContext.Grades
                    .Where(g => professorCourseIds.Contains(g.CourseId))
                    .Include(g => g.Student)
                        .ThenInclude(s => s.User)
                    .Include(g => g.Course)
                        .ThenInclude(c => c.Professor)
                            .ThenInclude(p => p.User)
                    .Include(g => g.EnteredBy)
                    .OrderByDescending(g => g.ExamDate)
                    .Select(g => new GradeListDto
                    {
                        Id = g.Id,
                        StudentName = $"{g.Student.User.FirstName} {g.Student.User.LastName}",
                        StudentNumber = g.Student.StudentNumber,
                        CourseName = g.Course.Name,
                        ProfessorName = g.Course.Professor != null ? $"{g.Course.Professor.User.FirstName} {g.Course.Professor.User.LastName}" : "",
                        Value = g.Value,
                        Type = g.Type,
                        Status = g.Status,
                        ExamDate = g.ExamDate,
                        EnteredByName = g.EnteredBy != null ? $"{g.EnteredBy.FirstName} {g.EnteredBy.LastName}" : null,
                        Credits = g.Course.Credits,
                        Semester = g.Course.Semester
                    })
                    .ToListAsync();
            }
        }
        else if (CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean)
        {
            // Secretary and Dean's faculty - determine faculty ID
            Guid? facultyId = null;

            if (CurrentRole == UserRole.Dean)
            {
                var faculty = await DbContext.Faculties
                    .FirstOrDefaultAsync(f => f.DeanId == CurrentUserId);
                facultyId = faculty?.Id;
            }
            else if (CurrentRole == UserRole.Secretary)
            {
                // Secretaries have access to all faculties
                facultyId = null;
            }

            if (CurrentRole == UserRole.Secretary || facultyId != null)
            {
                // Use split query to avoid cartesian explosion
                var gradesQuery = DbContext.Grades
                    .Include(g => g.Student)
                        .ThenInclude(s => s.User)
                    .Include(g => g.Course)
                        .ThenInclude(c => c.Program)
                            .ThenInclude(p => p.Faculty)
                    .Include(g => g.Course)
                        .ThenInclude(c => c.Professor)
                            .ThenInclude(p => p.User)
                    .Include(g => g.EnteredBy)
                    .AsSplitQuery(); // Important: Use split query for complex includes

                // Filter by faculty if applicable (Dean only)
                if (facultyId.HasValue)
                {
                    gradesQuery = gradesQuery.Where(g => g.Course.Program.FacultyId == facultyId.Value);
                }

                // Load grades with split queries
                var gradeEntities = await gradesQuery
                    .OrderByDescending(g => g.Status == GradeStatus.Pending ? 0 : 1)
                    .ThenByDescending(g => g.ExamDate)
                    .ToListAsync();

                // Map to DTOs
                Grades = gradeEntities.Select(g => new GradeListDto
                {
                    Id = g.Id,
                    StudentName = $"{g.Student.User.FirstName} {g.Student.User.LastName}",
                    StudentNumber = g.Student.StudentNumber,
                    CourseName = g.Course.Name,
                    ProfessorName = g.Course.Professor != null ? $"{g.Course.Professor.User.FirstName} {g.Course.Professor.User.LastName}" : "",
                    Value = g.Value,
                    Type = g.Type,
                    Status = g.Status,
                    ExamDate = g.ExamDate,
                    EnteredByName = g.EnteredBy != null ? $"{g.EnteredBy.FirstName} {g.EnteredBy.LastName}" : null,
                    Credits = g.Course.Credits,
                    Semester = g.Course.Semester
                }).ToList();

                // Load courses with split query
                var coursesQuery = DbContext.Courses
                    .Include(c => c.Program)
                        .ThenInclude(p => p.Faculty)
                    .AsSplitQuery();

                if (facultyId.HasValue)
                {
                    coursesQuery = coursesQuery.Where(c => c.Program.FacultyId == facultyId.Value);
                }

                Courses = await coursesQuery
                    .OrderBy(c => c.Name)
                    .ToListAsync();

                // Build course options
                CourseOptions = new List<DropdownOption<string?>> { new() { Text = "Toate cursurile", Value = null } };
                CourseOptions.AddRange(Courses.Select(c => new DropdownOption<string?> { Text = c.Name, Value = c.Id.ToString() }));

                // Build student options
                var students = await DbContext.Students
                    .Include(s => s.User)
                    .Include(s => s.Group)
                        .ThenInclude(g => g.Program)
                    .Where(s => !facultyId.HasValue || s.Group.Program.FacultyId == facultyId.Value)
                    .OrderBy(s => s.User.LastName)
                    .ThenBy(s => s.User.FirstName)
                    .ToListAsync();

                StudentOptions = new List<DropdownOption<string?>> { new() { Text = "Toți studenții", Value = null } };
                StudentOptions.AddRange(students.Select(s => new DropdownOption<string?>
                {
                    Text = $"{s.User.FirstName} {s.User.LastName} ({s.StudentNumber})",
                    Value = s.Id.ToString()
                }));

                // Build professor options
                var professors = await DbContext.Professors
                    .Include(p => p.User)
                    .OrderBy(p => p.User.LastName)
                    .ThenBy(p => p.User.FirstName)
                    .ToListAsync();

                ProfessorOptions = new List<DropdownOption<string?>> { new() { Text = "Toți profesorii", Value = null } };
                ProfessorOptions.AddRange(professors.Select(p => new DropdownOption<string?>
                {
                    Text = $"{p.User.FirstName} {p.User.LastName}",
                    Value = p.Id.ToString()
                }));

                // Load statistics
                GradeStats = await GradeService.GetStatisticsAsync(facultyId);
            }
        }

        FilteredGrades = Grades;
        IsLoading = false;
    }

    private void ApplyFilters()
    {
        FilteredGrades = Grades;

        if (!string.IsNullOrEmpty(SelectedStudentId))
        {
            var studentId = Guid.Parse(SelectedStudentId);
            FilteredGrades = FilteredGrades.Where(g => g.StudentName == Grades.First(gr => gr.Id == studentId || gr.StudentName.Contains(SelectedStudentId)).StudentName).ToList();
        }

        if (!string.IsNullOrEmpty(SelectedCourseId))
        {
            var courseId = Guid.Parse(SelectedCourseId);
            FilteredGrades = FilteredGrades.Where(g => g.CourseName == Courses.First(c => c.Id == courseId).Name).ToList();
        }

        if (!string.IsNullOrEmpty(SelectedProfessorId))
        {
            var professorId = Guid.Parse(SelectedProfessorId);
            var professor = DbContext.Professors.Include(p => p.User).FirstOrDefault(p => p.Id == professorId);
            if (professor != null)
            {
                var profName = $"{professor.User.FirstName} {professor.User.LastName}";
                FilteredGrades = FilteredGrades.Where(g => g.ProfessorName == profName).ToList();
            }
        }

        if (!string.IsNullOrEmpty(SelectedGradeType))
        {
            var gradeType = Enum.Parse<GradeType>(SelectedGradeType);
            FilteredGrades = FilteredGrades.Where(g => g.Type == gradeType).ToList();
        }

        if (SelectedSemester > 0)
        {
            FilteredGrades = FilteredGrades.Where(g => g.Semester == SelectedSemester).ToList();
        }

        if (!string.IsNullOrEmpty(SelectedStatus))
        {
            var status = Enum.Parse<GradeStatus>(SelectedStatus);
            FilteredGrades = FilteredGrades.Where(g => g.Status == status).ToList();
        }
    }

    private void ResetFilters()
    {
        SelectedStudentId = null;
        SelectedCourseId = null;
        SelectedProfessorId = null;
        SelectedGradeType = null;
        SelectedSemester = 0;
        SelectedStatus = null;
        FilteredGrades = Grades;
    }

    private async Task ConfirmDeleteGrade(Guid gradeId)
    {
        var result = await DialogService.Confirm(
            "Sigur doriți să ștergeți această notă?",
            "Confirmare Ștergere",
            new ConfirmOptions
            {
                OkButtonText = "Șterge",
                CancelButtonText = "Anulează"
            });

        if (result == true)
        {
            var deleteResult = await GradeService.DeleteAsync(gradeId);
            if (deleteResult.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Nota a fost ștearsă cu succes.",
                    Duration = 4000
                });
                await LoadData();
            }
            else
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = deleteResult.ErrorMessage ?? "Nu s-a putut șterge nota.",
                    Duration = 4000
                });
            }
        }
    }

    private async Task ApproveGrade(Guid gradeId)
    {
        var result = await GradeService.ApproveAsync(gradeId, CurrentUserId);
        if (result.Succeeded)
        {
            RadzenNotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succes",
                Detail = "Nota a fost aprobată cu succes.",
                Duration = 4000
            });
            await LoadData();
        }
        else
        {
            RadzenNotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Eroare",
                Detail = result.ErrorMessage ?? "Nu s-a putut aproba nota.",
                Duration = 4000
            });
        }
    }

    private async Task RejectGrade(Guid gradeId)
    {
        var confirmed = await DialogService.Confirm(
            "Sigur doriți să respingeți această notă?",
            "Confirmare Respingere",
            new ConfirmOptions
            {
                OkButtonText = "Respinge",
                CancelButtonText = "Anulează"
            });

        if (confirmed == true)
        {
            var result = await GradeService.RejectAsync(gradeId, CurrentUserId, "Respinsă de decan");
            if (result.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Notă Respinsă",
                    Detail = "Nota a fost respinsă.",
                    Duration = 4000
                });
                await LoadData();
            }
            else
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = result.ErrorMessage ?? "Nu s-a putut respinge nota.",
                    Duration = 4000
                });
            }
        }
    }

    private void ShowTooltip(ElementReference elementReference, string text)
    {
        // Tooltip functionality - could be enhanced
    }

    private BadgeStyle GetGradeBadgeStyle(decimal value) => value switch
    {
        >= 9 => BadgeStyle.Success,
        >= 7 => BadgeStyle.Info,
        >= 5 => BadgeStyle.Warning,
        _ => BadgeStyle.Danger
    };

    private BadgeStyle GetStatusBadgeStyle(GradeStatus status) => status switch
    {
        GradeStatus.Pending => BadgeStyle.Warning,
        GradeStatus.Approved => BadgeStyle.Success,
        GradeStatus.Rejected => BadgeStyle.Danger,
        _ => BadgeStyle.Light
    };

    private string GetStatusLabel(GradeStatus status) => status switch
    {
        GradeStatus.Pending => "În așteptare",
        GradeStatus.Approved => "Aprobat",
        GradeStatus.Rejected => "Respins",
        _ => status.ToString()
    };

    private string GetGradeTypeLabel(GradeType type) => type switch
    {
        GradeType.Exam => "Examen",
        GradeType.Lab => "Laborator",
        GradeType.Seminar => "Seminar",
        GradeType.Project => "Proiect",
        GradeType.Final => "Final",
        _ => type.ToString()
    };
}
