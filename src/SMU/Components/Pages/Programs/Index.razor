@page "/programe"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManagePrograms")]
@inject IProgramService ProgramService
@inject IFacultyService FacultyService
@inject NavigationManager Navigation
@inject Radzen.DialogService DialogService

<PageTitle>Programe de Studiu - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Programe de Studiu</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Gestionează programele de studiu din universitate</RadzenText>
        </RadzenStack>
        <RadzenButton Text="Adaugă Program"
                      Icon="add"
                      ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/programe/nou"))" />
    </RadzenStack>

    <!-- Filters & Search -->
    <RadzenCard Style="padding: 1.5rem;">
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenFormField Text="Căutare" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="searchTerm"
                                   Placeholder="Nume sau cod program..."
                                   @oninput="HandleSearchKeyUp" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Faculty Filter -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenFormField Text="Facultate" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedFacultyId"
                                    Data="@faculties"
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    AllowClear="true"
                                    Placeholder="Toate facultățile"
                                    Change="@(args => ApplyFilters())"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Status Filter -->
            <RadzenColumn Size="12" SizeMD="2">
                <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedStatus"
                                    Data="@statusOptions"
                                    TextProperty="Text"
                                    ValueProperty="Value"
                                    AllowClear="true"
                                    Placeholder="Toate"
                                    Change="@(args => ApplyFilters())"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Export -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenStack JustifyContent="JustifyContent.End" Style="height: 100%;">
                    <RadzenButton Text="Export CSV"
                                  Icon="download"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@ExportToCSV"
                                  Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Programs Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenStack>
        }
        else if (programs.Items.Any())
        {
            <RadzenDataGrid Data="@programs.Items" TItem="StudyProgramListDto" AllowSorting="true" Style="border: none;">
                <Columns>
                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="Name" Title="Nume" Sortable="true">
                        <Template Context="program">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@program.Name</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="Code" Title="Cod" Width="100px">
                        <Template Context="program">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-family: monospace;">@program.Code</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="FacultyName" Title="Facultate" />

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="DurationYears" Title="Durată" Width="100px">
                        <Template Context="program">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@program.DurationYears ani</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="Type" Title="Tip" Width="100px">
                        <Template Context="program">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@GetProgramTypeText(program.Type)</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="GroupsCount" Title="Grupe" Width="80px" TextAlign="TextAlign.Center">
                        <Template Context="program">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@program.GroupsCount</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Property="IsActive" Title="Status" Width="100px">
                        <Template Context="program">
                            <RadzenBadge BadgeStyle="@(program.IsActive ? BadgeStyle.Success : BadgeStyle.Light)"
                                         Text="@(program.IsActive ? "Activ" : "Inactiv")"
                                         IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="StudyProgramListDto" Title="Acțiuni" Width="180px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="program">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                                <RadzenButton Icon="visibility"
                                              ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/programe/{program.Id}"))"
                                              title="Vezi" />
                                <RadzenButton Icon="edit"
                                              ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/programe/{program.Id}/editare"))"
                                              title="Editează" />
                                <RadzenButton Icon="delete"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => ConfirmDelete(program.Id))"
                                              title="Șterge" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <!-- Pagination -->
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--rz-border-color);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Afișează</RadzenText>
                        <RadzenDropDown @bind-Value="pageSize"
                                        Data="@pageSizeOptions"
                                        Change="@(args => ApplyFilters())"
                                        Style="width: 80px;" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">din @programs.TotalCount programe</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenButton Text="Anterior"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@PreviousPage"
                                      Disabled="@(!programs.HasPreviousPage)" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Pagina @programs.Page din @programs.TotalPages
                        </RadzenText>
                        <RadzenButton Text="Următorul"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@NextPage"
                                      Disabled="@(!programs.HasNextPage)" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        }
        else
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenIcon Icon="menu_book" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: var(--rz-text-secondary-color);">
                    Nu au fost găsite programe de studiu
                </RadzenText>
            </RadzenStack>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private PagedResult<StudyProgramListDto> programs = new();
    private List<FacultyListDto> faculties = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = "";
    private Guid? selectedFacultyId;
    private string? selectedStatus;
    private int currentPage = 1;
    private int pageSize = 25;

    // Options
    private List<int> pageSizeOptions = new() { 10, 25, 50 };
    private List<StatusOption> statusOptions = new()
    {
        new StatusOption { Text = "Activ", Value = "true" },
        new StatusOption { Text = "Inactiv", Value = "false" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadFacultiesForFilter();
        await LoadPrograms();
    }

    private async Task LoadFacultiesForFilter()
    {
        var facultiesResult = await FacultyService.GetAllAsync(new FacultyFilter { IsActive = true }, 1, 100);
        faculties = facultiesResult.Items;
    }

    private async Task LoadPrograms()
    {
        isLoading = true;
        StateHasChanged();

        var filter = new StudyProgramFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            FacultyId = selectedFacultyId,
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        programs = await ProgramService.GetAllAsync(filter, currentPage, pageSize);

        isLoading = false;
        StateHasChanged();
    }

    private System.Threading.Timer? searchTimer;

    private void HandleSearchKeyUp()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () => await LoadPrograms());
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadPrograms();
    }

    private async Task NextPage()
    {
        if (programs.HasNextPage)
        {
            currentPage++;
            await LoadPrograms();
        }
    }

    private async Task PreviousPage()
    {
        if (programs.HasPreviousPage)
        {
            currentPage--;
            await LoadPrograms();
        }
    }

    private async Task ConfirmDelete(Guid id)
    {
        var confirmed = await DialogService.Confirm(
            "Ești sigur că vrei să ștergi acest program de studiu? Statusul va fi schimbat în \"Inactiv\".",
            "Confirmare Ștergere",
            new ConfirmOptions { OkButtonText = "Șterge", CancelButtonText = "Anulează" });

        if (confirmed == true)
        {
            var result = await ProgramService.DeleteAsync(id);
            if (result.Succeeded)
            {
                await LoadPrograms();
            }
        }
    }

    private async Task ExportToCSV()
    {
        var filter = new StudyProgramFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            FacultyId = selectedFacultyId,
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        var allPrograms = await ProgramService.ExportAsync(filter);

        var csv = "Nume,Cod,Facultate,Durată,Tip,Grupe,Status\n";
        foreach (var program in allPrograms)
        {
            csv += $"{program.Name},{program.Code},{program.FacultyName},{program.DurationYears} ani,{GetProgramTypeText(program.Type)},{program.GroupsCount},{(program.IsActive ? "Activ" : "Inactiv")}\n";
        }

        Console.WriteLine($"CSV Export: {allPrograms.Count} programe");
    }

    private string GetProgramTypeText(ProgramType type) => type switch
    {
        ProgramType.Bachelor => "Licență",
        ProgramType.Master => "Master",
        ProgramType.PhD => "Doctorat",
        _ => type.ToString()
    };

    public void Dispose()
    {
        searchTimer?.Dispose();
    }

    private class StatusOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
