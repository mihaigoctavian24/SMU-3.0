@page "/admin/utilizatori/nou"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@using Microsoft.EntityFrameworkCore
@using SMU.Data
@attribute [Authorize(Policy = "CanManageUsers")]
@inject IUserService UserService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService

<PageTitle>Utilizator Nou - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 800px; margin: 0 auto;">
    <!-- Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
        <RadzenButton Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                      Click="@(() => Navigation.NavigateTo("/admin/utilizatori"))" />
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Utilizator Nou</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Creează un nou cont de utilizator
            </RadzenText>
        </RadzenStack>
    </RadzenStack>

    <!-- Form -->
    <RadzenCard Style="padding: 1.5rem;">
        <RadzenTemplateForm TItem="CreateUserDto" Data="@model" Submit="@HandleSubmit">
            <RadzenStack Gap="1.5rem">
                <!-- Email -->
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Email *</RadzenText>
                    <RadzenTextBox @bind-Value="model.Email" Placeholder="exemplu@smu.edu" Style="width: 100%;" />
                    <RadzenRequiredValidator Component="Email" Text="Email-ul este obligatoriu" />
                </RadzenStack>

                <!-- First Name & Last Name -->
                <RadzenRow Gap="1rem" RowGap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Prenume *</RadzenText>
                            <RadzenTextBox @bind-Value="model.FirstName" Placeholder="Ion" Style="width: 100%;" />
                            <RadzenRequiredValidator Component="FirstName" Text="Prenumele este obligatoriu" />
                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Nume *</RadzenText>
                            <RadzenTextBox @bind-Value="model.LastName" Placeholder="Popescu" Style="width: 100%;" />
                            <RadzenRequiredValidator Component="LastName" Text="Numele este obligatoriu" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Password -->
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Parolă *</RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                        <RadzenTextBox @bind-Value="model.Password" Placeholder="Minimum 8 caractere"
                                       Style="flex: 1;" InputAttributes="@(new Dictionary<string,object> { { "type", "password" } })" />
                        <RadzenButton Text="Generează" ButtonStyle="ButtonStyle.Light" Click="GeneratePassword" />
                    </RadzenStack>
                    <RadzenRequiredValidator Component="Password" Text="Parola este obligatorie" />
                    @if (showGeneratedPassword)
                    {
                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-success);">
                            Parolă generată: @model.Password
                        </RadzenText>
                    }
                </RadzenStack>

                <!-- Role -->
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Rol *</RadzenText>
                    <RadzenDropDown @bind-Value="model.Role" Data="@roleOptions" TextProperty="Text" ValueProperty="Value"
                                    Style="width: 100%;" Placeholder="Selectează rol..." />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                        @GetRoleDescription(model.Role)
                    </RadzenText>
                </RadzenStack>

                <!-- Faculty Selection (only for Professor role) -->
                @if (model.Role == UserRole.Professor)
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Facultate *</RadzenText>
                        <RadzenDropDown @bind-Value="model.FacultyId" Data="@faculties" TextProperty="Name" ValueProperty="Id"
                                        Style="width: 100%;" Placeholder="Selectează facultate..." />
                        <RadzenRequiredValidator Component="FacultyId" Text="Facultatea este obligatorie pentru profesori" />
                    </RadzenStack>
                }

                <!-- Actions -->
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End" Style="padding-top: 1rem;">
                    <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Light"
                                  Click="@(() => Navigation.NavigateTo("/admin/utilizatori"))" />
                    <RadzenButton Text="Creează Utilizator" ButtonStyle="ButtonStyle.Primary"
                                  ButtonType="ButtonType.Submit" Disabled="@isSubmitting" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>
</RadzenStack>

@code {
    private CreateUserDto model = new() { Role = UserRole.Student };
    private List<Faculty> faculties = new();
    private bool isSubmitting = false;
    private bool showGeneratedPassword = false;

    private List<RoleOption> roleOptions = new()
    {
        new() { Text = "Administrator", Value = UserRole.Admin },
        new() { Text = "Rector", Value = UserRole.Rector },
        new() { Text = "Decan", Value = UserRole.Dean },
        new() { Text = "Secretar", Value = UserRole.Secretary },
        new() { Text = "Profesor", Value = UserRole.Professor },
        new() { Text = "Student", Value = UserRole.Student }
    };

    private class Faculty
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    private class RoleOption
    {
        public string Text { get; set; } = "";
        public UserRole Value { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFaculties();
    }

    private async Task LoadFaculties()
    {
        faculties = await DbContext.Faculties
            .Select(f => new Faculty { Id = f.Id, Name = f.Name })
            .OrderBy(f => f.Name)
            .ToListAsync();
    }

    private void GeneratePassword()
    {
        const string chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%";
        var random = new Random();
        var password = new char[12];

        // Ensure password has at least one uppercase, one lowercase, one digit, one special char
        password[0] = chars[random.Next(0, 26)]; // Uppercase
        password[1] = chars[random.Next(26, 52)]; // Lowercase
        password[2] = chars[random.Next(52, 62)]; // Digit
        password[3] = chars[random.Next(62, chars.Length)]; // Special

        // Fill the rest randomly
        for (int i = 4; i < 12; i++)
        {
            password[i] = chars[random.Next(chars.Length)];
        }

        // Shuffle the password
        for (int i = password.Length - 1; i > 0; i--)
        {
            int j = random.Next(i + 1);
            (password[i], password[j]) = (password[j], password[i]);
        }

        model.Password = new string(password);
        showGeneratedPassword = true;
    }

    private async Task HandleSubmit(CreateUserDto dto)
    {
        isSubmitting = true;
        showGeneratedPassword = false;
        StateHasChanged();

        try
        {
            var result = await UserService.CreateAsync(model);

            if (result.Succeeded)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Utilizatorul a fost creat cu succes!",
                    Duration = 4000
                });
                await Task.Delay(1000);
                Navigation.NavigateTo("/admin/utilizatori");
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = result.ErrorMessage ?? "Eroare la crearea utilizatorului.",
                    Duration = 4000
                });
            }
        }
        catch (Exception)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Eroare",
                Detail = "Eroare la crearea utilizatorului. Vă rugăm încercați din nou.",
                Duration = 4000
            });
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private string GetRoleDescription(UserRole role) => role switch
    {
        UserRole.Admin => "Acces complet la sistem, gestionare utilizatori și configurări",
        UserRole.Rector => "Statistici la nivel de universitate, rapoarte generale",
        UserRole.Dean => "Management la nivel de facultate, aprobare note",
        UserRole.Secretary => "Procesare cereri și administrare studenți",
        UserRole.Professor => "Management note și prezențe pentru cursuri",
        UserRole.Student => "Vizualizare date proprii și înregistrare cereri",
        _ => ""
    };
}
