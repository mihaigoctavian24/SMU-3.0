@page "/admin/utilizatori/{id:guid}/editare"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageUsers")]
@inject IUserService UserService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService

<PageTitle>Editare Utilizator - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 800px; margin: 0 auto;">
    <!-- Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
        <RadzenButton Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                      Click="@(() => Navigation.NavigateTo("/admin/utilizatori"))" />
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Editare Utilizator</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Modifică datele utilizatorului
            </RadzenText>
        </RadzenStack>
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (user == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
            Utilizatorul nu a fost găsit.
        </RadzenAlert>
    }
    else
    {
        <!-- User Info -->
        <RadzenCard Style="padding: 1.5rem;">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center"
                         Style="padding-bottom: 1rem; border-bottom: 1px solid var(--rz-base-300);">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--rz-primary-lighter); display: flex; align-items: center; justify-content: center;">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; color: var(--rz-primary); font-weight: 600;">@GetInitials()</RadzenText>
                </div>
                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">@user.Email</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                        @GetRoleLabel(user.Role) • @(user.IsActive ? "Activ" : "Inactiv")
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <!-- Edit Form -->
        <RadzenCard Style="padding: 1.5rem;">
            <RadzenTemplateForm TItem="UpdateUserDto" Data="@model" Submit="@HandleSubmit">
                <RadzenStack Gap="1.5rem">
                    <!-- Email (readonly) -->
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Email</RadzenText>
                        <RadzenTextBox Value="@user.Email" Disabled="true" Style="width: 100%;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                            Email-ul nu poate fi modificat
                        </RadzenText>
                    </RadzenStack>

                    <!-- First Name & Last Name -->
                    <RadzenRow Gap="1rem" RowGap="1rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Prenume *</RadzenText>
                                <RadzenTextBox @bind-Value="model.FirstName" Style="width: 100%;" />
                                <RadzenRequiredValidator Component="FirstName" Text="Prenumele este obligatoriu" />
                            </RadzenStack>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Nume *</RadzenText>
                                <RadzenTextBox @bind-Value="model.LastName" Style="width: 100%;" />
                                <RadzenRequiredValidator Component="LastName" Text="Numele este obligatoriu" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Active Status -->
                    <RadzenStack Gap="0.5rem">
                        <RadzenCheckBox @bind-Value="model.IsActive" Name="IsActive" />
                        <RadzenLabel Text="Utilizator activ" Component="IsActive" Style="margin-left: 0.5rem; font-weight: 500;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                            @if (model.IsActive)
                            {
                                <span>Utilizatorul poate accesa sistemul</span>
                            }
                            else
                            {
                                <span>Utilizatorul nu poate accesa sistemul</span>
                            }
                        </RadzenText>
                    </RadzenStack>

                    <!-- Role Info (readonly) -->
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Rol</RadzenText>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenBadge Text="@GetRoleLabel(user.Role)" BadgeStyle="@GetRoleBadgeStyle(user.Role)" IsPill="true" />
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                Rolul se schimbă din lista principală
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Created At -->
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Creat la</RadzenText>
                        <RadzenTextBox Value="@user.CreatedAt.ToString("dd.MM.yyyy HH:mm")" Disabled="true" Style="width: 100%;" />
                    </RadzenStack>

                    <!-- Last Login -->
                    @if (user.LastLoginAt.HasValue)
                    {
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Ultima autentificare</RadzenText>
                            <RadzenTextBox Value="@user.LastLoginAt.Value.ToString("dd.MM.yyyy HH:mm")" Disabled="true" Style="width: 100%;" />
                        </RadzenStack>
                    }

                    <!-- Actions -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End" Style="padding-top: 1rem;">
                        <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => Navigation.NavigateTo("/admin/utilizatori"))" />
                        <RadzenButton Text="Salvează Modificările" ButtonStyle="ButtonStyle.Primary"
                                      ButtonType="ButtonType.Submit" Disabled="@isSubmitting" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenCard>
    }
</RadzenStack>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private UserDto? user;
    private UpdateUserDto model = new();
    private bool isLoading = true;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        isLoading = true;
        StateHasChanged();

        user = await UserService.GetByIdAsync(Id);

        if (user != null)
        {
            model = new UpdateUserDto
            {
                FirstName = user.FirstName,
                LastName = user.LastName,
                IsActive = user.IsActive
            };
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task HandleSubmit(UpdateUserDto dto)
    {
        isSubmitting = true;
        StateHasChanged();

        try
        {
            var result = await UserService.UpdateAsync(Id, model);

            if (result.Succeeded)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Utilizatorul a fost actualizat cu succes!",
                    Duration = 4000
                });
                await Task.Delay(1000);
                Navigation.NavigateTo("/admin/utilizatori");
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = result.ErrorMessage ?? "Eroare la actualizarea utilizatorului.",
                    Duration = 4000
                });
            }
        }
        catch (Exception)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Eroare",
                Detail = "Eroare la actualizarea utilizatorului. Vă rugăm încercați din nou.",
                Duration = 4000
            });
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private string GetInitials()
    {
        if (user == null) return "";
        var first = user.FirstName.Length > 0 ? user.FirstName[0].ToString() : "";
        var last = user.LastName.Length > 0 ? user.LastName[0].ToString() : "";
        return $"{first}{last}".ToUpper();
    }

    private string GetRoleLabel(UserRole role) => role switch
    {
        UserRole.Admin => "Administrator",
        UserRole.Rector => "Rector",
        UserRole.Dean => "Decan",
        UserRole.Secretary => "Secretar",
        UserRole.Professor => "Profesor",
        UserRole.Student => "Student",
        _ => role.ToString()
    };

    private BadgeStyle GetRoleBadgeStyle(UserRole role) => role switch
    {
        UserRole.Admin => BadgeStyle.Danger,
        UserRole.Rector => BadgeStyle.Info,
        UserRole.Dean => BadgeStyle.Info,
        UserRole.Secretary => BadgeStyle.Warning,
        UserRole.Professor => BadgeStyle.Primary,
        UserRole.Student => BadgeStyle.Success,
        _ => BadgeStyle.Secondary
    };
}
