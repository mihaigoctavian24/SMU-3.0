@page "/admin/activity-feed"
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@using Microsoft.AspNetCore.SignalR.Client
@inject IActivityFeedService ActivityService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@attribute [Authorize(Policy = "AdminOnly")]

<PageTitle>Activity Feed - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="padding: 1.5rem;">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Activity Feed</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Monitor system activities in real-time</RadzenText>
        </RadzenStack>
        <RadzenButton Text="Export to Excel"
                      Icon="download"
                      ButtonStyle="ButtonStyle.Success"
                      Click="@ExportActivities"
                      Style="display: flex; align-items: center; gap: 0.5rem;" />
    </RadzenStack>

    <!-- Filters -->
    <RadzenCard Style="padding: 1rem;">
        <RadzenRow Gap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenStack Gap="0.25rem">
                    <RadzenLabel Text="Search" />
                    <RadzenTextBox @bind-Value="@filter.SearchTerm"
                                   Placeholder="User, entity type..."
                                   @oninput="@OnSearchChanged"
                                   Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>

            <!-- Action Filter -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenStack Gap="0.25rem">
                    <RadzenLabel Text="Action" />
                    <RadzenDropDown @bind-Value="@filter.Action"
                                    Data="@actionOptions"
                                    Change="@LoadActivities"
                                    AllowClear="true"
                                    Placeholder="All Actions"
                                    Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>

            <!-- Entity Type Filter -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenStack Gap="0.25rem">
                    <RadzenLabel Text="Entity Type" />
                    <RadzenDropDown @bind-Value="@filter.EntityType"
                                    Data="@entityTypeOptions"
                                    Change="@LoadActivities"
                                    AllowClear="true"
                                    Placeholder="All Types"
                                    Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>

            <!-- Date Range -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenStack Gap="0.25rem">
                    <RadzenLabel Text="Date Range" />
                    <RadzenDropDown TValue="string" Value="@selectedDateRange"
                                    Data="@dateRangeOptions"
                                    TextProperty="Text"
                                    ValueProperty="Value"
                                    Change="@OnDateRangeChanged"
                                    Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Activity Timeline -->
    <RadzenCard Style="padding: 0;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Loading activities...</RadzenText>
            </RadzenStack>
        }
        else if (activities.Count == 0)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenIcon Icon="inbox" Style="font-size: 4rem; color: var(--rz-text-disabled-color); margin-bottom: 1rem;" />
                <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">No activities found</RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenStack Gap="0">
                @foreach (var group in activitiesByDate)
                {
                    <!-- Date Header -->
                    <div style="padding: 0.75rem 1.5rem; background: var(--rz-base-200); border-bottom: 1px solid var(--rz-border-color);">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; font-weight: 600; color: var(--rz-text-secondary-color);">@group.Key</RadzenText>
                    </div>

                    <!-- Activities for this date -->
                    @foreach (var activity in group.Value)
                    {
                        <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--rz-border-color); transition: background 0.2s;" @onmouseover="@(() => {})" @onmouseout="@(() => {})" class="activity-row">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Start">
                                <!-- Icon -->
                                <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; @GetActionBackgroundStyle(activity.IconColor) flex-shrink: 0;">
                                    <RadzenIcon Icon="@activity.Icon" Style="@($"font-size: 1.25rem; {GetActionTextStyle(activity.IconColor)}")" />
                                </div>

                                <!-- Content -->
                                <RadzenStack Style="flex: 1; min-width: 0;">
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                            <span style="font-weight: 500;">@activity.UserName</span>
                                            <span style="color: var(--rz-text-secondary-color);">@activity.ActionDescription</span>
                                            @if (!string.IsNullOrEmpty(activity.EntityName))
                                            {
                                                <span style="font-weight: 500;">@activity.EntityName</span>
                                            }
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; white-space: nowrap; color: var(--rz-text-secondary-color);">@activity.RelativeTime</RadzenText>
                                    </RadzenStack>

                                    <!-- Additional Details -->
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Style="margin-top: 0.25rem;">
                                        @if (!string.IsNullOrEmpty(activity.UserRole))
                                        {
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" AlignItems="AlignItems.Center">
                                                <RadzenIcon Icon="shield" Style="font-size: 0.75rem; color: var(--rz-text-secondary-color);" />
                                                <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@activity.UserRole</RadzenText>
                                            </RadzenStack>
                                        }
                                        @if (!string.IsNullOrEmpty(activity.IpAddress))
                                        {
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" AlignItems="AlignItems.Center">
                                                <RadzenIcon Icon="location_on" Style="font-size: 0.75rem; color: var(--rz-text-secondary-color);" />
                                                <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@activity.IpAddress</RadzenText>
                                            </RadzenStack>
                                        }
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" AlignItems="AlignItems.Center">
                                            <RadzenIcon Icon="schedule" Style="font-size: 0.75rem; color: var(--rz-text-secondary-color);" />
                                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@activity.CreatedAt.ToString("HH:mm:ss")</RadzenText>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    }
                }
            </RadzenStack>

            <!-- Pagination -->
            @if (pagedResult != null && pagedResult.TotalPages > 1)
            {
                <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--rz-border-color);">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">
                            Showing <span style="font-weight: 500;">@((pagedResult.Page - 1) * pagedResult.PageSize + 1)</span>
                            to <span style="font-weight: 500;">@Math.Min(pagedResult.Page * pagedResult.PageSize, pagedResult.TotalCount)</span>
                            of <span style="font-weight: 500;">@pagedResult.TotalCount</span> activities
                        </RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Previous"
                                          ButtonStyle="ButtonStyle.Light"
                                          Click="@PreviousPage"
                                          Disabled="@(!pagedResult.HasPreviousPage)" />
                            <RadzenButton Text="Next"
                                          ButtonStyle="ButtonStyle.Light"
                                          Click="@NextPage"
                                          Disabled="@(!pagedResult.HasNextPage)" />
                        </RadzenStack>
                    </RadzenStack>
                </div>
            }
        }
    </RadzenCard>
</RadzenStack>

<style>
    .activity-row:hover {
        background: var(--rz-base-200);
    }
</style>

@code {
    private ActivityFilter filter = new();
    private List<ActivityLogDto> activities = new();
    private Dictionary<string, List<ActivityLogDto>> activitiesByDate = new();
    private PagedResult<ActivityLogDto>? pagedResult;
    private int currentPage = 1;
    private int pageSize = 25;
    private bool isLoading = true;
    private System.Threading.Timer? searchDebounceTimer;
    private HubConnection? hubConnection;
    private string selectedDateRange = "month";

    private List<ActivityAction> actionOptions = Enum.GetValues<ActivityAction>().ToList();
    private List<string> entityTypeOptions = new() { "Student", "Grade", "Course", "User", "Faculty", "Program", "Group", "Attendance" };
    private List<DateRangeOption> dateRangeOptions = new()
    {
        new DateRangeOption { Text = "Today", Value = "today" },
        new DateRangeOption { Text = "Last 7 Days", Value = "week" },
        new DateRangeOption { Text = "Last 30 Days", Value = "month" },
        new DateRangeOption { Text = "All Time", Value = "all" }
    };

    protected override async Task OnInitializedAsync()
    {
        filter.EndDate = DateTime.UtcNow;
        filter.StartDate = DateTime.UtcNow.AddDays(-30);

        await LoadActivities();
        await InitializeSignalR();
    }

    private async Task InitializeSignalR()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/notificationHub"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<ActivityLogDto>("ReceiveActivity", async (activity) =>
            {
                activities.Insert(0, activity);
                GroupActivitiesByDate();
                await InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
            await hubConnection.InvokeAsync("JoinAdminActivityGroup");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
        }
    }

    private async Task LoadActivities()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            pagedResult = await ActivityService.GetPagedActivitiesAsync(filter, currentPage, pageSize);
            activities = pagedResult.Items;
            GroupActivitiesByDate();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load activities: {ex.Message}");
            activities = new();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void GroupActivitiesByDate()
    {
        activitiesByDate = activities
            .GroupBy(a => a.CreatedAt.Date == DateTime.UtcNow.Date ? "Today" :
                         a.CreatedAt.Date == DateTime.UtcNow.Date.AddDays(-1) ? "Yesterday" :
                         a.CreatedAt.ToString("dddd, dd MMMM yyyy"))
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private void OnSearchChanged()
    {
        searchDebounceTimer?.Dispose();
        searchDebounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                currentPage = 1;
                await LoadActivities();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task OnDateRangeChanged(object value)
    {
        var range = value?.ToString();
        selectedDateRange = range ?? "month";
        var now = DateTime.UtcNow;

        filter.EndDate = now;
        filter.StartDate = range switch
        {
            "today" => now.Date,
            "week" => now.AddDays(-7),
            "month" => now.AddDays(-30),
            "all" => null,
            _ => now.AddDays(-30)
        };

        currentPage = 1;
        await LoadActivities();
    }

    private async Task PreviousPage()
    {
        if (pagedResult?.HasPreviousPage == true)
        {
            currentPage--;
            await LoadActivities();
        }
    }

    private async Task NextPage()
    {
        if (pagedResult?.HasNextPage == true)
        {
            currentPage++;
            await LoadActivities();
        }
    }

    private async Task ExportActivities()
    {
        try
        {
            var fileBytes = await ActivityService.ExportActivitiesAsync(filter);
            var fileName = $"activity_log_{DateTime.UtcNow:yyyyMMdd_HHmmss}.xlsx";

            await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Export failed: {ex.Message}");
        }
    }

    private string GetActionBackgroundStyle(string color) => color switch
    {
        "green" => "background-color: rgba(var(--rz-success-rgb), 0.1);",
        "blue" => "background-color: rgba(var(--rz-info-rgb), 0.1);",
        "red" => "background-color: rgba(var(--rz-danger-rgb), 0.1);",
        "gray" => "background-color: rgba(0, 0, 0, 0.05);",
        "purple" => "background-color: rgba(128, 0, 128, 0.1);",
        _ => "background-color: rgba(0, 0, 0, 0.05);"
    };

    private string GetActionTextStyle(string color) => color switch
    {
        "green" => "color: var(--rz-success);",
        "blue" => "color: var(--rz-info);",
        "red" => "color: var(--rz-danger);",
        "gray" => "color: var(--rz-text-secondary-color);",
        "purple" => "color: purple;",
        _ => "color: var(--rz-text-secondary-color);"
    };

    public async ValueTask DisposeAsync()
    {
        searchDebounceTimer?.Dispose();

        if (hubConnection != null)
        {
            await hubConnection.InvokeAsync("LeaveAdminActivityGroup");
            await hubConnection.DisposeAsync();
        }
    }

    private class DateRangeOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
