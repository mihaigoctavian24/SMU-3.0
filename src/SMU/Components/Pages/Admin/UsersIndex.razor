@page "/admin/utilizatori"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageUsers")]
@inject IUserService UserService
@inject NavigationManager Navigation
@inject DialogService DialogService

<PageTitle>Utilizatori - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Utilizatori</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Gestionează conturile utilizatorilor din sistem
            </RadzenText>
        </RadzenStack>
        <RadzenButton Text="Adaugă Utilizator" Icon="add" ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/admin/utilizatori/nou"))" />
    </RadzenStack>

    <!-- Filters & Search -->
    <RadzenCard Style="padding: 1.5rem;">
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Căutare</RadzenText>
                    <RadzenTextBox @bind-Value="searchTerm" @bind-Value:after="HandleSearch"
                                   Placeholder="Nume sau email..." Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>

            <!-- Role Filter -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Rol</RadzenText>
                    <RadzenDropDown @bind-Value="selectedRole" Data="@roleOptions" TextProperty="Text" ValueProperty="Value"
                                    Style="width: 100%;" Change="ApplyFilters" AllowClear="true" Placeholder="Toate rolurile" />
                </RadzenStack>
            </RadzenColumn>

            <!-- Status Filter -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Status</RadzenText>
                    <RadzenDropDown @bind-Value="selectedStatus" Data="@statusOptions" TextProperty="Text" ValueProperty="Value"
                                    Style="width: 100%;" Change="ApplyFilters" AllowClear="true" Placeholder="Toate statusurile" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Users Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </RadzenStack>
        }
        else if (users.Any())
        {
            <RadzenDataGrid Data="@users" TItem="UserDto" AllowSorting="true" Style="height: auto;">
                <Columns>
                    <RadzenDataGridColumn TItem="UserDto" Property="FullName" Title="Nume" Width="200px" />
                    <RadzenDataGridColumn TItem="UserDto" Property="Email" Title="Email" Width="200px" />
                    <RadzenDataGridColumn TItem="UserDto" Property="Role" Title="Rol" Width="150px">
                        <Template Context="user">
                            <RadzenBadge Text="@user.RoleLabel" BadgeStyle="@GetRoleBadgeStyle(user.Role)" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="UserDto" Property="IsActive" Title="Status" Width="120px">
                        <Template Context="user">
                            <RadzenBadge Text="@(user.IsActive ? "Activ" : "Inactiv")"
                                         BadgeStyle="@(user.IsActive ? BadgeStyle.Success : BadgeStyle.Secondary)" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="UserDto" Property="LastLoginAt" Title="Ultima Autentificare" Width="180px">
                        <Template Context="user">
                            @(user.LastLoginAt.HasValue ? user.LastLoginAt.Value.ToString("dd.MM.yyyy HH:mm") : "Niciodată")
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="UserDto" Title="Acțiuni" Width="350px" Sortable="false">
                        <Template Context="user">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenButton Text="Editează" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/admin/utilizatori/{user.Id}/editare"))" />
                                @if (user.IsActive)
                                {
                                    <RadzenButton Text="Dezactivează" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => ConfirmDeactivate(user.Id))" />
                                }
                                else
                                {
                                    <RadzenButton Text="Activează" ButtonStyle="ButtonStyle.Success" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => ConfirmActivate(user.Id))" />
                                }
                                <RadzenButton Text="Resetează Parolă" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => ShowResetPasswordModal(user.Id))" />
                                <RadzenButton Text="Schimbă Rol" ButtonStyle="ButtonStyle.Info" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => ShowChangeRoleModal(user.Id, user.Role))" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <!-- User Count -->
            <RadzenStack Class="rz-p-4" Style="border-top: 1px solid var(--rz-base-300);">
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                    Total: @users.Count utilizatori
                </RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenIcon Icon="group" Style="font-size: 3rem; color: var(--rz-text-disabled-color); margin-bottom: 1rem;" />
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
                    Nu au fost găsiți utilizatori
                </RadzenText>
            </RadzenStack>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private List<UserDto> users = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = "";
    private string selectedRole = "";
    private string selectedStatus = "";

    // Modal states
    private Guid selectedUserId = Guid.Empty;
    private string newPassword = "";
    private string newRole = "";

    // Dropdown options
    private List<DropdownOption> roleOptions = new()
    {
        new() { Text = "Administrator", Value = "Admin" },
        new() { Text = "Rector", Value = "Rector" },
        new() { Text = "Decan", Value = "Dean" },
        new() { Text = "Secretar", Value = "Secretary" },
        new() { Text = "Profesor", Value = "Professor" },
        new() { Text = "Student", Value = "Student" }
    };

    private List<DropdownOption> statusOptions = new()
    {
        new() { Text = "Activ", Value = "true" },
        new() { Text = "Inactiv", Value = "false" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        StateHasChanged();

        var filter = new UserFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            Role = string.IsNullOrWhiteSpace(selectedRole) ? null : Enum.Parse<UserRole>(selectedRole),
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        users = await UserService.GetAllAsync(filter);

        isLoading = false;
        StateHasChanged();
    }

    private System.Threading.Timer? searchTimer;

    private void HandleSearch()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () => await LoadUsers());
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        await LoadUsers();
    }

    private async Task ConfirmDeactivate(Guid id)
    {
        var confirmed = await DialogService.Confirm("Ești sigur că vrei să dezactivezi acest utilizator? Acesta nu va mai putea accesa sistemul.",
            "Confirmare Dezactivare", new ConfirmOptions { OkButtonText = "Dezactivează", CancelButtonText = "Anulează" });

        if (confirmed == true)
        {
            var result = await UserService.DeactivateAsync(id);
            if (result.Succeeded)
            {
                await LoadUsers();
            }
        }
    }

    private async Task ConfirmActivate(Guid id)
    {
        var confirmed = await DialogService.Confirm("Ești sigur că vrei să activezi acest utilizator? Acesta va putea accesa sistemul.",
            "Confirmare Activare", new ConfirmOptions { OkButtonText = "Activează", CancelButtonText = "Anulează" });

        if (confirmed == true)
        {
            var result = await UserService.ActivateAsync(id);
            if (result.Succeeded)
            {
                await LoadUsers();
            }
        }
    }

    private async Task ShowResetPasswordModal(Guid id)
    {
        selectedUserId = id;
        var result = await DialogService.OpenAsync("Resetare Parolă", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Parolă Nouă</RadzenText>
                    <RadzenTextBox @bind-Value="newPassword" Placeholder="Minimum 8 caractere" Style="width: 100%;" />
                </RadzenStack>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Light" Click="@(() => ds.Close(false))" />
                    <RadzenButton Text="Resetează" ButtonStyle="ButtonStyle.Primary" Click="@(() => ds.Close(true))" />
                </RadzenStack>
            </RadzenStack>
        );

        if (result == true)
        {
            await ResetPassword();
        }
    }

    private async Task ResetPassword()
    {
        if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 8)
        {
            return;
        }

        var result = await UserService.ResetPasswordAsync(selectedUserId, newPassword);
        if (result.Succeeded)
        {
            newPassword = "";
        }
    }

    private async Task ShowChangeRoleModal(Guid id, UserRole currentRole)
    {
        selectedUserId = id;
        newRole = currentRole.ToString();

        var result = await DialogService.OpenAsync("Schimbare Rol", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Rol Nou</RadzenText>
                    <RadzenDropDown @bind-Value="newRole" Data="@roleOptions" TextProperty="Text" ValueProperty="Value" Style="width: 100%;" />
                </RadzenStack>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Light" Click="@(() => ds.Close(false))" />
                    <RadzenButton Text="Schimbă Rol" ButtonStyle="ButtonStyle.Primary" Click="@(() => ds.Close(true))" />
                </RadzenStack>
            </RadzenStack>
        );

        if (result == true)
        {
            await ChangeRole();
        }
    }

    private async Task ChangeRole()
    {
        if (string.IsNullOrWhiteSpace(newRole))
        {
            return;
        }

        var roleEnum = Enum.Parse<UserRole>(newRole);
        var result = await UserService.ChangeRoleAsync(selectedUserId, roleEnum);
        if (result.Succeeded)
        {
            await LoadUsers();
        }
    }

    private BadgeStyle GetRoleBadgeStyle(UserRole role) => role switch
    {
        UserRole.Admin => BadgeStyle.Danger,
        UserRole.Rector => BadgeStyle.Info,
        UserRole.Dean => BadgeStyle.Info,
        UserRole.Secretary => BadgeStyle.Warning,
        UserRole.Professor => BadgeStyle.Primary,
        UserRole.Student => BadgeStyle.Success,
        _ => BadgeStyle.Secondary
    };

    public void Dispose()
    {
        searchTimer?.Dispose();
    }

    private class DropdownOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
