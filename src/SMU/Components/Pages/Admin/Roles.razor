@page "/admin/roluri"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageUsers")]
@inject IUserService UserService
@inject NavigationManager Navigation

<PageTitle>Roluri - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem">
        <RadzenStack Gap="0.5rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Roluri și Permisiuni</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Vizualizare roluri disponibile și distribuția utilizatorilor</RadzenText>
        </RadzenStack>
        <RadzenButton Text="Gestionare Utilizatori"
                      Icon="people"
                      ButtonStyle="ButtonStyle.Light"
                      Click="@(() => Navigation.NavigateTo("/admin/utilizatori"))"
                      Style="display: flex; align-items: center; gap: 0.5rem;" />
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        </RadzenStack>
    }
    else
    {
        <!-- Role Cards -->
        <RadzenRow Gap="1.5rem">
            @foreach (var roleStats in roleStatsList)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Style="padding: 1.5rem;">
                        <RadzenStack Gap="1rem">
                            <!-- Header with Icon and Count -->
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="0.75rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                                    <div style="width: 3rem; height: 3rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; @GetRoleIconBgStyle(roleStats.Role)">
                                        @GetRoleIcon(roleStats.Role)
                                    </div>
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">@roleStats.RoleName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.H5" Style="@($"margin: 0; font-weight: bold; {GetRoleTextColorStyle(roleStats.Role)}")">@roleStats.UserCount</RadzenText>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@roleStats.Description</RadzenText>

                            <!-- Permissions -->
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; text-transform: uppercase; font-weight: 500; color: var(--rz-text-secondary-color);">Permisiuni principale:</RadzenText>
                                <RadzenStack Gap="0.25rem">
                                    @foreach (var permission in GetRolePermissions(roleStats.Role))
                                    {
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                            <RadzenIcon Icon="check_circle" Style="color: var(--rz-success); font-size: 1rem; margin-top: 0.125rem; flex-shrink: 0;" />
                                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@permission</RadzenText>
                                        </RadzenStack>
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>

        <!-- Role Hierarchy -->
        <RadzenCard Style="padding: 1.5rem;">
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Ierarhie Roluri</RadzenText>
                <RadzenStack Gap="0.75rem">
                    <div style="padding: 1rem; background: rgba(var(--rz-danger-rgb), 0.1); border: 1px solid rgba(var(--rz-danger-rgb), 0.2); border-radius: 0.5rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenStack Style="flex: 1;" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 500; color: var(--rz-danger);">Administrator</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-danger-dark);">Nivel maxim de acces - Poate gestiona tot sistemul</RadzenText>
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: bold; color: var(--rz-danger);">1</RadzenText>
                        </RadzenStack>
                    </div>

                    <div style="padding: 1rem; background: rgba(128, 0, 128, 0.1); border: 1px solid rgba(128, 0, 128, 0.2); border-radius: 0.5rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenStack Style="flex: 1;" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 500; color: purple;">Rector</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: #6b21a8;">Nivel universitate - Acces la toate facultățile</RadzenText>
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: bold; color: purple;">2</RadzenText>
                        </RadzenStack>
                    </div>

                    <div style="padding: 1rem; background: rgba(var(--rz-info-rgb), 0.1); border: 1px solid rgba(var(--rz-info-rgb), 0.2); border-radius: 0.5rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenStack Style="flex: 1;" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 500; color: var(--rz-info);">Decan</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-info-dark);">Nivel facultate - Acces la propria facultate</RadzenText>
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: bold; color: var(--rz-info);">3</RadzenText>
                        </RadzenStack>
                    </div>

                    <div style="padding: 1rem; background: rgba(var(--rz-warning-rgb), 0.1); border: 1px solid rgba(var(--rz-warning-rgb), 0.2); border-radius: 0.5rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenStack Style="flex: 1;" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 500; color: var(--rz-warning);">Secretar / Profesor</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-warning-dark);">Nivel operațional - Acces limitat la funcții specifice</RadzenText>
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: bold; color: var(--rz-warning);">4</RadzenText>
                        </RadzenStack>
                    </div>

                    <div style="padding: 1rem; background: rgba(var(--rz-success-rgb), 0.1); border: 1px solid rgba(var(--rz-success-rgb), 0.2); border-radius: 0.5rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenStack Style="flex: 1;" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 500; color: var(--rz-success);">Student</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-success-dark);">Nivel utilizator - Acces doar la datele proprii</RadzenText>
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: bold; color: var(--rz-success);">5</RadzenText>
                        </RadzenStack>
                    </div>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <!-- Total Summary -->
        <RadzenCard Style="background: linear-gradient(to right, var(--rz-primary), var(--rz-primary-dark)); padding: 1.5rem; color: white;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; opacity: 0.9;">Total Utilizatori în Sistem</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@totalUsers</RadzenText>
                </RadzenStack>
                <RadzenIcon Icon="groups" Style="font-size: 4rem; opacity: 0.2;" />
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private List<RoleStatsDto> roleStatsList = new();
    private bool isLoading = true;
    private int totalUsers = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoleStats();
    }

    private async Task LoadRoleStats()
    {
        isLoading = true;
        StateHasChanged();

        roleStatsList = await UserService.GetRoleStatsAsync();
        totalUsers = roleStatsList.Sum(r => r.UserCount);

        isLoading = false;
        StateHasChanged();
    }

    private string GetRoleIconBgStyle(UserRole role) => role switch
    {
        UserRole.Admin => "background-color: rgba(var(--rz-danger-rgb), 0.1);",
        UserRole.Rector => "background-color: rgba(128, 0, 128, 0.1);",
        UserRole.Dean => "background-color: rgba(var(--rz-info-rgb), 0.1);",
        UserRole.Secretary => "background-color: rgba(var(--rz-warning-rgb), 0.1);",
        UserRole.Professor => "background-color: rgba(var(--rz-primary-rgb), 0.1);",
        UserRole.Student => "background-color: rgba(var(--rz-success-rgb), 0.1);",
        _ => "background-color: rgba(0, 0, 0, 0.05);"
    };

    private string GetRoleTextColorStyle(UserRole role) => role switch
    {
        UserRole.Admin => "color: var(--rz-danger);",
        UserRole.Rector => "color: purple;",
        UserRole.Dean => "color: var(--rz-info);",
        UserRole.Secretary => "color: var(--rz-warning);",
        UserRole.Professor => "color: var(--rz-primary);",
        UserRole.Student => "color: var(--rz-success);",
        _ => "color: var(--rz-text-color);"
    };

    private RenderFragment GetRoleIcon(UserRole role) => role switch
    {
        UserRole.Admin => @<RadzenIcon Icon="admin_panel_settings" Style="font-size: 1.5rem; color: var(--rz-danger);" />,
        UserRole.Rector => @<RadzenIcon Icon="school" Style="font-size: 1.5rem; color: purple;" />,
        UserRole.Dean => @<RadzenIcon Icon="supervisor_account" Style="font-size: 1.5rem; color: var(--rz-info);" />,
        UserRole.Secretary => @<RadzenIcon Icon="event_note" Style="font-size: 1.5rem; color: var(--rz-warning);" />,
        UserRole.Professor => @<RadzenIcon Icon="cast_for_education" Style="font-size: 1.5rem; color: var(--rz-primary);" />,
        UserRole.Student => @<RadzenIcon Icon="person" Style="font-size: 1.5rem; color: var(--rz-success);" />,
        _ => @<RadzenIcon Icon="person" Style="font-size: 1.5rem;" />
    };

    private List<string> GetRolePermissions(UserRole role) => role switch
    {
        UserRole.Admin => new List<string>
        {
            "Gestionare completă utilizatori",
            "Configurare sistem",
            "Acces la toate datele",
            "Management roluri și permisiuni"
        },
        UserRole.Rector => new List<string>
        {
            "Vizualizare statistici universitate",
            "Rapoarte generale",
            "Oversight la toate facultățile",
            "Decizii strategice"
        },
        UserRole.Dean => new List<string>
        {
            "Management facultate",
            "Aprobare note",
            "Rapoarte facultate",
            "Supervizare profesori"
        },
        UserRole.Secretary => new List<string>
        {
            "Procesare cereri studenți",
            "Administrare studenți",
            "Emitere documente",
            "Gestionare înscrieri"
        },
        UserRole.Professor => new List<string>
        {
            "Introducere note",
            "Marcare prezențe",
            "Gestionare cursuri proprii",
            "Vizualizare studenți"
        },
        UserRole.Student => new List<string>
        {
            "Vizualizare note proprii",
            "Vizualizare prezențe",
            "Înregistrare cereri",
            "Acces situație școlară"
        },
        _ => new List<string>()
    };
}
