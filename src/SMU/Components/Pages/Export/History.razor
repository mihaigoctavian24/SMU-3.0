@page "/export/history"
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.AspNetCore.Authorization
@using Radzen
@attribute [Authorize]
@inject IExportHistoryService ExportHistoryService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Istoric Exporturi - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Gap="0.5rem">
        <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">Istoric Exporturi</RadzenText>
        <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; color: var(--rz-text-secondary-color);">VizualizeazƒÉ »ôi gestioneazƒÉ toate exporturile tale anterioare</RadzenText>
    </RadzenStack>

    <!-- Filters -->
    <RadzenCard Style="padding: 1rem;">
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Export Type Filter -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenFormField Text="Tip Export" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedExportType"
                                    Change="@LoadExports"
                                    Data="@exportTypeOptions"
                                    TextProperty="Text"
                                    ValueProperty="Value"
                                    AllowClear="true"
                                    Placeholder="Toate"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Limit Filter -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenFormField Text="Rezultate" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="limit"
                                    Change="@LoadExports"
                                    Data="@limitOptions"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Refresh Button -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenStack Style="height: 100%;" JustifyContent="JustifyContent.End">
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Click="LoadExports"
                                  IsBusy="@isLoading"
                                  Disabled="@isLoading"
                                  Icon="refresh"
                                  Text="@(isLoading ? "Se √ÆncarcƒÉ..." : "Re√ÆmprospƒÉteazƒÉ")"
                                  Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Statistics Card -->
    @if (stats != null)
    {
        <RadzenCard Style="padding: 1.5rem; background: linear-gradient(to right, var(--rz-primary), var(--rz-primary-dark)); color: white;">
            <RadzenRow Gap="1rem" RowGap="1rem">
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; opacity: 0.9;">Total Exporturi</RadzenText>
                        <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@stats.TotalExports</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; opacity: 0.9;">Total DescƒÉrcƒÉri</RadzenText>
                        <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@stats.TotalDownloads</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; opacity: 0.9;">Dimensiune TotalƒÉ</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">@stats.TotalFileSizeFormatted</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; opacity: 0.9;">Cel Mai Popular</RadzenText>
                        <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: bold;">@(stats.MostPopularExport?.TypeName ?? "N/A")</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    }

    <!-- Export History Table -->
    <RadzenCard>
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Se √ÆncarcƒÉ istoricul...</RadzenText>
            </RadzenStack>
        }
        else if (exports == null || !exports.Any())
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem;">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">üì≠ Nu existƒÉ exporturi √Æn istoric</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 0.5rem; color: var(--rz-text-secondary-color);">Exporturile tale vor apƒÉrea aici dupƒÉ generare</RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenDataGrid Data="@exports" TItem="ExportHistoryDto" AllowPaging="false" AllowSorting="true" Style="height: auto;">
                <Columns>
                    <RadzenDataGridColumn TItem="ExportHistoryDto" Property="ExportTypeName" Title="Tip" Width="250px">
                        <Template Context="export">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.H5" Style="margin: 0;">@GetExportIcon(export.ExportType)</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@export.ExportTypeName</RadzenText>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ExportHistoryDto" Property="FileName" Title="Fi»ôier" Width="300px">
                        <Template Context="export">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-family: monospace;">@export.FileName</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ExportHistoryDto" Property="FileSizeFormatted" Title="Dimensiune" Width="120px">
                        <Template Context="export">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@export.FileSizeFormatted</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ExportHistoryDto" Property="CreatedAt" Title="Data" Width="180px">
                        <Template Context="export">
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@export.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@export.CreatedAtRelative</RadzenText>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ExportHistoryDto" Property="DownloadCount" Title="DescƒÉrcƒÉri" Width="120px" TextAlign="TextAlign.Center">
                        <Template Context="export">
                            <RadzenBadge BadgeStyle="BadgeStyle.Primary" Variant="Variant.Flat" Text="@export.DownloadCount.ToString()" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="ExportHistoryDto" Title="Ac»õiuni" Width="150px" TextAlign="TextAlign.Center">
                        <Template Context="export">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.5rem">
                                <RadzenButton ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Flat"
                                              Click="@(() => RegenerateExport(export))"
                                              Icon="refresh"
                                              Size="ButtonSize.Small"
                                              title="RegenereazƒÉ" />
                                <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Flat"
                                              Click="@(() => DeleteExport(export.Id))"
                                              Icon="delete"
                                              Size="ButtonSize.Small"
                                              title="»òterge" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenCard>

    <!-- Info Footer -->
    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; text-align: center; color: var(--rz-text-secondary-color);">
        üí° Exporturile sunt pƒÉstrate 30 de zile, dupƒÉ care sunt »ôterse automat
    </RadzenText>
</RadzenStack>

@code {
    private List<ExportHistoryDto>? exports;
    private ExportStatsDto? stats;
    private bool isLoading = true;
    private string selectedExportType = "";
    private int limit = 20;
    private Guid currentUserId;

    private List<ExportTypeOption> exportTypeOptions = new();
    private List<int> limitOptions = new() { 10, 20, 50, 100 };

    private class ExportTypeOption
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        // Populate export type options
        foreach (var type in Enum.GetValues<ExportType>())
        {
            exportTypeOptions.Add(new ExportTypeOption
            {
                Value = type.ToString(),
                Text = GetExportTypeName(type)
            });
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
            {
                currentUserId = userId;
                await LoadExports();
                await LoadStats();
            }
        }
    }

    private async Task LoadExports()
    {
        isLoading = true;
        try
        {
            ExportType? typeFilter = null;
            if (!string.IsNullOrEmpty(selectedExportType))
            {
                typeFilter = Enum.Parse<ExportType>(selectedExportType);
            }

            exports = await ExportHistoryService.GetUserExportsAsync(
                currentUserId,
                limit,
                typeFilter);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading exports: {ex.Message}");
            exports = new List<ExportHistoryDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadStats()
    {
        try
        {
            stats = await ExportHistoryService.GetExportStatsAsync(currentUserId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stats: {ex.Message}");
        }
    }

    private async Task DeleteExport(Guid exportId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Sigur dori»õi sƒÉ »ôterge»õi acest export?"))
        {
            try
            {
                await ExportHistoryService.DeleteExportAsync(exportId);
                await LoadExports();
                await LoadStats();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting export: {ex.Message}");
            }
        }
    }

    private async Task RegenerateExport(ExportHistoryDto export)
    {
        // TODO: Implement re-generation logic
        // This would parse export.Parameters JSON and call the appropriate export method
        Console.WriteLine($"Regenerate {export.ExportType} with params: {export.Parameters}");
    }

    private string GetExportTypeName(ExportType type)
    {
        return type switch
        {
            ExportType.SituatieScolara => "Situa»õie »òcolarƒÉ (PDF)",
            ExportType.AdeverintaStudent => "Adeverin»õƒÉ Student (PDF)",
            ExportType.CatalogNote => "Catalog Note (PDF)",
            ExportType.RaportFacultate => "Raport Facultate (PDF)",
            ExportType.StudentsExcel => "Lista Studen»õi (Excel)",
            ExportType.GradesExcel => "Lista Note (Excel)",
            ExportType.AttendanceExcel => "Lista Prezen»õƒÉ (Excel)",
            ExportType.ActivityLogExcel => "Jurnal Activitate (Excel)",
            _ => type.ToString()
        };
    }

    private string GetExportIcon(ExportType type)
    {
        return type switch
        {
            ExportType.SituatieScolara or ExportType.AdeverintaStudent or ExportType.CatalogNote or ExportType.RaportFacultate => "üìÑ",
            ExportType.StudentsExcel or ExportType.GradesExcel or ExportType.AttendanceExcel or ExportType.ActivityLogExcel => "üìä",
            _ => "üìÅ"
        };
    }
}
