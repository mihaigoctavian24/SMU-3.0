@page "/export"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using SMU.Services
@using SMU.Data.Entities
@using System.Security.Claims
@using Radzen
@using SMU.Data
@using Microsoft.EntityFrameworkCore
@attribute [Authorize]
@inject IExportService ExportService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ApplicationDbContext DbContext

<PageTitle>Export - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Gap="0.25rem">
        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Export Documente și Date</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Generează și descarcă documente PDF și fișiere Excel</RadzenText>
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        </RadzenStack>
    }
    else
    {
        <!-- Student Documents Section -->
        @if (userRole == UserRole.Student)
        {
            <RadzenCard Style="padding: 1.5rem;">
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="description" Style="color: var(--rz-primary);" />
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Documente Student</RadzenText>
                    </RadzenStack>

                    <RadzenRow Gap="1rem" RowGap="1rem">
                        <!-- Situație Școlară -->
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenCard Variant="Variant.Outlined" Style="padding: 1rem;">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">Situație Școlară</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Document cuprinzător cu toate notele, creditele și media generală</RadzenText>
                                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                                  Click="DownloadSituatieScolara"
                                                  IsBusy="@exportingPdf"
                                                  Disabled="@exportingPdf"
                                                  Icon="download"
                                                  Text="@(exportingPdf ? "Generare PDF..." : "Descarcă PDF")"
                                                  Style="width: 100%; margin-top: 0.5rem;" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>

                        <!-- Adeverință Student -->
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenCard Variant="Variant.Outlined" Style="padding: 1rem;">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">Adeverință Student</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Document oficial care atestă calitatea de student</RadzenText>

                                    <RadzenFormField Text="Scop adeverință" Variant="Variant.Outlined" Style="width: 100%; margin-top: 0.5rem;">
                                        <RadzenDropDown @bind-Value="certificatePurpose"
                                                        Data="@purposeOptions"
                                                        TextProperty="Text"
                                                        ValueProperty="Value"
                                                        Style="width: 100%;" />
                                    </RadzenFormField>

                                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                                  Click="DownloadAdeverinta"
                                                  IsBusy="@exportingPdf"
                                                  Disabled="@exportingPdf"
                                                  Icon="download"
                                                  Text="@(exportingPdf ? "Generare PDF..." : "Descarcă PDF")"
                                                  Style="width: 100%; margin-top: 0.5rem;" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </RadzenCard>
        }

        <!-- Data Export Section (Secretary, Dean, Admin) -->
        @if (userRole == UserRole.Secretary || userRole == UserRole.Dean || userRole == UserRole.Admin)
        {
            <RadzenCard Style="padding: 1.5rem;">
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="table_chart" Style="color: var(--rz-success);" />
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Export Date (Excel)</RadzenText>
                        @if (userRole == UserRole.Dean && !string.IsNullOrEmpty(facultyName))
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Variant="Variant.Flat" Text="@facultyName" />
                        }
                    </RadzenStack>

                    @if (userRole == UserRole.Dean)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" Size="AlertSize.Small">
                            Exporturile vor conține doar datele facultății dumneavoastră.
                        </RadzenAlert>
                    }

                    <RadzenRow Gap="1rem" RowGap="1rem">
                        <!-- Export Students -->
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard Variant="Variant.Outlined" Style="padding: 1rem;">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">Export Studenți</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@(userRole == UserRole.Dean ? "Studenții din facultatea dumneavoastră" : "Listă completă cu toți studenții înscriși")</RadzenText>
                                    <RadzenButton ButtonStyle="ButtonStyle.Success"
                                                  Click="DownloadStudentsExcel"
                                                  IsBusy="@exportingExcel"
                                                  Disabled="@exportingExcel"
                                                  Icon="download"
                                                  Text="@(exportingExcel ? "Generare Excel..." : "Descarcă Excel")"
                                                  Style="width: 100%; margin-top: 0.5rem;" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>

                        <!-- Export Grades -->
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard Variant="Variant.Outlined" Style="padding: 1rem;">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">Export Note</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Toate notele înregistrate în sistem</RadzenText>
                                    <RadzenButton ButtonStyle="ButtonStyle.Success"
                                                  Click="DownloadGradesExcel"
                                                  IsBusy="@exportingExcel"
                                                  Disabled="@exportingExcel"
                                                  Icon="download"
                                                  Text="@(exportingExcel ? "Generare Excel..." : "Descarcă Excel")"
                                                  Style="width: 100%; margin-top: 0.5rem;" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>

                        <!-- Export Attendance -->
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenCard Variant="Variant.Outlined" Style="padding: 1rem;">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">Export Prezențe</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Istoric complet al prezențelor</RadzenText>
                                    <RadzenButton ButtonStyle="ButtonStyle.Success"
                                                  Click="DownloadAttendanceExcel"
                                                  IsBusy="@exportingExcel"
                                                  Disabled="@exportingExcel"
                                                  Icon="download"
                                                  Text="@(exportingExcel ? "Generare Excel..." : "Descarcă Excel")"
                                                  Style="width: 100%; margin-top: 0.5rem;" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </RadzenCard>
        }

    }
</RadzenStack>

<!-- Success Alert -->
@if (showSuccessToast)
{
    <div style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1050;">
        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Darker">
            @successMessage
        </RadzenAlert>
    </div>
}

<!-- Error Alert -->
@if (showErrorToast)
{
    <div style="position: fixed; bottom: 1rem; right: 1rem; z-index: 1050;">
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Darker">
            @errorMessage
        </RadzenAlert>
    </div>
}

@code {
    private bool isLoading = true;
    private bool exportingPdf = false;
    private bool exportingExcel = false;
    private bool showSuccessToast = false;
    private bool showErrorToast = false;
    private string successMessage = "";
    private string errorMessage = "";

    private UserRole userRole;
    private Guid? currentUserId;
    private Guid? currentFacultyId;
    private string? facultyName;
    private string certificatePurpose = "Bursa";

    private List<PurposeOption> purposeOptions = new()
    {
        new PurposeOption { Value = "Bursa", Text = "Pentru bursă" },
        new PurposeOption { Value = "Angajare", Text = "Pentru angajare" },
        new PurposeOption { Value = "Calatorie", Text = "Pentru călătorie" },
        new PurposeOption { Value = "Altele", Text = "Altele" }
    };

    private class PurposeOption
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var roleClaim = user.FindFirst("Role")?.Value ?? user.FindFirst(ClaimTypes.Role)?.Value;
                if (Enum.TryParse<UserRole>(roleClaim, out var role))
                {
                    userRole = role;
                }

                var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (Guid.TryParse(userIdClaim, out var userId))
                {
                    currentUserId = userId;

                    // Load faculty for Dean
                    if (userRole == UserRole.Dean)
                    {
                        var faculty = await DbContext.Faculties.FirstOrDefaultAsync(f => f.DeanId == userId);
                        if (faculty != null)
                        {
                            currentFacultyId = faculty.Id;
                            facultyName = faculty.Name;
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    // Student Documents
    private async Task DownloadSituatieScolara()
    {
        if (currentUserId == null) return;

        exportingPdf = true;
        StateHasChanged();

        try
        {
            var pdfBytes = await ExportService.ExportSituatieScolara(currentUserId.Value);
            await DownloadFile(pdfBytes, $"Situatie_Scolara_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
            ShowSuccess("Situație școlară generată cu succes!");
        }
        catch (Exception ex)
        {
            ShowError($"Eroare la generarea documentului: {ex.Message}");
        }
        finally
        {
            exportingPdf = false;
            StateHasChanged();
        }
    }

    private async Task DownloadAdeverinta()
    {
        if (currentUserId == null) return;

        exportingPdf = true;
        StateHasChanged();

        try
        {
            var pdfBytes = await ExportService.ExportAdeverintaStudent(currentUserId.Value, certificatePurpose);
            await DownloadFile(pdfBytes, $"Adeverinta_Student_{DateTime.Now:yyyyMMdd}.pdf", "application/pdf");
            ShowSuccess("Adeverință generată cu succes!");
        }
        catch (Exception ex)
        {
            ShowError($"Eroare la generarea adeverinței: {ex.Message}");
        }
        finally
        {
            exportingPdf = false;
            StateHasChanged();
        }
    }

    // Excel Exports
    private async Task DownloadStudentsExcel()
    {
        exportingExcel = true;
        StateHasChanged();

        try
        {
            // Dean exports only their faculty's students
            var facultyFilter = userRole == UserRole.Dean ? currentFacultyId : null;
            var excelBytes = await ExportService.ExportStudentsToExcel(facultyFilter);
            var fileName = userRole == UserRole.Dean && !string.IsNullOrEmpty(facultyName)
                ? $"Studenti_{facultyName.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.xlsx"
                : $"Studenti_{DateTime.Now:yyyyMMdd}.xlsx";
            await DownloadFile(excelBytes, fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            ShowSuccess("Export studenți generat cu succes!");
        }
        catch (Exception ex)
        {
            ShowError($"Eroare la export: {ex.Message}");
        }
        finally
        {
            exportingExcel = false;
            StateHasChanged();
        }
    }

    private async Task DownloadGradesExcel()
    {
        exportingExcel = true;
        StateHasChanged();

        try
        {
            // Note: ExportGradesToExcel doesn't support faculty filter yet
            // TODO: Add faculty filtering support to ExportGradesToExcel if needed
            var excelBytes = await ExportService.ExportGradesToExcel();
            var fileName = userRole == UserRole.Dean && !string.IsNullOrEmpty(facultyName)
                ? $"Note_{facultyName.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.xlsx"
                : $"Note_{DateTime.Now:yyyyMMdd}.xlsx";
            await DownloadFile(excelBytes, fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            ShowSuccess("Export note generat cu succes!");
        }
        catch (Exception ex)
        {
            ShowError($"Eroare la export: {ex.Message}");
        }
        finally
        {
            exportingExcel = false;
            StateHasChanged();
        }
    }

    private async Task DownloadAttendanceExcel()
    {
        exportingExcel = true;
        StateHasChanged();

        try
        {
            // Note: ExportAttendanceToExcel doesn't support faculty filter yet
            // TODO: Add faculty filtering support to ExportAttendanceToExcel if needed
            var excelBytes = await ExportService.ExportAttendanceToExcel();
            var fileName = userRole == UserRole.Dean && !string.IsNullOrEmpty(facultyName)
                ? $"Prezente_{facultyName.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.xlsx"
                : $"Prezente_{DateTime.Now:yyyyMMdd}.xlsx";
            await DownloadFile(excelBytes, fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            ShowSuccess("Export prezențe generat cu succes!");
        }
        catch (Exception ex)
        {
            ShowError($"Eroare la export: {ex.Message}");
        }
        finally
        {
            exportingExcel = false;
            StateHasChanged();
        }
    }

    // Helper Methods
    private async Task DownloadFile(byte[] fileBytes, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JS.InvokeVoidAsync("fileDownload.downloadFromByteArray", fileName, contentType, base64);
    }

    private void ShowSuccess(string message)
    {
        successMessage = message;
        showSuccessToast = true;
        StateHasChanged();

        Task.Delay(3000).ContinueWith(_ =>
        {
            showSuccessToast = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private void ShowError(string message)
    {
        errorMessage = message;
        showErrorToast = true;
        StateHasChanged();

        Task.Delay(5000).ContinueWith(_ =>
        {
            showErrorToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
