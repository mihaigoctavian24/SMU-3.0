@page "/studenti/nou"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data
@using SMU.Data.Entities
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Policy = "CanManageStudents")]
@inject IStudentService StudentService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Student Nou - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 800px; margin: 0 auto;">
    <!-- Header -->
    <RadzenStack Gap="0.5rem">
        <RadzenButton Text="Înapoi la Studenți" Icon="arrow_back" Variant="Variant.Text"
                      ButtonStyle="ButtonStyle.Secondary" Click="@(() => Navigation.NavigateTo("/studenti"))"
                      Style="align-self: flex-start; margin-bottom: 0.5rem;" />
        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Adaugă Student Nou</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
            Completează informațiile pentru a crea un nou student
        </RadzenText>
    </RadzenStack>

    <!-- Form Card -->
    <RadzenCard>
        <RadzenTemplateForm TItem="CreateStudentDto" Data="@model" Submit="@HandleSubmit">
            <RadzenStack Gap="1.5rem">
                <!-- Email -->
                <RadzenFormField Text="Email" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="model.Email" Placeholder="student@example.com" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        @if (validationErrors.ContainsKey(nameof(model.Email)))
                        {
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-danger" Style="margin: 0;">
                                @validationErrors[nameof(model.Email)]
                            </RadzenText>
                        }
                    </Helper>
                </RadzenFormField>

                <!-- First Name & Last Name -->
                <RadzenRow Gap="1rem" RowGap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Prenume" Variant="Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox @bind-Value="model.FirstName" Placeholder="Ion" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                @if (validationErrors.ContainsKey(nameof(model.FirstName)))
                                {
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-danger" Style="margin: 0;">
                                        @validationErrors[nameof(model.FirstName)]
                                    </RadzenText>
                                }
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Nume" Variant="Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenTextBox @bind-Value="model.LastName" Placeholder="Popescu" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                @if (validationErrors.ContainsKey(nameof(model.LastName)))
                                {
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-danger" Style="margin: 0;">
                                        @validationErrors[nameof(model.LastName)]
                                    </RadzenText>
                                }
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Group -->
                <RadzenFormField Text="Grupă" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="model.GroupId" Data="@groups" TextProperty="DisplayName"
                                        ValueProperty="Id" Placeholder="Selectează grupa" Style="width: 100%;"
                                        AllowClear="false" />
                    </ChildContent>
                    <Helper>
                        @if (validationErrors.ContainsKey(nameof(model.GroupId)))
                        {
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-danger" Style="margin: 0;">
                                @validationErrors[nameof(model.GroupId)]
                            </RadzenText>
                        }
                    </Helper>
                </RadzenFormField>

                <!-- Enrollment Date & Scholarship -->
                <RadzenRow Gap="1rem" RowGap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Data Înscrierii" />
                            <RadzenDatePicker @bind-Value="enrollmentDate" DateFormat="dd.MM.yyyy" Style="width: 100%;" />
                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack JustifyContent="JustifyContent.End" Style="height: 100%;">
                            <RadzenCheckBox @bind-Value="model.ScholarshipHolder" Name="scholarshipHolder" />
                            <RadzenLabel Text="Bursier" Component="scholarshipHolder" Style="margin-left: 0.5rem;" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Info Alert -->
                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" ShowIcon="true">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; font-weight: 600;">
                            Notă Importantă
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Un cont de utilizator va fi creat automat cu parola inițială: <strong>Student123!</strong><br />
                            Studentul va primi un email cu instrucțiuni de conectare.
                        </RadzenText>
                    </RadzenStack>
                </RadzenAlert>

                <!-- Error Message -->
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true">
                        @errorMessage
                    </RadzenAlert>
                }

                <!-- Success Message -->
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" ShowIcon="true">
                        @successMessage
                    </RadzenAlert>
                }

                <!-- Actions -->
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End"
                             Style="padding-top: 1rem; border-top: 1px solid var(--rz-base-300);">
                    <RadzenButton Text="Anulează" Variant="Variant.Outlined" ButtonStyle="ButtonStyle.Secondary"
                                  Click="@(() => Navigation.NavigateTo("/studenti"))" />
                    <RadzenButton Text="Salvează Student" Icon="save" ButtonType="ButtonType.Submit"
                                  ButtonStyle="ButtonStyle.Primary" Disabled="@isSubmitting" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>
</RadzenStack>

@code {
    private CreateStudentDto model = new() { EnrollmentDate = DateOnly.FromDateTime(DateTime.Now) };
    private DateTime enrollmentDate = DateTime.Now;
    private List<GroupDto> groups = new();
    private Dictionary<string, string> validationErrors = new();
    private bool isSubmitting = false;
    private string errorMessage = "";
    private string successMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadGroups();
    }

    protected override void OnParametersSet()
    {
        enrollmentDate = model.EnrollmentDate.ToDateTime(TimeOnly.MinValue);
    }

    private async Task LoadGroups()
    {
        var groupsList = await DbContext.Groups
            .Include(g => g.Program)
            .Where(g => g.IsActive)
            .OrderBy(g => g.Program.Name)
            .ThenBy(g => g.Year)
            .ThenBy(g => g.Name)
            .Select(g => new GroupDto
            {
                Id = g.Id,
                Name = g.Name,
                Year = g.Year,
                ProgramName = g.Program.Name
            })
            .ToListAsync();

        groups = groupsList;
    }

    private async Task HandleSubmit()
    {
        validationErrors.Clear();
        errorMessage = "";
        successMessage = "";

        // Sync enrollment date
        model.EnrollmentDate = DateOnly.FromDateTime(enrollmentDate);

        // Validate
        if (string.IsNullOrWhiteSpace(model.Email))
        {
            validationErrors[nameof(model.Email)] = "Email-ul este obligatoriu";
        }
        else if (!IsValidEmail(model.Email))
        {
            validationErrors[nameof(model.Email)] = "Email-ul nu este valid";
        }

        if (string.IsNullOrWhiteSpace(model.FirstName))
        {
            validationErrors[nameof(model.FirstName)] = "Prenumele este obligatoriu";
        }

        if (string.IsNullOrWhiteSpace(model.LastName))
        {
            validationErrors[nameof(model.LastName)] = "Numele este obligatoriu";
        }

        if (model.GroupId == Guid.Empty)
        {
            validationErrors[nameof(model.GroupId)] = "Selectați o grupă";
        }

        if (validationErrors.Any())
        {
            return;
        }

        isSubmitting = true;
        StateHasChanged();

        var result = await StudentService.CreateAsync(model);

        isSubmitting = false;

        if (result.Succeeded)
        {
            RadzenNotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succes",
                Detail = "Student creat cu succes!",
                Duration = 4000
            });
            await Task.Delay(1500);
            Navigation.NavigateTo($"/studenti/{result.Data}");
        }
        else
        {
            errorMessage = result.ErrorMessage ?? "Eroare la crearea studentului";
            StateHasChanged();
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private class GroupDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public int Year { get; set; }
        public string ProgramName { get; set; } = "";
        public string DisplayName => $"{Name} - {ProgramName} (An {Year})";
    }
}
