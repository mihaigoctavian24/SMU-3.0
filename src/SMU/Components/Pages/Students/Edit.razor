@page "/studenti/{id:guid}/editare"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data
@using SMU.Data.Entities
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Policy = "CanManageStudents")]
@inject IStudentService StudentService
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Editare Student - SMU</PageTitle>

@if (isLoading)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
    </RadzenStack>
}
else if (student == null)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem" Style="padding: 3rem 0;">
        <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
            Studentul nu a fost găsit
        </RadzenText>
        <RadzenButton Text="Înapoi la Studenți" ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/studenti"))" />
    </RadzenStack>
}
else
{
    <RadzenStack Gap="1.5rem" Style="max-width: 800px; margin: 0 auto;">
        <!-- Header -->
        <RadzenStack Gap="0.5rem">
            <RadzenButton Text="Înapoi la Detalii" Icon="arrow_back" Variant="Variant.Text"
                          ButtonStyle="ButtonStyle.Secondary" Click="@(() => Navigation.NavigateTo($"/studenti/{Id}"))"
                          Style="align-self: flex-start; margin-bottom: 0.5rem;" />
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Editare Student</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Modifică informațiile studentului @student.FullName
            </RadzenText>
        </RadzenStack>

        <!-- Form Card -->
        <RadzenCard>
            <RadzenTemplateForm TItem="UpdateStudentDto" Data="@model" Submit="@HandleSubmit">
                <RadzenStack Gap="1.5rem">
                    <!-- Non-editable Info -->
                    <RadzenCard Style="background-color: var(--rz-base-100); padding: 1rem;">
                        <RadzenRow Gap="1rem" RowGap="0.75rem">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Email</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@student.Email</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Nr. Matricol</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@student.StudentNumber</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Data Înscrierii</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@student.EnrollmentDate.ToString("dd.MM.yyyy")</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenCard>

                    <!-- First Name & Last Name -->
                    <RadzenRow Gap="1rem" RowGap="1rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Prenume" Variant="Variant.Outlined" Style="width: 100%;">
                                <RadzenTextBox @bind-Value="model.FirstName" Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Nume" Variant="Variant.Outlined" Style="width: 100%;">
                                <RadzenTextBox @bind-Value="model.LastName" Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Group -->
                    <RadzenFormField Text="Grupă" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="selectedGroupId" Data="@groups" TextProperty="DisplayName"
                                        ValueProperty="IdString" Placeholder="Neasignat" Style="width: 100%;"
                                        AllowClear="true" />
                    </RadzenFormField>

                    <!-- Status & Scholarship -->
                    <RadzenRow Gap="1rem" RowGap="1rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                                <RadzenDropDown @bind-Value="model.Status" Data="@statusOptions" TextProperty="Text"
                                                ValueProperty="Value" Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>

                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenStack JustifyContent="JustifyContent.End" Style="height: 100%;">
                                <RadzenCheckBox @bind-Value="model.ScholarshipHolder" Name="scholarshipHolder" />
                                <RadzenLabel Text="Bursier" Component="scholarshipHolder" Style="margin-left: 0.5rem;" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Error Message -->
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true">
                            @errorMessage
                        </RadzenAlert>
                    }

                    <!-- Success Message -->
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" ShowIcon="true">
                            @successMessage
                        </RadzenAlert>
                    }

                    <!-- Actions -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End"
                                 Style="padding-top: 1rem; border-top: 1px solid var(--rz-base-300);">
                        <RadzenButton Text="Anulează" Variant="Variant.Outlined" ButtonStyle="ButtonStyle.Secondary"
                                      Click="@(() => Navigation.NavigateTo($"/studenti/{Id}"))" />
                        <RadzenButton Text="Salvează Modificările" Icon="save" ButtonType="ButtonType.Submit"
                                      ButtonStyle="ButtonStyle.Primary" Disabled="@isSubmitting" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenCard>
    </RadzenStack>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private StudentDetailDto? student;
    private UpdateStudentDto model = new();
    private string selectedGroupId = "";
    private List<GroupDto> groups = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string errorMessage = "";
    private string successMessage = "";

    private List<dynamic> statusOptions = new List<dynamic>
    {
        new { Text = "Activ", Value = StudentStatus.Active },
        new { Text = "Inactiv", Value = StudentStatus.Inactive },
        new { Text = "Absolvent", Value = StudentStatus.Graduated },
        new { Text = "Suspendat", Value = StudentStatus.Suspended },
        new { Text = "Exmatriculat", Value = StudentStatus.Expelled }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadStudent();
        await LoadGroups();
    }

    private async Task LoadStudent()
    {
        isLoading = true;
        student = await StudentService.GetByIdAsync(Id);

        if (student != null)
        {
            model = new UpdateStudentDto
            {
                FirstName = student.FirstName,
                LastName = student.LastName,
                GroupId = student.GroupId,
                ScholarshipHolder = student.ScholarshipHolder,
                Status = student.Status
            };
            selectedGroupId = student.GroupId?.ToString() ?? "";
        }

        isLoading = false;
    }

    private async Task LoadGroups()
    {
        var groupsList = await DbContext.Groups
            .Include(g => g.Program)
            .Where(g => g.IsActive)
            .OrderBy(g => g.Program.Name)
            .ThenBy(g => g.Year)
            .ThenBy(g => g.Name)
            .Select(g => new GroupDto
            {
                Id = g.Id,
                Name = g.Name,
                Year = g.Year,
                ProgramName = g.Program.Name
            })
            .ToListAsync();

        groups = groupsList;
    }

    private async Task HandleSubmit()
    {
        errorMessage = "";
        successMessage = "";

        // Parse selected group
        if (Guid.TryParse(selectedGroupId, out var groupId))
        {
            model.GroupId = groupId;
        }
        else
        {
            model.GroupId = null;
        }

        isSubmitting = true;
        StateHasChanged();

        var result = await StudentService.UpdateAsync(Id, model);

        isSubmitting = false;

        if (result.Succeeded)
        {
            RadzenNotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succes",
                Detail = "Student actualizat cu succes!",
                Duration = 4000
            });
            await Task.Delay(1500);
            Navigation.NavigateTo($"/studenti/{Id}");
        }
        else
        {
            errorMessage = result.ErrorMessage ?? "Eroare la actualizarea studentului";
            StateHasChanged();
        }
    }

    private class GroupDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public int Year { get; set; }
        public string ProgramName { get; set; } = "";
        public string DisplayName => $"{Name} - {ProgramName} (An {Year})";
        public string IdString => Id.ToString();
    }
}
