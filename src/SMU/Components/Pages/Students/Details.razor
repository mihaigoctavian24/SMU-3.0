@page "/studenti/{id:guid}"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageStudents")]
@inject IStudentService StudentService
@inject NavigationManager Navigation

<PageTitle>Detalii Student - SMU</PageTitle>

@if (isLoading)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
    </RadzenStack>
}
else if (student == null)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem" Style="padding: 3rem 0;">
        <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
            Studentul nu a fost găsit
        </RadzenText>
        <RadzenButton Text="Înapoi la Studenți" ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/studenti"))" />
    </RadzenStack>
}
else
{
    <RadzenStack Gap="1.5rem">
        <!-- Header -->
        <RadzenStack Gap="0.5rem">
            <RadzenButton Text="Înapoi la Studenți" Icon="arrow_back" Variant="Variant.Text"
                          ButtonStyle="ButtonStyle.Secondary" Click="@(() => Navigation.NavigateTo("/studenti"))"
                          Style="align-self: flex-start; margin-bottom: 0.5rem;" />
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Detalii Student</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                        Informații complete despre student
                    </RadzenText>
                </RadzenStack>
                <RadzenButton Text="Editează" Icon="edit" ButtonStyle="ButtonStyle.Primary"
                              Click="@(() => Navigation.NavigateTo($"/studenti/{Id}/editare"))" />
            </RadzenStack>
        </RadzenStack>

        <!-- Student Info Card -->
        <RadzenCard>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1.5rem" AlignItems="AlignItems.Start">
                <!-- Profile Photo -->
                @if (!string.IsNullOrEmpty(student.ProfileImageUrl))
                {
                    <RadzenImage Path="@student.ProfileImageUrl" AlternateText="@student.FullName"
                                 Style="width: 96px; height: 96px; border-radius: 50%; object-fit: cover;" />
                }
                else
                {
                    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                                 Style="width: 96px; height: 96px; border-radius: 50%; background-color: var(--rz-primary-lighter);">
                        <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; color: var(--rz-primary); font-weight: 700;">
                            @GetInitials(student.FullName)
                        </RadzenText>
                    </RadzenStack>
                }

                <!-- Info Columns -->
                <RadzenRow Style="flex: 1;" Gap="1.5rem" RowGap="1.5rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">@student.FullName</RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Email</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@student.Email</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Nr. Matricol</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-family: monospace;">@student.StudentNumber</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Status</RadzenText>
                                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(student.Status)" Text="@GetStatusText(student.Status)" IsPill="true" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0 0 1rem 0; font-weight: 600;">Informații Academice</RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Facultate</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@student.FacultyName</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Program</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@student.ProgramName</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Grupă</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@student.GroupName (An @student.Year)</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Data Înscrierii</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@student.EnrollmentDate.ToString("dd.MM.yyyy")</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Bursă</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@(student.ScholarshipHolder ? "Da" : "Nu")</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenCard>

        <!-- Quick Stats -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Average Grade -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                                     Style="width: 48px; height: 48px; border-radius: 8px; background-color: var(--rz-success-lighter);">
                            <RadzenIcon Icon="verified" Style="color: var(--rz-success); font-size: 24px;" />
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem" Style="flex: 1;">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Medie Generală</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">
                                @(student.AverageGrade.HasValue ? student.AverageGrade.Value.ToString("0.00") : "N/A")
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Attendance Rate -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                                     Style="width: 48px; height: 48px; border-radius: 8px; background-color: var(--rz-primary-lighter);">
                            <RadzenIcon Icon="assignment" Style="color: var(--rz-primary); font-size: 24px;" />
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem" Style="flex: 1;">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Rată Prezență</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@student.AttendanceRate.ToString("0")%</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Credits -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                                     Style="width: 48px; height: 48px; border-radius: 8px; background-color: var(--rz-info-lighter);">
                            <RadzenIcon Icon="menu_book" Style="color: var(--rz-info); font-size: 24px;" />
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem" Style="flex: 1;">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Credite</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@student.TotalCredits</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Grades Count -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                                     Style="width: 48px; height: 48px; border-radius: 8px; background-color: var(--rz-warning-lighter);">
                            <RadzenIcon Icon="bar_chart" Style="color: var(--rz-warning); font-size: 24px;" />
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem" Style="flex: 1;">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Note</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@student.GradesCount</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Quick Actions -->
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Acțiuni Rapide</RadzenText>
            <RadzenRow Gap="1rem" RowGap="1rem">
                <RadzenColumn Size="6" SizeMD="3">
                    <RadzenButton Text="Editează" Icon="edit" Variant="Variant.Outlined" Style="width: 100%; height: 100%; min-height: 80px;"
                                  Click="@(() => Navigation.NavigateTo($"/studenti/{Id}/editare"))" />
                </RadzenColumn>
                <RadzenColumn Size="6" SizeMD="3">
                    <RadzenButton Text="Transfer Grupă" Icon="swap_horiz" Variant="Variant.Outlined" Style="width: 100%; height: 100%; min-height: 80px;"
                                  Click="@NavigateToTransfer" />
                </RadzenColumn>
                <RadzenColumn Size="6" SizeMD="3">
                    <RadzenButton Text="Vezi Note" Icon="verified" Variant="Variant.Outlined" Style="width: 100%; height: 100%; min-height: 80px;"
                                  Click="@NavigateToGrades" />
                </RadzenColumn>
                <RadzenColumn Size="6" SizeMD="3">
                    <RadzenButton Text="Vezi Prezențe" Icon="assignment" Variant="Variant.Outlined" Style="width: 100%; height: 100%; min-height: 80px;"
                                  Click="@NavigateToAttendance" />
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    </RadzenStack>
}

@code {
    [Parameter] public Guid Id { get; set; }

    private StudentDetailDto? student;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudent();
    }

    private async Task LoadStudent()
    {
        isLoading = true;
        student = await StudentService.GetByIdAsync(Id);
        isLoading = false;
    }

    private string GetInitials(string fullName)
    {
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        }
        return fullName.Length > 0 ? fullName.Substring(0, Math.Min(2, fullName.Length)).ToUpper() : "??";
    }

    private BadgeStyle GetStatusBadgeStyle(StudentStatus status) => status switch
    {
        StudentStatus.Active => BadgeStyle.Success,
        StudentStatus.Inactive => BadgeStyle.Light,
        StudentStatus.Graduated => BadgeStyle.Info,
        StudentStatus.Suspended => BadgeStyle.Warning,
        StudentStatus.Expelled => BadgeStyle.Danger,
        _ => BadgeStyle.Light
    };

    private string GetStatusText(StudentStatus status) => status switch
    {
        StudentStatus.Active => "Activ",
        StudentStatus.Inactive => "Inactiv",
        StudentStatus.Graduated => "Absolvent",
        StudentStatus.Suspended => "Suspendat",
        StudentStatus.Expelled => "Exmatriculat",
        _ => status.ToString()
    };

    private void NavigateToTransfer() => Navigation.NavigateTo($"/studenti/{Id}/transfer");
    private void NavigateToGrades() => Navigation.NavigateTo($"/note?studentId={Id}");
    private void NavigateToAttendance() => Navigation.NavigateTo($"/prezente?studentId={Id}");
}
