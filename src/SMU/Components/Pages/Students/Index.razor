@page "/studenti"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageStudents")]
@inject IStudentService StudentService
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Studenți - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Studenți</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Gestionează studenții înscriși în universitate
            </RadzenText>
        </RadzenStack>
        <RadzenButton Text="Adaugă Student" Icon="add" ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/studenti/nou"))" />
    </RadzenStack>

    <!-- Filters & Search -->
    <RadzenCard>
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="5">
                <RadzenFormField Text="Căutare" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="searchTerm" Placeholder="Nume, email sau nr. matricol..."
                                   @oninput="OnSearchChanged" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Status Filter -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedStatus" Data="@statusOptions" TextProperty="Text" ValueProperty="Value"
                                    Placeholder="Toate statusurile" Change="@(args => ApplyFilters())" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Page Size -->
            <RadzenColumn Size="6" SizeMD="2">
                <RadzenFormField Text="Afișează" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="pageSize" Data="@pageSizeOptions"
                                    Change="@(args => ApplyFilters())" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Export -->
            <RadzenColumn Size="6" SizeMD="2">
                <RadzenStack Style="height: 100%;" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Export CSV" Icon="download" Variant="Variant.Outlined"
                                  Click="@ExportToCSV" Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Students Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </RadzenStack>
        }
        else
        {
            <RadzenDataGrid @ref="grid" Data="@students.Items" TItem="StudentListDto"
                            AllowSorting="true" AllowPaging="false"
                            Style="border: none;">
                <Columns>
                    <RadzenDataGridColumn TItem="StudentListDto" Property="StudentNumber" Title="Nr. Matricol" Width="130px"
                                          Sortable="true" />
                    <RadzenDataGridColumn TItem="StudentListDto" Property="FullName" Title="Nume" Sortable="true">
                        <Template Context="student">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@student.FullName</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="StudentListDto" Property="Email" Title="Email" />
                    <RadzenDataGridColumn TItem="StudentListDto" Property="GroupName" Title="Grupă" Width="100px" />
                    <RadzenDataGridColumn TItem="StudentListDto" Property="ProgramName" Title="Program" />
                    <RadzenDataGridColumn TItem="StudentListDto" Property="Status" Title="Status" Width="120px">
                        <Template Context="student">
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(student.Status)" Text="@GetStatusText(student.Status)" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="StudentListDto" Title="Acțiuni" Width="160px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="student">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" JustifyContent="JustifyContent.End">
                                <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Info" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/studenti/{student.Id}"))"
                                              MouseEnter="@(args => ShowTooltip(args, "Vezi detalii"))" />
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/studenti/{student.Id}/editare"))"
                                              MouseEnter="@(args => ShowTooltip(args, "Editează"))" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => ConfirmDelete(student))"
                                              MouseEnter="@(args => ShowTooltip(args, "Șterge"))" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <!-- Pagination -->
            @if (students.TotalCount > 0)
            {
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                             Class="rz-p-4" Style="border-top: 1px solid var(--rz-base-300);">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                        Afișează @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, students.TotalCount) din @students.TotalCount studenți
                    </RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                        <RadzenButton Text="Anterior" Icon="chevron_left" Variant="Variant.Outlined" Size="ButtonSize.Small"
                                      Disabled="@(!students.HasPreviousPage)" Click="@PreviousPage" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Pagina @students.Page din @students.TotalPages
                        </RadzenText>
                        <RadzenButton Text="Următorul" Icon="chevron_right" Variant="Variant.Outlined" Size="ButtonSize.Small"
                                      Disabled="@(!students.HasNextPage)" Click="@NextPage" />
                    </RadzenStack>
                </RadzenStack>
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="1rem">
                    <RadzenIcon Icon="school" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
                        Nu au fost găsiți studenți
                    </RadzenText>
                </RadzenStack>
            }
        }
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenDataGrid<StudentListDto>? grid;
    private PagedResult<StudentListDto> students = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = "";
    private string? selectedStatus;
    private int currentPage = 1;
    private int pageSize = 25;

    // Filter options
    private List<dynamic> statusOptions = new List<dynamic>
    {
        new { Text = "Toate statusurile", Value = (string?)null },
        new { Text = "Activ", Value = "Active" },
        new { Text = "Inactiv", Value = "Inactive" },
        new { Text = "Absolvent", Value = "Graduated" },
        new { Text = "Suspendat", Value = "Suspended" },
        new { Text = "Exmatriculat", Value = "Expelled" }
    };

    private List<int> pageSizeOptions = new List<int> { 10, 25, 50 };

    // Search debounce
    private System.Threading.Timer? searchTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudents();
    }

    private async Task LoadStudents()
    {
        isLoading = true;
        StateHasChanged();

        var filter = new StudentFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            Status = string.IsNullOrWhiteSpace(selectedStatus) ? null : Enum.Parse<StudentStatus>(selectedStatus)
        };

        students = await StudentService.GetAllAsync(filter, currentPage, pageSize);

        isLoading = false;
        StateHasChanged();
    }

    private void OnSearchChanged(ChangeEventArgs args)
    {
        searchTerm = args.Value?.ToString() ?? "";
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () =>
            {
                await LoadStudents();
                StateHasChanged();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadStudents();
    }

    private async Task NextPage()
    {
        if (students.HasNextPage)
        {
            currentPage++;
            await LoadStudents();
        }
    }

    private async Task PreviousPage()
    {
        if (students.HasPreviousPage)
        {
            currentPage--;
            await LoadStudents();
        }
    }

    private async Task ConfirmDelete(StudentListDto student)
    {
        var result = await DialogService.Confirm(
            $"Ești sigur că vrei să ștergi studentul {student.FullName}? Statusul va fi schimbat în \"Inactiv\".",
            "Confirmare Ștergere",
            new ConfirmOptions
            {
                OkButtonText = "Șterge",
                CancelButtonText = "Anulează"
            });

        if (result == true)
        {
            var deleteResult = await StudentService.DeleteAsync(student.Id);
            if (deleteResult.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Studentul a fost șters cu succes.",
                    Duration = 4000
                });
                await LoadStudents();
            }
            else
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = deleteResult.ErrorMessage ?? "Nu s-a putut șterge studentul.",
                    Duration = 4000
                });
            }
        }
    }

    private async Task ExportToCSV()
    {
        var filter = new StudentFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            Status = string.IsNullOrWhiteSpace(selectedStatus) ? null : Enum.Parse<StudentStatus>(selectedStatus)
        };

        var allStudents = await StudentService.ExportAsync(filter);

        RadzenNotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Info,
            Summary = "Export CSV",
            Detail = $"Exportat {allStudents.Count} studenți.",
            Duration = 4000
        });
    }

    private void ShowTooltip(ElementReference elementReference, string text)
    {
        // Tooltip functionality - could be enhanced
    }

    private BadgeStyle GetStatusBadgeStyle(StudentStatus status) => status switch
    {
        StudentStatus.Active => BadgeStyle.Success,
        StudentStatus.Inactive => BadgeStyle.Light,
        StudentStatus.Graduated => BadgeStyle.Info,
        StudentStatus.Suspended => BadgeStyle.Warning,
        StudentStatus.Expelled => BadgeStyle.Danger,
        _ => BadgeStyle.Light
    };

    private string GetStatusText(StudentStatus status) => status switch
    {
        StudentStatus.Active => "Activ",
        StudentStatus.Inactive => "Inactiv",
        StudentStatus.Graduated => "Absolvent",
        StudentStatus.Suspended => "Suspendat",
        StudentStatus.Expelled => "Exmatriculat",
        _ => status.ToString()
    };

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}
