@page "/orar"
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IScheduleService ScheduleService
@inject AuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]

<PageTitle>Orar - SMU</PageTitle>

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Orar</h1>
            <p class="mt-1 text-sm text-gray-600">
                @if (currentUserRole == UserRole.Student)
                {
                    <text>Orarul tău săptămânal</text>
                }
                else if (currentUserRole == UserRole.Professor)
                {
                    <text>Orarul cursurilor tale</text>
                }
                else
                {
                    <text>Orarul săptămânal al grupelor</text>
                }
            </p>
        </div>
        @if (currentUserRole == UserRole.Secretary || currentUserRole == UserRole.Admin)
        {
            <a href="/orar/gestionare" class="btn btn-primary">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Gestionează Orar
            </a>
        }
    </div>

    @if (isLoading)
    {
        <div class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
        </div>
    }
    else
    {
        <!-- Weekly Schedule Grid -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <div class="inline-block min-w-full align-middle">
                    <div class="grid" style="grid-template-columns: 80px repeat(5, minmax(150px, 1fr));">
                        <!-- Header Row -->
                        <div class="bg-gray-50 border-b border-r border-gray-200 p-3 font-medium text-xs text-gray-500"></div>
                        @foreach (var day in weeklySchedule)
                        {
                            <div class="bg-gray-50 border-b border-r last:border-r-0 border-gray-200 p-3">
                                <div class="font-semibold text-sm text-gray-900">@day.DayName</div>
                            </div>
                        }

                        <!-- Time Slots (08:00 - 20:00) -->
                        @for (int hour = 8; hour <= 20; hour++)
                        {
                            <!-- Time Label -->
                            <div class="border-b border-r border-gray-200 p-2 text-xs text-gray-500 text-center">
                                @($"{hour:00}:00")
                            </div>

                            <!-- Day Cells -->
                            @foreach (var day in weeklySchedule)
                            {
                                <div class="border-b border-r last:border-r-0 border-gray-200 p-1 min-h-[60px] relative">
                                    @{
                                        var entriesInSlot = day.Entries
                                            .Where(e => e.StartTime.Hour <= hour && e.EndTime.Hour > hour)
                                            .ToList();
                                    }
                                    @foreach (var entry in entriesInSlot)
                                    {
                                        var startHour = entry.StartTime.Hour;
                                        var endHour = entry.EndTime.Hour;
                                        var duration = endHour - startHour;
                                        var isFirstSlot = startHour == hour;

                                        @if (isFirstSlot)
                                        {
                                            <div class="@GetScheduleCardClass(entry.Type) rounded-lg p-2 text-xs mb-1"
                                                 style="@($"min-height: {duration * 60 - 4}px;")">
                                                <div class="font-semibold text-gray-900 mb-1">@entry.CourseName</div>
                                                <div class="text-gray-600 text-[10px] space-y-0.5">
                                                    <div>@entry.StartTime.ToString(@"hh\:mm") - @entry.EndTime.ToString(@"hh\:mm")</div>
                                                    @if (!string.IsNullOrEmpty(entry.Room))
                                                    {
                                                        <div>Sala: @entry.Room</div>
                                                    }
                                                    <div class="font-medium">@entry.TypeLabel</div>
                                                    @if (currentUserRole != UserRole.Student)
                                                    {
                                                        <div class="mt-1 pt-1 border-t border-gray-300">
                                                            Grupa: @entry.GroupName
                                                        </div>
                                                    }
                                                    @if (currentUserRole != UserRole.Professor && !string.IsNullOrEmpty(entry.ProfessorName))
                                                    {
                                                        <div>Prof: @entry.ProfessorName</div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>

        @if (!weeklySchedule.Any(d => d.Entries.Any()))
        {
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                <svg class="w-12 h-12 text-yellow-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="text-sm text-yellow-800">
                    @if (currentUserRole == UserRole.Student)
                    {
                        <text>Nu există orar configurat pentru grupa ta.</text>
                    }
                    else if (currentUserRole == UserRole.Professor)
                    {
                        <text>Nu ai cursuri programate în acest moment.</text>
                    }
                    else
                    {
                        <text>Nu există intrări în orar. Poți adăuga intrări din pagina de gestionare.</text>
                    }
                </p>
            </div>
        }
    }
</div>

@code {
    private bool isLoading = true;
    private UserRole? currentUserRole;
    private Guid? currentUserId;
    private Guid? currentStudentId;
    private Guid? currentProfessorId;

    private List<WeeklyScheduleDto> weeklySchedule = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await AuthService.GetCurrentUserAsync(user);
            if (appUser != null)
            {
                currentUserRole = appUser.Role;
                currentUserId = appUser.Id;

                if (currentUserRole == UserRole.Student)
                {
                    currentStudentId = appUser.Student?.Id;
                    if (currentStudentId.HasValue)
                    {
                        weeklySchedule = await ScheduleService.GetWeeklyScheduleByStudentAsync(currentStudentId.Value);
                    }
                }
                else if (currentUserRole == UserRole.Professor)
                {
                    currentProfessorId = appUser.Professor?.Id;
                    if (currentProfessorId.HasValue)
                    {
                        weeklySchedule = await ScheduleService.GetWeeklyScheduleByProfessorAsync(currentProfessorId.Value);
                    }
                }
            }
        }

        isLoading = false;
    }

    private string GetScheduleCardClass(string type)
    {
        return type switch
        {
            "Curs" => "bg-blue-50 border border-blue-200",
            "Seminar" => "bg-green-50 border border-green-200",
            "Laborator" => "bg-purple-50 border border-purple-200",
            _ => "bg-gray-50 border border-gray-200"
        };
    }
}
