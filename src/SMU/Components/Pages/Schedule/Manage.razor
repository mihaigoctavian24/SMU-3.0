@page "/orar/gestionare"
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@using Microsoft.AspNetCore.Authorization
@inject IScheduleService ScheduleService
@inject NavigationManager Navigation
@inject Radzen.DialogService DialogService
@attribute [Authorize(Policy = "CanManageStudents")]

<PageTitle>Gestionare Orar - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Gestionare Orar</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Adaugă, editează sau șterge intrări în orar</RadzenText>
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem">
            <RadzenButton Text="Înapoi la Orar"
                          Icon="arrow_back"
                          ButtonStyle="ButtonStyle.Light"
                          Click="@(() => Navigation.NavigateTo("/orar"))" />
            <RadzenButton Text="Adaugă Intrare"
                          Icon="add"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@ShowAddForm" />
        </RadzenStack>
    </RadzenStack>

    <!-- Filter Section -->
    <RadzenCard Style="padding: 1.5rem;">
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Grupă" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedGroupId"
                                    Data="@groups"
                                    TextProperty="DisplayName"
                                    ValueProperty="IdString"
                                    AllowClear="true"
                                    Placeholder="Selectează grupa"
                                    Change="@(args => LoadScheduleEntries())"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Schedule Entries List -->
    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (!string.IsNullOrEmpty(selectedGroupId))
    {
        <RadzenCard Style="padding: 0; overflow: hidden;">
            @if (!scheduleEntries.Any())
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                    <RadzenIcon Icon="event_busy" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: var(--rz-text-secondary-color);">
                        Nu există intrări în orar pentru grupa selectată.
                    </RadzenText>
                </RadzenStack>
            }
            else
            {
                <RadzenDataGrid Data="@scheduleEntries.OrderBy(e => e.DayOfWeek).ThenBy(e => e.StartTime)" TItem="ScheduleEntryDto" Style="border: none;">
                    <Columns>
                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Property="DayName" Title="Zi" Width="100px">
                            <Template Context="entry">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@entry.DayName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Title="Oră" Width="140px">
                            <Template Context="entry">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                    @entry.StartTime.ToString(@"hh\:mm") - @entry.EndTime.ToString(@"hh\:mm")
                                </RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Property="CourseName" Title="Curs">
                            <Template Context="entry">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@entry.CourseName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Property="Type" Title="Tip" Width="120px">
                            <Template Context="entry">
                                <RadzenBadge BadgeStyle="@GetTypeBadgeStyle(entry.Type)"
                                             Text="@entry.TypeLabel"
                                             IsPill="true" />
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Property="Room" Title="Sală" Width="100px">
                            <Template Context="entry">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@(entry.Room ?? "-")</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Property="ProfessorName" Title="Profesor">
                            <Template Context="entry">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@entry.ProfessorName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="ScheduleEntryDto" Title="Acțiuni" Width="150px" TextAlign="TextAlign.End">
                            <Template Context="entry">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                                    <RadzenButton Icon="edit"
                                                  ButtonStyle="ButtonStyle.Light"
                                                  Variant="Variant.Text"
                                                  Size="ButtonSize.Small"
                                                  Click="@(() => ShowEditForm(entry))"
                                                  title="Editează" />
                                    <RadzenButton Icon="delete"
                                                  ButtonStyle="ButtonStyle.Danger"
                                                  Variant="Variant.Text"
                                                  Size="ButtonSize.Small"
                                                  Click="@(() => DeleteEntry(entry.Id))"
                                                  title="Șterge" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </RadzenCard>
    }
    else
    {
        <RadzenCard Style="padding: 2rem; text-align: center;">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.75rem">
                <RadzenIcon Icon="event" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">
                    Selectează o grupă pentru a vizualiza și gestiona intrările în orar
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

<!-- Add/Edit Dialog -->
<RadzenDialog />

@code {
    private bool isLoading = true;
    private bool isSaving = false;
    private string selectedGroupId = "";
    private string errorMessage = "";
    private string conflictMessage = "";

    private List<GroupOptionDisplay> groups = new();
    private List<CourseOptionDto> courses = new();
    private List<ScheduleEntryDto> scheduleEntries = new();

    private ScheduleEntryDto? editingEntry;
    private CreateScheduleEntryDto formDto = new();
    private string formDayOfWeek = "1";
    private string formStartTime = "08:00";
    private string formEndTime = "10:00";

    protected override async Task OnInitializedAsync()
    {
        var groupsList = await ScheduleService.GetGroupOptionsAsync();
        groups = groupsList.Select(g => new GroupOptionDisplay
        {
            Id = g.Id,
            IdString = g.Id.ToString(),
            Name = g.Name,
            ProgramName = g.ProgramName,
            Year = g.Year,
            DisplayName = $"{g.Name} - {g.ProgramName} (An {g.Year})"
        }).ToList();

        courses = await ScheduleService.GetCourseOptionsAsync();
        isLoading = false;
    }

    private async Task LoadScheduleEntries()
    {
        if (string.IsNullOrEmpty(selectedGroupId))
        {
            scheduleEntries = new List<ScheduleEntryDto>();
            return;
        }

        isLoading = true;
        StateHasChanged();
        scheduleEntries = await ScheduleService.GetByGroupAsync(Guid.Parse(selectedGroupId));
        isLoading = false;
        StateHasChanged();
    }

    private async Task ShowAddForm()
    {
        editingEntry = null;
        formDto = new CreateScheduleEntryDto
        {
            GroupId = string.IsNullOrEmpty(selectedGroupId) ? Guid.Empty : Guid.Parse(selectedGroupId),
            Type = "Curs"
        };
        formDayOfWeek = "1";
        formStartTime = "08:00";
        formEndTime = "10:00";
        errorMessage = "";
        conflictMessage = "";

        await ShowFormDialog("Adaugă Intrare în Orar");
    }

    private async Task ShowEditForm(ScheduleEntryDto entry)
    {
        editingEntry = entry;
        formDto = new CreateScheduleEntryDto
        {
            CourseId = entry.CourseId,
            GroupId = entry.GroupId,
            DayOfWeek = entry.DayOfWeek,
            StartTime = entry.StartTime,
            EndTime = entry.EndTime,
            Room = entry.Room,
            Type = entry.Type
        };
        formDayOfWeek = entry.DayOfWeek.ToString();
        formStartTime = entry.StartTime.ToString(@"hh\:mm");
        formEndTime = entry.EndTime.ToString(@"hh\:mm");
        errorMessage = "";
        conflictMessage = "";

        await ShowFormDialog("Editează Intrare în Orar");
    }

    private async Task ShowFormDialog(string title)
    {
        var dayOptions = new List<DayOption>
        {
            new() { Text = "Luni", Value = "1" },
            new() { Text = "Marți", Value = "2" },
            new() { Text = "Miercuri", Value = "3" },
            new() { Text = "Joi", Value = "4" },
            new() { Text = "Vineri", Value = "5" }
        };

        var typeOptions = new List<string> { "Curs", "Seminar", "Laborator" };

        var result = await DialogService.OpenAsync<ScheduleFormDialog>(title,
            new Dictionary<string, object>
            {
                { "FormDto", formDto },
                { "EditingEntry", editingEntry },
                { "Groups", groups },
                { "Courses", courses },
                { "DayOptions", dayOptions },
                { "TypeOptions", typeOptions },
                { "FormDayOfWeek", formDayOfWeek },
                { "FormStartTime", formStartTime },
                { "FormEndTime", formEndTime },
                { "ScheduleService", ScheduleService }
            },
            new DialogOptions { Width = "600px", Height = "auto", CloseDialogOnOverlayClick = false });

        if (result == true)
        {
            await LoadScheduleEntries();
        }
    }

    private async Task DeleteEntry(Guid id)
    {
        var confirmed = await DialogService.Confirm(
            "Sigur doriți să ștergeți această intrare din orar?",
            "Confirmare Ștergere",
            new ConfirmOptions { OkButtonText = "Șterge", CancelButtonText = "Anulează" });

        if (confirmed == true)
        {
            var result = await ScheduleService.DeleteAsync(id);
            if (result.Succeeded)
            {
                await LoadScheduleEntries();
            }
        }
    }

    private BadgeStyle GetTypeBadgeStyle(string type) => type switch
    {
        "Curs" => BadgeStyle.Info,
        "Seminar" => BadgeStyle.Success,
        "Laborator" => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };

    private class GroupOptionDisplay
    {
        public Guid Id { get; set; }
        public string IdString { get; set; } = "";
        public string Name { get; set; } = "";
        public string ProgramName { get; set; } = "";
        public int Year { get; set; }
        public string DisplayName { get; set; } = "";
    }

    private class DayOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
