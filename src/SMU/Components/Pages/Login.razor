@page "/login"
@layout SMU.Components.Layout.EmptyLayout
@rendermode InteractiveServer
@using System.Net.Http.Json
@using SMU.Data.Entities
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Autentificare - SMU</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #eef2ff 0%, #ffffff 50%, #faf5ff 100%); padding: 2rem;">
    <RadzenCard Style="width: 100%; max-width: 420px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        <!-- Logo & Title -->
        <RadzenStack Gap="1rem" AlignItems="AlignItems.Center" Class="rz-p-6 rz-pb-4">
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center"
                         Style="width: 80px; height: 80px; background: linear-gradient(135deg, #4f46e5, #7c3aed); border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(79, 70, 229, 0.3);">
                <RadzenIcon Icon="school" Style="color: white; font-size: 40px;" />
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.H4" Style="font-weight: 700; margin: 0;">Student Management</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Sistemul de Management Universitar</RadzenText>
        </RadzenStack>

        <!-- Login Form -->
        <RadzenStack Gap="1.5rem" Class="rz-p-6 rz-pt-2">
            <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center" Style="font-weight: 600; margin: 0;">
                Autentificare
            </RadzenText>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Small">
                    @ErrorMessage
                </RadzenAlert>
            }

            <RadzenTemplateForm TItem="LoginModel" Data="@loginModel" Submit="@(args => HandleLogin(args))" InvalidSubmit="@OnInvalidSubmit">
                <DataAnnotationsValidator />

                <RadzenStack Gap="1.25rem">
                    <!-- Email -->
                    <RadzenFormField Text="Email" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="loginModel.Email" Name="Email" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenRequiredValidator Component="Email" Text="Email-ul este obligatoriu" />
                            <RadzenEmailValidator Component="Email" Text="Format email invalid" />
                        </Helper>
                    </RadzenFormField>

                    <!-- Password -->
                    <RadzenFormField Text="Parola" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenPassword @bind-Value="loginModel.Password" Name="Password" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenRequiredValidator Component="Password" Text="Parola este obligatorie" />
                        </Helper>
                    </RadzenFormField>

                    <!-- Remember Me & Forgot Password -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenCheckBox @bind-Value="loginModel.RememberMe" Name="rememberMe" TValue="bool" />
                            <RadzenLabel Text="Ține-mă minte" Component="rememberMe" />
                        </RadzenStack>
                        <RadzenLink Path="/forgot-password" Text="Ai uitat parola?" />
                    </RadzenStack>

                    <!-- Submit Button -->
                    <RadzenButton ButtonType="ButtonType.Submit"
                                  Text="@(IsLoading ? "Se autentifică..." : "Autentificare")"
                                  Icon="@(IsLoading ? "" : "login")"
                                  IsBusy="@IsLoading"
                                  Disabled="@IsLoading"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Style="width: 100%;"
                                  Size="ButtonSize.Large" />
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenStack>

        <!-- Quick Login Development Section -->
        <RadzenStack Gap="1rem" Class="rz-p-6" Style="background: #f9fafb; border-top: 1px solid #e5e7eb;">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.5rem">
                <RadzenIcon Icon="code" Style="font-size: 16px; color: #9ca3af;" />
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0; font-weight: 500;">
                    Quick Login (Development)
                </RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="0.5rem" JustifyContent="JustifyContent.Center">
                <RadzenButton Text="Student" Icon="school"
                              ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@(() => QuickLogin("student@smu.edu", "Demo123!"))" Disabled="@IsLoading" />
                <RadzenButton Text="Profesor" Icon="person"
                              ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@(() => QuickLogin("profesor@smu.edu", "Demo123!"))" Disabled="@IsLoading" />
                <RadzenButton Text="Secretar" Icon="badge"
                              ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@(() => QuickLogin("secretar@smu.edu", "Demo123!"))" Disabled="@IsLoading" />
                <RadzenButton Text="Decan" Icon="work"
                              ButtonStyle="ButtonStyle.Warning" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@(() => QuickLogin("decan@smu.edu", "Demo123!"))" Disabled="@IsLoading" />
                <RadzenButton Text="Rector" Icon="flag"
                              ButtonStyle="ButtonStyle.Danger" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@(() => QuickLogin("rector@smu.edu", "Demo123!"))" Disabled="@IsLoading" />
                <RadzenButton Text="Admin" Icon="settings"
                              ButtonStyle="ButtonStyle.Dark" Variant="Variant.Outlined" Size="ButtonSize.Small"
                              Click="@(() => QuickLogin("admin@smu.edu", "Demo123!"))" Disabled="@IsLoading" />
            </RadzenStack>
        </RadzenStack>

        <!-- Footer -->
        <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-4" Style="border-top: 1px solid #e5e7eb;">
            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                © @DateTime.Now.Year Student Management University
            </RadzenText>
        </RadzenStack>
    </RadzenCard>
</div>

@code {
    private LoginModel loginModel = new();
    private string? ErrorMessage;
    private bool IsLoading;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private async Task HandleLogin(LoginModel model)
    {
        ErrorMessage = null;
        IsLoading = true;
        StateHasChanged();

        try
        {
            // Use JavaScript fetch to make the request from the browser
            // This ensures cookies are properly set in the browser
            var result = await JS.InvokeAsync<LoginResult>("performLogin",
                model.Email,
                model.Password,
                model.RememberMe);

            if (result.Success)
            {
                var redirectUrl = !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : result.RedirectUrl ?? "/dashboard";
                Navigation.NavigateTo(redirectUrl, forceLoad: true);
            }
            else
            {
                ErrorMessage = result.Error ?? "Email sau parolă incorectă.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login error: {ex.Message}");
            ErrorMessage = "Eroare de conectare. Vă rugăm încercați din nou.";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private record LoginResult(bool Success, string? RedirectUrl, string? Error);

    private void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    {
        // Validation errors are shown automatically by validators
    }

    private async Task QuickLogin(string email, string password)
    {
        loginModel.Email = email;
        loginModel.Password = password;
        await HandleLogin(loginModel);
    }


    public class LoginModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email-ul este obligatoriu")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Format email invalid")]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Parola este obligatorie")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }
}
