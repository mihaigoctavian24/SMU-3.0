@page "/notifications"
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService
@attribute [Authorize]

<PageTitle>Notificări - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Page Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Notificări</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Vizualizați și gestionați toate notificările
            </RadzenText>
        </RadzenStack>
        @if (UnreadCount > 0)
        {
            <RadzenButton Text="Marchează toate ca citite" Icon="done_all" ButtonStyle="ButtonStyle.Secondary"
                          Click="@MarkAllAsRead" />
        }
    </RadzenStack>

    <!-- Filters -->
    <RadzenCard>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="1rem">
            <!-- Filter Tabs -->
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                <RadzenButton Text="@($"Toate {(TotalCount > 0 ? $"({TotalCount})" : "")}")"
                              ButtonStyle="@(CurrentFilter == null ? ButtonStyle.Primary : ButtonStyle.Light)"
                              Variant="@(CurrentFilter == null ? Variant.Filled : Variant.Text)"
                              Click="@(() => SetFilter(null))" />
                <RadzenButton Text="@($"Necitite {(UnreadCount > 0 ? $"({UnreadCount})" : "")}")"
                              ButtonStyle="@(CurrentFilter == true ? ButtonStyle.Primary : ButtonStyle.Light)"
                              Variant="@(CurrentFilter == true ? Variant.Filled : Variant.Text)"
                              Click="@(() => SetFilter(true))" />
            </RadzenStack>

            <!-- Type Filter -->
            <RadzenFormField Text="Tip" Variant="Variant.Outlined" Style="width: 200px;">
                <RadzenDropDown @bind-Value="SelectedType" Data="@typeOptions" TextProperty="Text" ValueProperty="Value"
                                Change="@(args => LoadNotifications())" Style="width: 100%;" />
            </RadzenFormField>
        </RadzenStack>
    </RadzenCard>

    <!-- Notifications List -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (IsLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                    Se încarcă notificările...
                </RadzenText>
            </RadzenStack>
        }
        else if (Notifications.Any())
        {
            <!-- Group by date -->
            @foreach (var group in Notifications.GroupBy(n => n.CreatedAt.Date).OrderByDescending(g => g.Key))
            {
                <div style="margin-bottom: 0;">
                    <!-- Date Header -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center"
                                 Style="padding: 0.75rem 1rem; background: var(--rz-base-100); border-bottom: 1px solid var(--rz-base-300);">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; font-weight: 600;">
                            @GetDateLabel(group.Key)
                        </RadzenText>
                        <div style="flex: 1; height: 1px; background: var(--rz-base-300);"></div>
                    </RadzenStack>

                    <!-- Notifications in this date group -->
                    @foreach (var notification in group)
                    {
                        <div @onclick="() => HandleNotificationClick(notification)"
                             style="@($"padding: 1rem; border-bottom: 1px solid var(--rz-base-200); cursor: pointer; transition: background 0.2s; {(!notification.IsRead ? "background: rgba(var(--rz-primary-rgb), 0.05);" : "")}")"
                             class="notification-item">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Start">
                                <!-- Type Icon -->
                                <div style="@GetTypeIconStyle(notification.Type)">
                                    <RadzenIcon Icon="@GetTypeIcon(notification.Type)" Style="font-size: 20px;" />
                                </div>

                                <!-- Content -->
                                <RadzenStack Gap="0.5rem" Style="flex: 1; min-width: 0;">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.Body1" Style="@($"margin: 0; font-weight: {(!notification.IsRead ? "600" : "500")};")">
                                            @notification.Title
                                        </RadzenText>
                                        @if (!notification.IsRead)
                                        {
                                            <div style="width: 8px; height: 8px; border-radius: 50%; background: var(--rz-primary);"></div>
                                        }
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                        @notification.Message
                                    </RadzenText>
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                            @notification.TimeAgo
                                        </RadzenText>
                                        <RadzenBadge BadgeStyle="@GetTypeBadgeStyle(notification.Type)" Text="@notification.TypeLabel" IsPill="true"
                                                     Style="font-size: 10px; padding: 2px 8px;" />
                                    </RadzenStack>
                                </RadzenStack>

                                <!-- Actions -->
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" AlignItems="AlignItems.Center">
                                    @if (!notification.IsRead)
                                    {
                                        <RadzenButton Icon="done" ButtonStyle="ButtonStyle.Success" Variant="Variant.Text" Size="ButtonSize.Small"
                                                      Click="@(async () => { await MarkAsRead(notification); })"
                                                      @onclick:stopPropagation="true" />
                                    }
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(async () => { await DeleteNotification(notification); })"
                                                  @onclick:stopPropagation="true" />
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    }
                </div>
            }

            <!-- Pagination -->
            @if (PagedResult != null && PagedResult.TotalPages > 1)
            {
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                             Class="rz-p-4" Style="border-top: 1px solid var(--rz-base-300);">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                        Pagina @PagedResult.Page din @PagedResult.TotalPages
                        (@PagedResult.TotalCount @(PagedResult.TotalCount == 1 ? "notificare" : "notificări"))
                    </RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Text="Înapoi" Icon="chevron_left" Variant="Variant.Outlined" Size="ButtonSize.Small"
                                      Disabled="@(!PagedResult.HasPreviousPage)" Click="@PreviousPage" />
                        <RadzenButton Text="Următoarea" Icon="chevron_right" Variant="Variant.Outlined" Size="ButtonSize.Small"
                                      Disabled="@(!PagedResult.HasNextPage)" Click="@NextPage" />
                    </RadzenStack>
                </RadzenStack>
            }
        }
        else
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="1rem">
                <RadzenIcon Icon="notifications_none" Style="font-size: 64px; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Nu există notificări</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                    @if (CurrentFilter == true)
                    {
                        <text>Nu aveți notificări necitite în acest moment.</text>
                    }
                    else
                    {
                        <text>Nu aveți nicio notificare.</text>
                    }
                </RadzenText>
            </RadzenStack>
        }
    </RadzenCard>
</RadzenStack>

<style>
    .notification-item:hover {
        background: var(--rz-base-100) !important;
    }
</style>

@code {
    private List<NotificationDto> Notifications { get; set; } = new();
    private PagedResult<NotificationDto>? PagedResult { get; set; }
    private int CurrentPage { get; set; } = 1;
    private int PageSize { get; set; } = 25;
    private bool? CurrentFilter { get; set; }
    private string? SelectedType { get; set; }
    private int UnreadCount { get; set; }
    private int TotalCount { get; set; }
    private bool IsLoading { get; set; }
    private Guid CurrentUserId { get; set; }

    private List<dynamic> typeOptions = new List<dynamic>
    {
        new { Text = "Toate tipurile", Value = (string?)null },
        new { Text = "Note noi", Value = "GradeAdded" },
        new { Text = "Prezență", Value = "AttendanceMarked" },
        new { Text = "Cereri", Value = "RequestUpdate" },
        new { Text = "Succes", Value = "Success" },
        new { Text = "Avertismente", Value = "Warning" },
        new { Text = "Informații", Value = "Info" }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
        {
            CurrentUserId = userId;
        }

        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        if (CurrentUserId == Guid.Empty) return;

        IsLoading = true;
        StateHasChanged();

        try
        {
            var filter = new NotificationFilter
            {
                UserId = CurrentUserId,
                UnreadOnly = CurrentFilter ?? false,
                Type = !string.IsNullOrEmpty(SelectedType) ? Enum.Parse<NotificationType>(SelectedType) : null
            };

            PagedResult = await NotificationService.GetPagedAsync(CurrentUserId, filter, CurrentPage, PageSize);
            Notifications = PagedResult.Items;

            UnreadCount = await NotificationService.GetUnreadCountAsync(CurrentUserId);
            TotalCount = PagedResult.TotalCount;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task SetFilter(bool? unreadOnly)
    {
        CurrentFilter = unreadOnly;
        CurrentPage = 1;
        await LoadNotifications();
    }

    private async Task PreviousPage()
    {
        if (PagedResult?.HasPreviousPage == true)
        {
            CurrentPage--;
            await LoadNotifications();
        }
    }

    private async Task NextPage()
    {
        if (PagedResult?.HasNextPage == true)
        {
            CurrentPage++;
            await LoadNotifications();
        }
    }

    private async Task HandleNotificationClick(NotificationDto notification)
    {
        if (!notification.IsRead)
        {
            await MarkAsRead(notification);
        }

        if (!string.IsNullOrEmpty(notification.Link))
        {
            Navigation.NavigateTo(notification.Link);
        }
    }

    private async Task MarkAsRead(NotificationDto notification)
    {
        var result = await NotificationService.MarkAsReadAsync(notification.Id);
        if (result.Succeeded)
        {
            notification.IsRead = true;
            UnreadCount = Math.Max(0, UnreadCount - 1);
            StateHasChanged();
        }
    }

    private async Task MarkAllAsRead()
    {
        var result = await NotificationService.MarkAllAsReadAsync(CurrentUserId);
        if (result.Succeeded)
        {
            foreach (var notification in Notifications)
            {
                notification.IsRead = true;
            }
            UnreadCount = 0;
            RadzenNotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Succes",
                Detail = "Toate notificările au fost marcate ca citite.",
                Duration = 3000
            });
            StateHasChanged();
        }
    }

    private async Task DeleteNotification(NotificationDto notification)
    {
        var result = await NotificationService.DeleteAsync(notification.Id);
        if (result.Succeeded)
        {
            Notifications.Remove(notification);
            if (!notification.IsRead)
            {
                UnreadCount = Math.Max(0, UnreadCount - 1);
            }
            TotalCount--;
            StateHasChanged();
        }
    }

    private string GetDateLabel(DateTime date)
    {
        var today = DateTime.Today;
        var yesterday = today.AddDays(-1);

        if (date.Date == today)
            return "Astăzi";
        if (date.Date == yesterday)
            return "Ieri";
        if (date.Date > today.AddDays(-7))
            return date.ToString("dddd, dd MMMM", new System.Globalization.CultureInfo("ro-RO"));

        return date.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("ro-RO"));
    }

    private string GetTypeIcon(NotificationType type) => type switch
    {
        NotificationType.Info => "info",
        NotificationType.Success => "check_circle",
        NotificationType.Warning => "warning",
        NotificationType.Error => "error",
        NotificationType.GradeAdded => "school",
        NotificationType.AttendanceMarked => "event_available",
        NotificationType.RequestUpdate => "description",
        _ => "notifications"
    };

    private string GetTypeIconStyle(NotificationType type)
    {
        var (bg, color) = type switch
        {
            NotificationType.Info => ("rgba(59, 130, 246, 0.15)", "rgb(59, 130, 246)"),
            NotificationType.Success => ("rgba(34, 197, 94, 0.15)", "rgb(34, 197, 94)"),
            NotificationType.Warning => ("rgba(234, 179, 8, 0.15)", "rgb(234, 179, 8)"),
            NotificationType.Error => ("rgba(239, 68, 68, 0.15)", "rgb(239, 68, 68)"),
            NotificationType.GradeAdded => ("rgba(168, 85, 247, 0.15)", "rgb(168, 85, 247)"),
            NotificationType.AttendanceMarked => ("rgba(6, 182, 212, 0.15)", "rgb(6, 182, 212)"),
            NotificationType.RequestUpdate => ("rgba(99, 102, 241, 0.15)", "rgb(99, 102, 241)"),
            _ => ("rgba(156, 163, 175, 0.15)", "rgb(156, 163, 175)")
        };

        return $"width: 40px; height: 40px; border-radius: 50%; background: {bg}; color: {color}; display: flex; align-items: center; justify-content: center;";
    }

    private BadgeStyle GetTypeBadgeStyle(NotificationType type) => type switch
    {
        NotificationType.Info => BadgeStyle.Info,
        NotificationType.Success => BadgeStyle.Success,
        NotificationType.Warning => BadgeStyle.Warning,
        NotificationType.Error => BadgeStyle.Danger,
        NotificationType.GradeAdded => BadgeStyle.Info,
        NotificationType.AttendanceMarked => BadgeStyle.Success,
        NotificationType.RequestUpdate => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };
}
