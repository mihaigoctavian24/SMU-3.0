@page "/analytics/trends"
@attribute [Authorize(Policy = "CanViewReports")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Components.Shared.Charts
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Analiza Tendintelor - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header Section -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap" Gap="1rem">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
            <div style="width: 3.5rem; height: 3.5rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                <RadzenIcon Icon="trending_up" Style="font-size: 2rem; color: #3b82f6;" />
            </div>
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">Analiza Tendintelor</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Evolutia indicatorilor academici in timp</RadzenText>
            </RadzenStack>
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
            <!-- Period Selector -->
            <RadzenFormField Text="Perioada" Variant="Variant.Outlined">
                <RadzenDropDown @bind-Value="selectedPeriod"
                                Change="@LoadTrendData"
                                Data="@periodOptions"
                                TextProperty="Text"
                                ValueProperty="Value"
                                Style="width: 180px;" />
            </RadzenFormField>

            <!-- Faculty Filter -->
            <RadzenFormField Text="Facultate" Variant="Variant.Outlined">
                <RadzenDropDown @bind-Value="selectedFacultyId"
                                Change="@LoadTrendData"
                                Data="@facultyOptions"
                                TextProperty="Text"
                                ValueProperty="Value"
                                AllowClear="true"
                                Placeholder="Toate facultatile"
                                Style="width: 220px;" />
            </RadzenFormField>
        </RadzenStack>
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 400px;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body1" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Se incarca datele...</RadzenText>
        </RadzenStack>
    }
    else
    {
        <!-- Trend Summary Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Average Grade Trend -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color); font-weight: 500;">Trend Medie Note</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@averageGradeTrend.CurrentValue.ToString("F2")</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: @(averageGradeTrend.ChangePercent >= 0 ? "#dcfce7" : "#fee2e2"); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="@(averageGradeTrend.ChangePercent >= 0 ? "arrow_upward" : "arrow_downward")"
                                        Style="@($"font-size: 1.5rem; color: {(averageGradeTrend.ChangePercent >= 0 ? "#16a34a" : "#dc2626")};")" />
                        </div>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="@($"margin: 0; font-weight: 600; color: {(averageGradeTrend.ChangePercent >= 0 ? "#16a34a" : "#dc2626")};")">
                            @(averageGradeTrend.ChangePercent >= 0 ? "+" : "")@averageGradeTrend.ChangePercent.ToString("F1")%
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">fata de perioada anterioara</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Attendance Trend -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color); font-weight: 500;">Trend Prezenta</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@attendanceTrend.CurrentValue.ToString("F1")%</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: @(attendanceTrend.ChangePercent >= 0 ? "#dcfce7" : "#fee2e2"); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="@(attendanceTrend.ChangePercent >= 0 ? "arrow_upward" : "arrow_downward")"
                                        Style="@($"font-size: 1.5rem; color: {(attendanceTrend.ChangePercent >= 0 ? "#16a34a" : "#dc2626")};")" />
                        </div>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="@($"margin: 0; font-weight: 600; color: {(attendanceTrend.ChangePercent >= 0 ? "#16a34a" : "#dc2626")};")">
                            @(attendanceTrend.ChangePercent >= 0 ? "+" : "")@attendanceTrend.ChangePercent.ToString("F1")%
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">fata de perioada anterioara</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- At-Risk Students Trend -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color); font-weight: 500;">Studenti la Risc</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@atRiskTrend.CurrentValue.ToString("F1")%</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: @(atRiskTrend.ChangePercent <= 0 ? "#dcfce7" : "#fee2e2"); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="@(atRiskTrend.ChangePercent <= 0 ? "arrow_downward" : "arrow_upward")"
                                        Style="@($"font-size: 1.5rem; color: {(atRiskTrend.ChangePercent <= 0 ? "#16a34a" : "#dc2626")};")" />
                        </div>
                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="@($"margin: 0; font-weight: 600; color: {(atRiskTrend.ChangePercent <= 0 ? "#16a34a" : "#dc2626")};")">
                            @(atRiskTrend.ChangePercent >= 0 ? "+" : "")@atRiskTrend.ChangePercent.ToString("F1")%
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">fata de perioada anterioara</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Metrics Evolution Chart -->
        <RadzenCard Style="padding: 1.5rem;">
            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0 0 1.5rem 0; font-weight: 600;">Evolutia Indicatorilor</RadzenText>

            @if (metricsChartData.Labels.Any())
            {
                <SmuLineChart
                    Labels="@metricsChartData.Labels"
                    Datasets="@metricsChartData.Datasets"
                    Height="400" />
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem;">
                    <RadzenIcon Icon="info" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Nu exista date disponibile pentru perioada selectata</RadzenText>
                </RadzenStack>
            }
        </RadzenCard>

        <!-- Faculty/Program Comparison -->
        <RadzenCard Style="padding: 1.5rem;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="margin-bottom: 1.5rem;">
                <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 600;">Comparatie Entitati</RadzenText>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="Facultati"
                                  ButtonStyle="@(comparisonType == ComparisonType.Faculties ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Size="ButtonSize.Small"
                                  Click="@(() => SetComparisonType(ComparisonType.Faculties))" />
                    <RadzenButton Text="Programe"
                                  ButtonStyle="@(comparisonType == ComparisonType.Programs ? ButtonStyle.Primary : ButtonStyle.Light)"
                                  Size="ButtonSize.Small"
                                  Click="@(() => SetComparisonType(ComparisonType.Programs))" />
                </RadzenStack>
            </RadzenStack>

            @if (comparisonChartData.Labels.Any())
            {
                <SmuBarChart
                    Labels="@comparisonChartData.Labels"
                    Datasets="@comparisonChartData.Datasets"
                    Height="350" />
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem;">
                    <RadzenIcon Icon="info" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Nu exista date disponibile pentru comparatie</RadzenText>
                </RadzenStack>
            }
        </RadzenCard>

        <!-- Historical Data Table -->
        <RadzenCard Style="padding: 0; overflow: hidden;">
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--rz-border-color);">
                <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 600;">Date Istorice</RadzenText>
            </div>

            @if (historicalData.Any())
            {
                <RadzenDataGrid Data="@historicalData.Take(10)" TItem="DailySnapshot" AllowSorting="true" Style="border: none;">
                    <Columns>
                        <RadzenDataGridColumn TItem="DailySnapshot" Property="Date" Title="Data" Width="150px">
                            <Template Context="snapshot">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@snapshot.Date.ToString("dd.MM.yyyy")</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DailySnapshot" Property="TotalStudents" Title="Studenti" Width="120px">
                            <Template Context="snapshot">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@snapshot.TotalStudents</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DailySnapshot" Property="AverageGrade" Title="Media" Width="100px">
                            <Template Context="snapshot">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@(snapshot.AverageGrade?.ToString("F2") ?? "-")</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DailySnapshot" Property="AttendanceRate" Title="Prezenta" Width="120px">
                            <Template Context="snapshot">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@(snapshot.AttendanceRate?.ToString("F1") ?? "-")%</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="DailySnapshot" Property="GradesSubmitted" Title="Note Introduse" Width="140px">
                            <Template Context="snapshot">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@snapshot.GradesSubmitted</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem;">
                    <RadzenIcon Icon="info" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">Nu exista date istorice disponibile</RadzenText>
                </RadzenStack>
            }
        </RadzenCard>
    }
</RadzenStack>

@code {
    private bool isLoading = true;
    private List<Faculty> faculties = new();
    private string? selectedFacultyId = null;
    private AnalysisPeriod selectedPeriod = AnalysisPeriod.Last3Months;

    // Dropdown options
    private List<FacultyOption> facultyOptions = new();
    private List<PeriodOption> periodOptions = new()
    {
        new() { Value = AnalysisPeriod.LastMonth, Text = "Ultima luna" },
        new() { Value = AnalysisPeriod.Last3Months, Text = "Ultimele 3 luni" },
        new() { Value = AnalysisPeriod.Last6Months, Text = "Ultimele 6 luni" },
        new() { Value = AnalysisPeriod.LastYear, Text = "Ultimul an" }
    };

    // Trend data
    private TrendMetric averageGradeTrend = new();
    private TrendMetric attendanceTrend = new();
    private TrendMetric atRiskTrend = new();

    // Chart data
    private ChartData metricsChartData = new();
    private ChartData comparisonChartData = new();
    private ComparisonType comparisonType = ComparisonType.Faculties;

    // Historical data
    private List<DailySnapshot> historicalData = new();
    private string historicalSortColumn = nameof(DailySnapshot.Date);
    private bool historicalSortAscending = false;

    private class FacultyOption
    {
        public string Value { get; set; } = "";
        public string Text { get; set; } = "";
    }

    private class PeriodOption
    {
        public AnalysisPeriod Value { get; set; }
        public string Text { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFaculties();
        await LoadTrendData();
        isLoading = false;
    }

    private async Task LoadFaculties()
    {
        faculties = await DbContext.Faculties
            .OrderBy(f => f.Name)
            .ToListAsync();

        facultyOptions = faculties.Select(f => new FacultyOption
        {
            Value = f.Id.ToString(),
            Text = f.Name
        }).ToList();
    }

    private async Task LoadTrendData()
    {
        isLoading = true;
        StateHasChanged();

        var (startDate, endDate) = GetDateRange(selectedPeriod);

        // Load snapshots for selected period
        var startDateOnly = DateOnly.FromDateTime(startDate);
        var endDateOnly = DateOnly.FromDateTime(endDate);

        var query = DbContext.DailySnapshots
            .Where(s => s.Date >= startDateOnly && s.Date <= endDateOnly);

        if (!string.IsNullOrEmpty(selectedFacultyId) && Guid.TryParse(selectedFacultyId, out var facultyGuid))
        {
            query = query.Where(s => s.FacultyId == facultyGuid);
        }

        var snapshots = await query
            .OrderBy(s => s.Date)
            .ToListAsync();

        // Calculate trends
        CalculateTrends(snapshots);

        // Prepare chart data
        PrepareMetricsChartData(snapshots);

        // Load comparison data
        await LoadComparisonData(startDate, endDate);

        // Load historical data
        historicalData = snapshots.OrderByDescending(s => s.Date).ToList();
        ApplyHistoricalSort();

        isLoading = false;
    }

    private void CalculateTrends(List<DailySnapshot> snapshots)
    {
        if (snapshots.Count < 2)
        {
            averageGradeTrend = new TrendMetric();
            attendanceTrend = new TrendMetric();
            atRiskTrend = new TrendMetric();
            return;
        }

        var firstSnapshot = snapshots.First();
        var lastSnapshot = snapshots.Last();

        // Average grade trend
        averageGradeTrend = CalculateTrendMetric(
            (double)(firstSnapshot.AverageGrade ?? 0),
            (double)(lastSnapshot.AverageGrade ?? 0)
        );

        // Attendance trend
        attendanceTrend = CalculateTrendMetric(
            (double)(firstSnapshot.AttendanceRate ?? 0),
            (double)(lastSnapshot.AttendanceRate ?? 0)
        );

        // At-risk students trend - Note: DailySnapshot doesn't have AtRiskStudents property
        // We'll calculate it as students who are not active
        var firstAtRisk = firstSnapshot.TotalStudents > 0
            ? ((firstSnapshot.TotalStudents - firstSnapshot.ActiveStudents) * 100.0 / firstSnapshot.TotalStudents)
            : 0;
        var lastAtRisk = lastSnapshot.TotalStudents > 0
            ? ((lastSnapshot.TotalStudents - lastSnapshot.ActiveStudents) * 100.0 / lastSnapshot.TotalStudents)
            : 0;

        atRiskTrend = CalculateTrendMetric(firstAtRisk, lastAtRisk);
    }

    private TrendMetric CalculateTrendMetric(double oldValue, double newValue)
    {
        var change = newValue - oldValue;
        var changePercent = oldValue != 0 ? (change / oldValue * 100) : 0;

        return new TrendMetric
        {
            PreviousValue = oldValue,
            CurrentValue = newValue,
            ChangePercent = changePercent
        };
    }

    private void PrepareMetricsChartData(List<DailySnapshot> snapshots)
    {
        if (!snapshots.Any())
        {
            metricsChartData = new ChartData();
            return;
        }

        metricsChartData = new ChartData
        {
            Labels = snapshots.Select(s => s.Date.ToString("dd.MM")).ToList(),
            Datasets = new List<ChartDataset>
            {
                new()
                {
                    Label = "Media generala",
                    Data = snapshots.Select(s => (double)(s.AverageGrade ?? 0)).ToList(),
                    BorderColor = "rgb(59, 130, 246)",
                    BackgroundColor = "rgba(59, 130, 246, 0.1)",
                    Tension = 0.4
                },
                new()
                {
                    Label = "Rata prezenta (%)",
                    Data = snapshots.Select(s => (double)(s.AttendanceRate ?? 0)).ToList(),
                    BorderColor = "rgb(34, 197, 94)",
                    BackgroundColor = "rgba(34, 197, 94, 0.1)",
                    Tension = 0.4
                },
                new()
                {
                    Label = "Studenti activi (%)",
                    Data = snapshots.Select(s => s.TotalStudents > 0
                        ? ((double)s.ActiveStudents * 100.0 / s.TotalStudents)
                        : 0).ToList(),
                    BorderColor = "rgb(168, 85, 247)",
                    BackgroundColor = "rgba(168, 85, 247, 0.1)",
                    Tension = 0.4
                }
            }
        };
    }

    private async Task LoadComparisonData(DateTime startDate, DateTime endDate)
    {
        if (comparisonType == ComparisonType.Faculties)
        {
            await LoadFacultyComparison(startDate, endDate);
        }
        else
        {
            await LoadProgramComparison(startDate, endDate);
        }
    }

    private async Task LoadFacultyComparison(DateTime startDate, DateTime endDate)
    {
        var startDateOnly = DateOnly.FromDateTime(startDate);
        var endDateOnly = DateOnly.FromDateTime(endDate);

        var facultyStats = await DbContext.DailySnapshots
            .Where(s => s.Date >= startDateOnly && s.Date <= endDateOnly && s.FacultyId != null)
            .GroupBy(s => s.FacultyId)
            .Select(g => new
            {
                FacultyId = g.Key,
                AvgGrade = g.Average(s => s.AverageGrade),
                AvgAttendance = g.Average(s => s.AttendanceRate)
            })
            .ToListAsync();

        var labels = new List<string>();
        var avgGrades = new List<double>();
        var avgAttendance = new List<double>();

        foreach (var stat in facultyStats)
        {
            var faculty = faculties.FirstOrDefault(f => f.Id == stat.FacultyId);
            if (faculty != null)
            {
                labels.Add(faculty.Code ?? faculty.Name);
                avgGrades.Add((double)(stat.AvgGrade ?? 0));
                avgAttendance.Add((double)(stat.AvgAttendance ?? 0));
            }
        }

        comparisonChartData = new ChartData
        {
            Labels = labels,
            Datasets = new List<ChartDataset>
            {
                new()
                {
                    Label = "Media generala",
                    Data = avgGrades,
                    BackgroundColor = "rgba(59, 130, 246, 0.8)",
                    BorderColor = "rgb(59, 130, 246)",
                    BorderWidth = 1
                },
                new()
                {
                    Label = "Rata prezenta (%)",
                    Data = avgAttendance,
                    BackgroundColor = "rgba(34, 197, 94, 0.8)",
                    BorderColor = "rgb(34, 197, 94)",
                    BorderWidth = 1
                }
            }
        };
    }

    private async Task LoadProgramComparison(DateTime startDate, DateTime endDate)
    {
        var startDateOnly = DateOnly.FromDateTime(startDate);
        var endDateOnly = DateOnly.FromDateTime(endDate);

        var programStats = await DbContext.DailySnapshots
            .Where(s => s.Date >= startDateOnly && s.Date <= endDateOnly && s.ProgramId != null)
            .GroupBy(s => s.ProgramId)
            .Select(g => new
            {
                ProgramId = g.Key,
                AvgGrade = g.Average(s => s.AverageGrade),
                AvgAttendance = g.Average(s => s.AttendanceRate)
            })
            .ToListAsync();

        var programs = await DbContext.Programs
            .Where(p => programStats.Select(s => s.ProgramId).Contains(p.Id))
            .ToListAsync();

        var labels = new List<string>();
        var avgGrades = new List<double>();
        var avgAttendance = new List<double>();

        foreach (var stat in programStats.Take(10))
        {
            var program = programs.FirstOrDefault(p => p.Id == stat.ProgramId);
            if (program != null)
            {
                labels.Add(program.Name);
                avgGrades.Add((double)(stat.AvgGrade ?? 0));
                avgAttendance.Add((double)(stat.AvgAttendance ?? 0));
            }
        }

        comparisonChartData = new ChartData
        {
            Labels = labels,
            Datasets = new List<ChartDataset>
            {
                new()
                {
                    Label = "Media generala",
                    Data = avgGrades,
                    BackgroundColor = "rgba(59, 130, 246, 0.8)",
                    BorderColor = "rgb(59, 130, 246)",
                    BorderWidth = 1
                },
                new()
                {
                    Label = "Rata prezenta (%)",
                    Data = avgAttendance,
                    BackgroundColor = "rgba(34, 197, 94, 0.8)",
                    BorderColor = "rgb(34, 197, 94)",
                    BorderWidth = 1
                }
            }
        };
    }

    private async Task SetComparisonType(ComparisonType type)
    {
        comparisonType = type;
        var (startDate, endDate) = GetDateRange(selectedPeriod);
        await LoadComparisonData(startDate, endDate);
    }

    private void SortHistoricalData(string column)
    {
        if (historicalSortColumn == column)
        {
            historicalSortAscending = !historicalSortAscending;
        }
        else
        {
            historicalSortColumn = column;
            historicalSortAscending = true;
        }

        ApplyHistoricalSort();
    }

    private void ApplyHistoricalSort()
    {
        historicalData = historicalSortColumn switch
        {
            nameof(DailySnapshot.Date) => historicalSortAscending
                ? historicalData.OrderBy(s => s.Date).ToList()
                : historicalData.OrderByDescending(s => s.Date).ToList(),
            nameof(DailySnapshot.TotalStudents) => historicalSortAscending
                ? historicalData.OrderBy(s => s.TotalStudents).ToList()
                : historicalData.OrderByDescending(s => s.TotalStudents).ToList(),
            nameof(DailySnapshot.AverageGrade) => historicalSortAscending
                ? historicalData.OrderBy(s => s.AverageGrade).ToList()
                : historicalData.OrderByDescending(s => s.AverageGrade).ToList(),
            nameof(DailySnapshot.AttendanceRate) => historicalSortAscending
                ? historicalData.OrderBy(s => s.AttendanceRate).ToList()
                : historicalData.OrderByDescending(s => s.AttendanceRate).ToList(),
            nameof(DailySnapshot.GradesSubmitted) => historicalSortAscending
                ? historicalData.OrderBy(s => s.GradesSubmitted).ToList()
                : historicalData.OrderByDescending(s => s.GradesSubmitted).ToList(),
            _ => historicalData
        };
    }

    private (DateTime startDate, DateTime endDate) GetDateRange(AnalysisPeriod period)
    {
        var endDate = DateTime.Today;
        var startDate = period switch
        {
            AnalysisPeriod.LastMonth => endDate.AddMonths(-1),
            AnalysisPeriod.Last3Months => endDate.AddMonths(-3),
            AnalysisPeriod.Last6Months => endDate.AddMonths(-6),
            AnalysisPeriod.LastYear => endDate.AddYears(-1),
            _ => endDate.AddMonths(-3)
        };

        return (startDate, endDate);
    }

    private enum AnalysisPeriod
    {
        LastMonth,
        Last3Months,
        Last6Months,
        LastYear
    }

    private enum ComparisonType
    {
        Faculties,
        Programs
    }

    private class TrendMetric
    {
        public double PreviousValue { get; set; }
        public double CurrentValue { get; set; }
        public double ChangePercent { get; set; }
    }

    private class ChartData
    {
        public List<string> Labels { get; set; } = new();
        public List<ChartDataset> Datasets { get; set; } = new();
    }

    private class ChartDataset
    {
        public string Label { get; set; } = "";
        public List<double> Data { get; set; } = new();
        public string BorderColor { get; set; } = "";
        public string BackgroundColor { get; set; } = "";
        public double Tension { get; set; }
        public int BorderWidth { get; set; }
    }
}
