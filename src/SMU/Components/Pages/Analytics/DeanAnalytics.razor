@page "/analytics/faculty"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using SMU.Services
@using SMU.Data.Entities
@using SMU.Components.Shared.Charts
@attribute [Authorize(Roles = "Dean,Admin")]

<PageTitle>KPI Facultate - SMU</PageTitle>

<div class="min-h-screen bg-gray-50">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">

        @if (isLoading)
        {
            <div class="flex items-center justify-center h-96">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600"></div>
            </div>
        }
        else
        {
            <!-- Header -->
            <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">KPI Facultate: @facultyStats.FacultyName</h1>
                    <p class="mt-2 text-sm text-gray-600">Raport analitic pentru performanta facultatii</p>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Semester Selector -->
                    <div class="relative">
                        <label for="semester" class="sr-only">Selecteaza Semestrul</label>
                        <select @bind="selectedSemester"
                                @bind:after="OnSemesterChanged"
                                id="semester"
                                class="block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm bg-white shadow-sm">
                            <option value="current">Semestrul Curent</option>
                            <option value="sem1_2024">Semestrul I, 2024</option>
                            <option value="sem2_2024">Semestrul II, 2024</option>
                            <option value="sem1_2023">Semestrul I, 2023</option>
                            <option value="sem2_2023">Semestrul II, 2023</option>
                        </select>
                    </div>

                    <!-- Export Button (Placeholder) -->
                    <button type="button"
                            class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export PDF
                    </button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5">
                <!-- Total Students -->
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="rounded-md bg-indigo-50 p-3">
                                    <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Studenti</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">@facultyStats.StudentCount</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Professors -->
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="rounded-md bg-emerald-50 p-3">
                                    <svg class="h-6 w-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Profesori</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">@facultyStats.ProfessorCount</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Average Grade -->
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="rounded-md bg-amber-50 p-3">
                                    <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Media Facultate</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">@facultyStats.AverageGrade.ToString("F2")</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pass Rate -->
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="rounded-md bg-green-50 p-3">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Rata Promovare</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">@facultyStats.PassRate.ToString("F1")%</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Program Count -->
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-gray-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="rounded-md bg-purple-50 p-3">
                                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Programe Studiu</dt>
                                    <dd class="flex items-baseline">
                                        <div class="text-2xl font-semibold text-gray-900">@facultyStats.ProgramCount</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="mb-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
                <!-- Grade Distribution Donut Chart -->
                <SmuDonutChart Title="Distributie Note Facultate"
                              Data="@gradeDistributionData"
                              IsLoading="@isLoading"
                              Height="400" />

                <!-- Program Comparison Bar Chart -->
                <SmuBarChart Title="Comparatie Programe - Medii"
                            Data="@programComparisonData"
                            YAxisLabel="Media"
                            IsLoading="@isLoading"
                            Height="400" />
            </div>

            <!-- Charts Row 2 -->
            <div class="mb-8 grid grid-cols-1 gap-6 lg:grid-cols-2">
                <!-- Students per Program -->
                <SmuBarChart Title="Studenti per Program"
                            Data="@studentsPerProgramData"
                            YAxisLabel="Numar Studenti"
                            Horizontal="true"
                            IsLoading="@isLoading"
                            Height="400" />

                <!-- Attendance per Program -->
                <SmuBarChart Title="Rata Prezenta per Program"
                            Data="@attendancePerProgramData"
                            YAxisLabel="Procent Prezenta (%)"
                            IsLoading="@isLoading"
                            Height="400" />
            </div>

            <!-- Trend Analysis Line Chart -->
            <div class="mb-8">
                <SmuLineChart Title="Evolutie Medie Facultate - Ultimele 6 Luni"
                             Data="@trendData"
                             YAxisLabel="Media"
                             IsLoading="@isLoading"
                             Height="350" />
            </div>

            <!-- At-Risk Students Panel -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
                <div class="mb-6 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Studenti in Risc</h2>
                        <p class="mt-1 text-sm text-gray-600">Studenti cu risc ridicat sau critic</p>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 bg-red-50 rounded-lg">
                        <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span class="text-sm font-semibold text-red-900">@atRiskStudents.Count studenti</span>
                    </div>
                </div>

                @if (atRiskStudents.Any())
                {
                    <div class="overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nume Student</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Media</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prezenta</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel Risc</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                @foreach (var student in atRiskStudents.Take(10))
                                {
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">@student.Name</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">@student.ProgramName</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@student.Average.ToString("F2")</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">@student.AttendanceRate.ToString("F1")%</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            @if (student.Risk == RiskLevel.Critical)
                                            {
                                                <span class="inline-flex items-center gap-1 rounded-full bg-red-100 px-3 py-1 text-xs font-semibold text-red-800">
                                                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                                    </svg>
                                                    Critic
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="inline-flex items-center gap-1 rounded-full bg-orange-100 px-3 py-1 text-xs font-semibold text-orange-800">
                                                    <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                    </svg>
                                                    Ridicat
                                                </span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        @if (atRiskStudents.Count > 10)
                        {
                            <div class="px-6 py-4 bg-gray-50 text-sm text-gray-600 text-center">
                                Si inca @(atRiskStudents.Count - 10) studenti...
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-12 text-gray-500">
                        <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm">Nu exista studenti in risc ridicat sau critic</p>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Inject] private IAnalyticsService AnalyticsService { get; set; } = default!;
    [Inject] private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    private bool isLoading = true;
    private string selectedSemester = "current";

    // Faculty Stats
    private FacultyAnalyticsDto facultyStats = new();
    private List<ProgramPerformanceDto> programPerformances = new();

    // Chart Data
    private List<SmuDonutChart.ChartDataSegment> gradeDistributionData = new();
    private List<SmuBarChart.ChartDataItem> programComparisonData = new();
    private List<SmuBarChart.ChartDataItem> studentsPerProgramData = new();
    private List<SmuBarChart.ChartDataItem> attendancePerProgramData = new();
    private List<SmuLineChart.ChartDataPoint> trendData = new();

    // At-Risk Students
    private List<AtRiskStudentDto> atRiskStudents = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            // Get authenticated user's faculty
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var facultyIdClaim = authState.User.FindFirst("FacultyId")?.Value;

            Guid facultyId;

            // Demo fallback: use first faculty if claim not found
            if (string.IsNullOrEmpty(facultyIdClaim) || !Guid.TryParse(facultyIdClaim, out facultyId))
            {
                // Demo: Use a hardcoded faculty ID (replace with actual logic)
                facultyId = Guid.NewGuid(); // This will fail gracefully, returning empty stats
            }

            // Load faculty stats
            facultyStats = await AnalyticsService.GetFacultyStatsAsync(facultyId);

            // Load program performances
            programPerformances = await AnalyticsService.GetProgramPerformancesAsync(facultyId);

            // Load grade distribution
            var gradeDistribution = await AnalyticsService.GetFacultyGradeDistributionAsync(facultyId);

            // Prepare chart data
            PrepareGradeDistributionData(gradeDistribution);
            PrepareProgramComparisonData();
            PrepareStudentsPerProgramData();
            PrepareAttendancePerProgramData();
            PrepareTrendData();
            PrepareAtRiskStudents();
        }
        catch (Exception ex)
        {
            // Log error (logger would be injected in real implementation)
            Console.WriteLine($"Error loading dean analytics: {ex.Message}");

            // Use demo data as fallback
            LoadDemoData();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void PrepareGradeDistributionData(GradeDistributionDto distribution)
    {
        gradeDistributionData = distribution.Distribution
            .OrderBy(kvp => kvp.Key)
            .Select(kvp => new SmuDonutChart.ChartDataSegment
            {
                Label = $"Nota {kvp.Key}",
                Value = kvp.Value,
                Color = GetGradeColor(kvp.Key)
            })
            .ToList();
    }

    private void PrepareProgramComparisonData()
    {
        programComparisonData = programPerformances
            .Select(p => new SmuBarChart.ChartDataItem
            {
                Label = p.ProgramCode,
                Value = p.AverageGrade
            })
            .ToList();
    }

    private void PrepareStudentsPerProgramData()
    {
        studentsPerProgramData = programPerformances
            .Select(p => new SmuBarChart.ChartDataItem
            {
                Label = p.ProgramCode,
                Value = p.StudentCount
            })
            .ToList();
    }

    private void PrepareAttendancePerProgramData()
    {
        attendancePerProgramData = programPerformances
            .Select(p => new SmuBarChart.ChartDataItem
            {
                Label = p.ProgramCode,
                Value = p.AttendanceRate
            })
            .ToList();
    }

    private void PrepareTrendData()
    {
        // Generate 6 months of historical data (demo)
        var now = DateTime.UtcNow;
        trendData = Enumerable.Range(0, 6)
            .Select(i => new SmuLineChart.ChartDataPoint
            {
                Date = now.AddMonths(-5 + i),
                Value = facultyStats.AverageGrade + (decimal)(new Random().NextDouble() * 0.5 - 0.25)
            })
            .ToList();
    }

    private void PrepareAtRiskStudents()
    {
        // This would come from a dedicated service method
        // For demo, create sample data
        atRiskStudents = new List<AtRiskStudentDto>
        {
            new() { Name = "Popescu Ion", ProgramName = "Informatica", Average = 4.5m, AttendanceRate = 55m, Risk = RiskLevel.Critical },
            new() { Name = "Ionescu Maria", ProgramName = "Matematica", Average = 5.8m, AttendanceRate = 62m, Risk = RiskLevel.High },
            new() { Name = "Vasilescu George", ProgramName = "Informatica", Average = 5.2m, AttendanceRate = 58m, Risk = RiskLevel.High }
        };
    }

    private async Task OnSemesterChanged()
    {
        await LoadDataAsync();
    }

    private string GetGradeColor(int grade)
    {
        return grade switch
        {
            >= 9 => "#10B981", // emerald-500
            >= 8 => "#84CC16", // lime-500
            >= 7 => "#F59E0B", // amber-500
            >= 6 => "#FB923C", // orange-400
            >= 5 => "#EF4444", // red-500
            _ => "#DC2626"     // red-600
        };
    }

    private void LoadDemoData()
    {
        facultyStats = new FacultyAnalyticsDto
        {
            FacultyName = "Facultatea de Informatica",
            StudentCount = 850,
            ProfessorCount = 42,
            ProgramCount = 5,
            AverageGrade = 7.65m,
            PassRate = 85.2m
        };

        programPerformances = new List<ProgramPerformanceDto>
        {
            new() { ProgramName = "Informatica", ProgramCode = "INF", StudentCount = 320, AverageGrade = 7.8m, AttendanceRate = 82m },
            new() { ProgramName = "Matematica", ProgramCode = "MAT", StudentCount = 180, AverageGrade = 7.5m, AttendanceRate = 78m },
            new() { ProgramName = "Informatica Aplicata", ProgramCode = "IA", StudentCount = 150, AverageGrade = 7.6m, AttendanceRate = 80m },
            new() { ProgramName = "Sisteme Distribuite", ProgramCode = "SD", StudentCount = 120, AverageGrade = 7.9m, AttendanceRate = 85m },
            new() { ProgramName = "Machine Learning", ProgramCode = "ML", StudentCount = 80, AverageGrade = 8.2m, AttendanceRate = 88m }
        };

        var demoDistribution = new GradeDistributionDto
        {
            Distribution = new Dictionary<int, int>
            {
                { 10, 45 }, { 9, 120 }, { 8, 180 }, { 7, 200 }, { 6, 150 },
                { 5, 80 }, { 4, 35 }, { 3, 20 }, { 2, 10 }, { 1, 5 }
            },
            TotalGrades = 845
        };

        PrepareGradeDistributionData(demoDistribution);
        PrepareProgramComparisonData();
        PrepareStudentsPerProgramData();
        PrepareAttendancePerProgramData();
        PrepareTrendData();
        PrepareAtRiskStudents();
    }

    // Helper DTO for at-risk students display
    private class AtRiskStudentDto
    {
        public string Name { get; set; } = string.Empty;
        public string ProgramName { get; set; } = string.Empty;
        public decimal Average { get; set; }
        public decimal AttendanceRate { get; set; }
        public RiskLevel Risk { get; set; }
    }
}
