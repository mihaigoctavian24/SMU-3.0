@page "/analytics/professor"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using SMU.Services
@using SMU.Components.Shared.Charts
@using static SMU.Components.Shared.Charts.SmuBarChart
@using static SMU.Components.Shared.Charts.SmuDonutChart
@attribute [Authorize(Roles = "Professor")]
@inject IAnalyticsService AnalyticsService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Analiza Cursuri - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenCard Style="background: linear-gradient(to right, var(--rz-primary), var(--rz-primary-dark)); padding: 1.5rem; color: white;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold; color: white;">Analiza Cursuri</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: rgba(255, 255, 255, 0.8);">@ProfessorName - Semestrul @CurrentSemester</RadzenText>
            </RadzenStack>
            <RadzenStack Gap="0.25rem" Style="text-align: right;">
                <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: rgba(255, 255, 255, 0.7);">An universitar</RadzenText>
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600; color: white;">@CurrentAcademicYear</RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (!HasProfessorId)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Contul nu este asociat cu un profil de profesor</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Contacteaza administratorul pentru a asocia contul cu profilul de profesor.</RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else if (!HasData)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" ShowIcon="true">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Nu exista date de analiza</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Nu ai inca cursuri sau note inregistrate in sistem.</RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <!-- Stats Overview Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Active Courses -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Cursuri Active</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@Stats.CourseCount</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-primary-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="menu_book" Style="font-size: 1.5rem; color: var(--rz-primary);" />
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Total Students -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Total Studenti</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@Stats.TotalStudents</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-success-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="groups" Style="font-size: 1.5rem; color: var(--rz-success);" />
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Average Grade Given -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Media Note Acordate</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@Stats.AverageGradeGiven.ToString("0.00")</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-warning-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="star" Style="font-size: 1.5rem; color: var(--rz-warning);" />
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Pending Grades -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Note in Asteptare</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@Stats.PendingGrades</RadzenText>
                        </RadzenStack>
                        <div style="@($"width: 3rem; height: 3rem; background: rgba(var(--rz-{(Stats.PendingGrades > 0 ? "danger" : "secondary")}-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;")">
                            <RadzenIcon Icon="schedule" Style="@($"font-size: 1.5rem; color: var(--rz-{(Stats.PendingGrades > 0 ? "danger" : "secondary")});")" />
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Main Charts Section -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Average Grade by Course -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <SmuBarChart
                        Title="Performanta per Curs"
                        Data="@PerformanceChartData"
                        YAxisLabel="Media"
                        Height="400"
                        Horizontal="false"
                        IsLoading="@IsLoading" />
                </RadzenCard>
            </RadzenColumn>

            <!-- Grade Distribution -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <SmuDonutChart
                        Title="Distributie Note Acordate"
                        Data="@GradeDistributionData"
                        Height="400"
                        ShowLegend="true"
                        IsLoading="@IsLoading" />
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Course Details Section -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Pass Rate by Course -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <SmuBarChart
                        Title="Rata Promovare per Curs"
                        Data="@PassRateChartData"
                        YAxisLabel="Rata Promovare (%)"
                        Height="400"
                        Horizontal="true"
                        IsLoading="@IsLoading" />
                </RadzenCard>
            </RadzenColumn>

            <!-- Attendance Rate by Course -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <SmuBarChart
                        Title="Prezenta per Curs"
                        Data="@AttendanceRateChartData"
                        YAxisLabel="Rata Prezenta (%)"
                        Height="400"
                        Horizontal="false"
                        IsLoading="@IsLoading" />
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Course Performance Table -->
        <RadzenCard Style="padding: 0; overflow: hidden;">
            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--rz-border-color);">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Detalii Performanta Cursuri</RadzenText>
            </div>
            @if (CoursePerformances.Any())
            {
                <RadzenDataGrid Data="@CoursePerformances" TItem="CoursePerformanceDto" AllowPaging="false" AllowSorting="true" Style="border: none;">
                    <Columns>
                        <RadzenDataGridColumn TItem="CoursePerformanceDto" Property="CourseName" Title="Curs">
                            <Template Context="course">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@course.CourseName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="CoursePerformanceDto" Property="CourseCode" Title="Cod" Width="120px">
                            <Template Context="course">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">@course.CourseCode</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="CoursePerformanceDto" Property="StudentCount" Title="Studenti" Width="110px" TextAlign="TextAlign.Center">
                            <Template Context="course">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@course.StudentCount</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="CoursePerformanceDto" Property="AverageGrade" Title="Media" Width="100px" TextAlign="TextAlign.Center">
                            <Template Context="course">
                                <RadzenBadge BadgeStyle="@GetGradeBadgeStyle(course.AverageGrade)" Text="@course.AverageGrade.ToString("0.00")" IsPill="true" />
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="CoursePerformanceDto" Property="PassRate" Title="Promovare" Width="120px" TextAlign="TextAlign.Center">
                            <Template Context="course">
                                <RadzenBadge BadgeStyle="@GetPassRateBadgeStyle(course.PassRate)" Text="@($"{course.PassRate:0}%")" IsPill="true" />
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="CoursePerformanceDto" Property="AttendanceRate" Title="Prezenta" Width="180px" TextAlign="TextAlign.Center">
                            <Template Context="course">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenProgressBar Value="@((double)course.AttendanceRate)" ShowValue="false" Style="width: 4rem; height: 0.5rem;" ProgressBarStyle="@GetAttendanceProgressStyle(course.AttendanceRate)" />
                                    <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@course.AttendanceRate.ToString("0")%</RadzenText>
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem;">
                    <RadzenIcon Icon="description" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: var(--rz-text-secondary-color);">Nu exista date disponibile</RadzenText>
                </RadzenStack>
            }
        </RadzenCard>
    }
</RadzenStack>

@code {
    private bool IsLoading = true;
    private bool HasProfessorId = false;
    private bool HasData = false;
    private string ProfessorName = "Profesor";
    private string CurrentSemester = "I";
    private string CurrentAcademicYear = "2024-2025";

    private ProfessorAnalyticsDto Stats = new();
    private List<CoursePerformanceDto> CoursePerformances = new();
    private GradeDistributionDto GradeDistribution = new();

    // Chart data
    private List<ChartDataItem> PerformanceChartData = new();
    private List<ChartDataSegment> GradeDistributionData = new();
    private List<ChartDataItem> PassRateChartData = new();
    private List<ChartDataItem> AttendanceRateChartData = new();

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                ProfessorName = user.FindFirst("FullName")?.Value ?? user.Identity.Name ?? "Profesor";

                // Set current academic context
                var now = DateTime.Now;
                CurrentSemester = (now.Month >= 2 && now.Month <= 6) ? "II" : "I";
                var year = now.Month >= 9 ? now.Year : now.Year - 1;
                CurrentAcademicYear = $"{year}-{year + 1}";

                // Get professor ID from claims
                var professorIdClaim = user.FindFirst("ProfessorId")?.Value;

                if (Guid.TryParse(professorIdClaim, out var professorId))
                {
                    HasProfessorId = true;
                    await LoadAnalyticsData(professorId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading professor analytics: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadAnalyticsData(Guid professorId)
    {
        Stats = await AnalyticsService.GetProfessorStatsAsync(professorId);
        CoursePerformances = await AnalyticsService.GetCoursePerformancesAsync(professorId);
        GradeDistribution = await AnalyticsService.GetProfessorGradeDistributionAsync(professorId);

        // Check if we have meaningful data
        HasData = Stats.CourseCount > 0 || Stats.TotalStudents > 0 || CoursePerformances.Any();

        if (HasData)
        {
            PrepareChartData();
        }
    }

    private void PrepareChartData()
    {
        // Performance chart - Average grade by course
        PerformanceChartData = CoursePerformances.Select(c => new ChartDataItem
        {
            Label = c.CourseCode,
            Value = c.AverageGrade
        }).ToList();

        // Grade distribution from real data
        var gradeColors = new Dictionary<int, string>
        {
            { 10, "#10B981" },  // emerald-500
            { 9, "#34D399" },   // emerald-400
            { 8, "#6EE7B7" },   // emerald-300
            { 7, "#F59E0B" },   // amber-500
            { 6, "#FBBF24" },   // amber-400
            { 5, "#FCD34D" },   // amber-300
            { 4, "#EF4444" },   // red-500
            { 3, "#DC2626" },   // red-600
            { 2, "#B91C1C" },   // red-700
            { 1, "#991B1B" }    // red-800
        };

        GradeDistributionData = GradeDistribution.Distribution
            .Where(kv => kv.Value > 0)
            .OrderByDescending(kv => kv.Key)
            .Select(kv => new ChartDataSegment
            {
                Label = kv.Key.ToString(),
                Value = kv.Value,
                Color = gradeColors.GetValueOrDefault(kv.Key, "#6B7280")
            }).ToList();

        // Pass rate chart
        PassRateChartData = CoursePerformances.Select(c => new ChartDataItem
        {
            Label = c.CourseCode,
            Value = c.PassRate
        }).ToList();

        // Attendance rate chart
        AttendanceRateChartData = CoursePerformances.Select(c => new ChartDataItem
        {
            Label = c.CourseCode,
            Value = c.AttendanceRate
        }).ToList();
    }

    private BadgeStyle GetGradeBadgeStyle(decimal grade)
    {
        if (grade >= 9) return BadgeStyle.Success;
        if (grade >= 7) return BadgeStyle.Info;
        if (grade >= 5) return BadgeStyle.Warning;
        return BadgeStyle.Danger;
    }

    private BadgeStyle GetPassRateBadgeStyle(decimal passRate)
    {
        if (passRate >= 80) return BadgeStyle.Success;
        if (passRate >= 60) return BadgeStyle.Info;
        if (passRate >= 50) return BadgeStyle.Warning;
        return BadgeStyle.Danger;
    }

    private ProgressBarStyle GetAttendanceProgressStyle(decimal attendanceRate)
    {
        if (attendanceRate >= 85) return ProgressBarStyle.Success;
        if (attendanceRate >= 70) return ProgressBarStyle.Info;
        if (attendanceRate >= 50) return ProgressBarStyle.Warning;
        return ProgressBarStyle.Danger;
    }
}
