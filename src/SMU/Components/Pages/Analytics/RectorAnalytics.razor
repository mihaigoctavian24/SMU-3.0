@page "/analytics/university"
@using SMU.Services
@using SMU.Components.Shared.Charts
@using Microsoft.AspNetCore.Authorization
@inject IAnalyticsService AnalyticsService
@attribute [Authorize(Roles = "Rector,Admin")]

<PageTitle>Dashboard Universitate | SMU</PageTitle>

<div class="space-y-6">
    <!-- Header Section -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Dashboard Universitate</h1>
            <p class="mt-1 text-sm text-gray-500">
                Analiza KPI-uri la nivel universitar - An Academic @currentAcademicYear
            </p>
        </div>
        <div class="flex items-center space-x-3">
            <button @onclick="ExportToPdf"
                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Export PDF
            </button>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="flex items-center justify-center h-96">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600"></div>
        </div>
    }
    else
    {
        <!-- University KPI Cards (6 cards, 2 rows of 3) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Total Students -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow border border-blue-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-blue-600">Total Studenti Activi</p>
                        <p class="mt-2 text-3xl font-bold text-blue-900">@universityStats.TotalStudents.ToString("N0")</p>
                    </div>
                    <div class="p-3 bg-blue-200 rounded-full">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Professors -->
            <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg shadow border border-emerald-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-emerald-600">Total Profesori</p>
                        <p class="mt-2 text-3xl font-bold text-emerald-900">@universityStats.TotalProfessors.ToString("N0")</p>
                    </div>
                    <div class="p-3 bg-emerald-200 rounded-full">
                        <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Faculty Count -->
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow border border-purple-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-purple-600">Numar Facultati</p>
                        <p class="mt-2 text-3xl font-bold text-purple-900">@universityStats.FacultyCount.ToString("N0")</p>
                    </div>
                    <div class="p-3 bg-purple-200 rounded-full">
                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Overall Average Grade -->
            <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg shadow border border-amber-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-amber-600">Media Generala Universitate</p>
                        <p class="mt-2 text-3xl font-bold text-amber-900">@universityStats.OverallAverage.ToString("F2")</p>
                    </div>
                    <div class="p-3 bg-amber-200 rounded-full">
                        <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Pass Rate -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow border border-green-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-green-600">Rata Promovare Globala</p>
                        <p class="mt-2 text-3xl font-bold text-green-900">@universityStats.PassRate.ToString("F1")%</p>
                    </div>
                    <div class="p-3 bg-green-200 rounded-full">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Total Programs -->
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg shadow border border-indigo-200 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-indigo-600">Total Programe Studiu</p>
                        <p class="mt-2 text-3xl font-bold text-indigo-900">@totalPrograms.ToString("N0")</p>
                    </div>
                    <div class="p-3 bg-indigo-200 rounded-full">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Faculty Comparison Section (Full Width) -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900">Comparatie Facultati - Media</h2>
            </div>

            <!-- Bar Chart with Trends -->
            <SmuBarChart
                Title="Media Academica per Facultate"
                Data="facultyAverageChartData"
                YAxisLabel="Media Note"
                Height="400"
                Horizontal="true"
                IsLoading="isLoading" />

            <!-- Trend Indicators -->
            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                @foreach (var faculty in facultyComparisons)
                {
                    <div class="flex items-center space-x-2 text-sm">
                        <span class="font-medium text-gray-700">@faculty.FacultyCode:</span>
                        @if (faculty.Trend == "ascending")
                        {
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            <span class="text-green-600">Crestere</span>
                        }
                        else if (faculty.Trend == "descending")
                        {
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                            </svg>
                            <span class="text-red-600">Scadere</span>
                        }
                        else
                        {
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14" />
                            </svg>
                            <span class="text-gray-600">Stabil</span>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Charts Row (2 columns) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Donut Chart: Student Distribution -->
            <SmuDonutChart
                Title="Distributie Studenti per Facultate"
                Data="studentDistributionData"
                Height="400"
                ShowLegend="true"
                IsLoading="isLoading" />

            <!-- Radar Chart: Multi-metric Comparison -->
            <SmuRadarChart
                Title="Metrici Comparative Facultati"
                Data="facultyMetricsData"
                Height="400"
                IsLoading="isLoading" />
        </div>

        <!-- Trends Section (Full Width) -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900">Evolutie Indicatori Universitari</h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">Perioada:</span>
                    <select @bind="selectedMonthRange" @bind:after="LoadTrendData"
                            class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="6">Ultimele 6 luni</option>
                        <option value="12">Ultimele 12 luni</option>
                    </select>
                </div>
            </div>

            <!-- Multi-line Chart -->
            <div class="space-y-4">
                @* Students Trend *@
                <SmuLineChart
                    Title="Total Studenti (Evolutie)"
                    Data="studentsTrendData"
                    YAxisLabel="Numar Studenti"
                    Height="300"
                    IsLoading="isLoading" />

                @* Average Grade Trend *@
                <SmuLineChart
                    Title="Media Generala (Evolutie)"
                    Data="averageGradeTrendData"
                    YAxisLabel="Media Note"
                    Height="300"
                    IsLoading="isLoading" />

                @* Pass Rate Trend *@
                <SmuLineChart
                    Title="Rata Promovare (Evolutie)"
                    Data="passRateTrendData"
                    YAxisLabel="Procent (%)"
                    Height="300"
                    IsLoading="isLoading" />
            </div>
        </div>

        <!-- Quick Summary Table -->
        <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Sinteza Facultati</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th @onclick='() => SortBy("name")'
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center space-x-1">
                                    <span>Facultate</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                </div>
                            </th>
                            <th @onclick='() => SortBy("students")'
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center space-x-1">
                                    <span>Studenti</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                </div>
                            </th>
                            <th @onclick='() => SortBy("professors")'
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center space-x-1">
                                    <span>Profesori</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                </div>
                            </th>
                            <th @onclick='() => SortBy("average")'
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center space-x-1">
                                    <span>Media</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                </div>
                            </th>
                            <th @onclick='() => SortBy("passrate")'
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center space-x-1">
                                    <span>Promovare (%)</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Trend
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @foreach (var faculty in GetSortedFaculties())
                        {
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">@faculty.FacultyName</div>
                                            <div class="text-sm text-gray-500">@faculty.FacultyCode</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    @faculty.StudentCount.ToString("N0")
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    @GetProfessorCount(faculty.FacultyCode).ToString("N0")
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="@GetGradeColorClass(faculty.AverageGrade) px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                        @faculty.AverageGrade.ToString("F2")
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="@GetPassRateColorClass(faculty.PassRate) px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                        @faculty.PassRate.ToString("F1")%
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    @if (faculty.Trend == "ascending")
                                    {
                                        <span class="inline-flex items-center text-green-600">
                                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                            </svg>
                                            Pozitiv
                                        </span>
                                    }
                                    else if (faculty.Trend == "descending")
                                    {
                                        <span class="inline-flex items-center text-red-600">
                                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
                                            </svg>
                                            Negativ
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="inline-flex items-center text-gray-500">
                                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14" />
                                            </svg>
                                            Stabil
                                        </span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string currentAcademicYear = "2024-2025";
    private int selectedMonthRange = 6;
    private string sortColumn = "students";
    private bool sortAscending = false;

    // University Statistics
    private UniversityAnalyticsDto universityStats = new();
    private List<FacultyComparisonDto> facultyComparisons = new();
    private TrendDataDto trendData = new();
    private int totalPrograms = 0;

    // Chart Data
    private List<SmuBarChart.ChartDataItem> facultyAverageChartData = new();
    private List<SmuDonutChart.ChartDataSegment> studentDistributionData = new();
    private List<SmuRadarChart.ChartDataCategory> facultyMetricsData = new();
    private List<SmuLineChart.ChartDataPoint> studentsTrendData = new();
    private List<SmuLineChart.ChartDataPoint> averageGradeTrendData = new();
    private List<SmuLineChart.ChartDataPoint> passRateTrendData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAllData();
    }

    private async Task LoadAllData()
    {
        isLoading = true;
        try
        {
            // Load university-wide statistics
            universityStats = await AnalyticsService.GetUniversityStatsAsync();
            facultyComparisons = await AnalyticsService.GetFacultyComparisonsAsync();

            await LoadTrendData();

            // Calculate total programs (demo: assume 3-5 programs per faculty)
            totalPrograms = universityStats.FacultyCount * 4;

            // Prepare chart data
            PrepareChartData();
        }
        catch (Exception ex)
        {
            // In production, log error and show user-friendly message
            Console.WriteLine($"Error loading rector analytics: {ex.Message}");

            // Demo data fallback for presentation
            LoadDemoData();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTrendData()
    {
        trendData = await AnalyticsService.GetUniversityTrendsAsync(selectedMonthRange);

        // Prepare trend chart data
        studentsTrendData = trendData.MonthlyData.Select(m => new SmuLineChart.ChartDataPoint
        {
            Date = m.Date,
            Value = m.TotalGrades // Using grades as proxy for student activity
        }).ToList();

        averageGradeTrendData = trendData.MonthlyData.Select(m => new SmuLineChart.ChartDataPoint
        {
            Date = m.Date,
            Value = m.AverageGrade
        }).ToList();

        passRateTrendData = trendData.MonthlyData.Select(m => new SmuLineChart.ChartDataPoint
        {
            Date = m.Date,
            Value = m.PassRate
        }).ToList();
    }

    private void PrepareChartData()
    {
        // Faculty Average Bar Chart
        facultyAverageChartData = facultyComparisons.Select(f => new SmuBarChart.ChartDataItem
        {
            Label = f.FacultyCode,
            Value = f.AverageGrade
        }).ToList();

        // Student Distribution Donut Chart
        studentDistributionData = facultyComparisons.Select(f => new SmuDonutChart.ChartDataSegment
        {
            Label = f.FacultyCode,
            Value = f.StudentCount,
            Color = null // Use default colors
        }).ToList();

        // Faculty Metrics Radar Chart (Multi-metric comparison)
        // We'll show average metrics across all faculties
        if (facultyComparisons.Any())
        {
            facultyMetricsData = new List<SmuRadarChart.ChartDataCategory>
            {
                new() { Category = "Media Note", Value = facultyComparisons.Average(f => f.AverageGrade) },
                new() { Category = "Rata Promovare", Value = facultyComparisons.Average(f => f.PassRate) / 10 }, // Scale to 0-10
                new() { Category = "Studenti/Facultate", Value = (decimal)facultyComparisons.Average(f => f.StudentCount) / 100 }, // Scale to 0-10
                new() { Category = "Performanta", Value = facultyComparisons.Average(f => (f.AverageGrade + f.PassRate / 10) / 2) }
            };
        }
    }

    private void LoadDemoData()
    {
        // Demo data for presentation when database is empty
        universityStats = new UniversityAnalyticsDto
        {
            TotalStudents = 4250,
            TotalProfessors = 312,
            FacultyCount = 8,
            OverallAverage = 7.82m,
            PassRate = 87.5m
        };

        totalPrograms = 32;

        facultyComparisons = new List<FacultyComparisonDto>
        {
            new() { FacultyCode = "FMI", FacultyName = "Matematica si Informatica", StudentCount = 850, AverageGrade = 8.2m, PassRate = 92.3m, Trend = "ascending" },
            new() { FacultyCode = "FEAA", FacultyName = "Economie", StudentCount = 920, AverageGrade = 7.8m, PassRate = 88.1m, Trend = "stable" },
            new() { FacultyCode = "FDSA", FacultyName = "Drept", StudentCount = 780, AverageGrade = 7.5m, PassRate = 85.2m, Trend = "ascending" },
            new() { FacultyCode = "FLSC", FacultyName = "Litere", StudentCount = 520, AverageGrade = 8.0m, PassRate = 90.5m, Trend = "stable" },
            new() { FacultyCode = "FMF", FacultyName = "Medicina", StudentCount = 630, AverageGrade = 8.5m, PassRate = 94.2m, Trend = "ascending" },
            new() { FacultyCode = "FEFS", FacultyName = "Sport", StudentCount = 340, AverageGrade = 7.2m, PassRate = 82.3m, Trend = "descending" },
            new() { FacultyCode = "FSE", FacultyName = "Stiinte", StudentCount = 410, AverageGrade = 7.9m, PassRate = 89.1m, Trend = "stable" },
            new() { FacultyCode = "FISTV", FacultyName = "Istorie", StudentCount = 400, AverageGrade = 7.6m, PassRate = 86.7m, Trend = "ascending" }
        };

        trendData = new TrendDataDto
        {
            MonthlyData = Enumerable.Range(0, selectedMonthRange).Select(i =>
            {
                var date = DateTime.Now.AddMonths(-selectedMonthRange + i + 1);
                return new MonthlyTrendPoint
                {
                    Date = date,
                    AverageGrade = 7.5m + (decimal)(new Random().NextDouble() * 0.8),
                    PassRate = 85m + (decimal)(new Random().NextDouble() * 8),
                    TotalGrades = 3800 + new Random().Next(-200, 300)
                };
            }).ToList()
        };

        PrepareChartData();
    }

    private List<FacultyComparisonDto> GetSortedFaculties()
    {
        var sorted = facultyComparisons.AsEnumerable();

        sorted = sortColumn switch
        {
            "name" => sortAscending ? sorted.OrderBy(f => f.FacultyName) : sorted.OrderByDescending(f => f.FacultyName),
            "students" => sortAscending ? sorted.OrderBy(f => f.StudentCount) : sorted.OrderByDescending(f => f.StudentCount),
            "professors" => sortAscending ? sorted.OrderBy(f => GetProfessorCount(f.FacultyCode)) : sorted.OrderByDescending(f => GetProfessorCount(f.FacultyCode)),
            "average" => sortAscending ? sorted.OrderBy(f => f.AverageGrade) : sorted.OrderByDescending(f => f.AverageGrade),
            "passrate" => sortAscending ? sorted.OrderBy(f => f.PassRate) : sorted.OrderByDescending(f => f.PassRate),
            _ => sorted.OrderByDescending(f => f.StudentCount)
        };

        return sorted.ToList();
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = false;
        }
    }

    private int GetProfessorCount(string facultyCode)
    {
        // Demo calculation: proportional to students
        var faculty = facultyComparisons.FirstOrDefault(f => f.FacultyCode == facultyCode);
        return faculty != null ? (int)(faculty.StudentCount * 0.08) : 0; // ~8% ratio
    }

    private string GetGradeColorClass(decimal grade)
    {
        return grade switch
        {
            >= 9.0m => "bg-green-100 text-green-800",
            >= 8.0m => "bg-blue-100 text-blue-800",
            >= 7.0m => "bg-yellow-100 text-yellow-800",
            >= 6.0m => "bg-orange-100 text-orange-800",
            _ => "bg-red-100 text-red-800"
        };
    }

    private string GetPassRateColorClass(decimal rate)
    {
        return rate switch
        {
            >= 90 => "bg-green-100 text-green-800",
            >= 80 => "bg-blue-100 text-blue-800",
            >= 70 => "bg-yellow-100 text-yellow-800",
            >= 60 => "bg-orange-100 text-orange-800",
            _ => "bg-red-100 text-red-800"
        };
    }

    private async Task ExportToPdf()
    {
        // Placeholder for PDF export functionality
        // This would use QuestPDF to generate a comprehensive report
        await Task.Delay(100);
        // TODO: Implement PDF generation with university KPIs, charts, and table
    }
}
