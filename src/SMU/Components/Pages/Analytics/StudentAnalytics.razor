@page "/analytics/student"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using SMU.Services
@using SMU.Data.Entities
@using SMU.Components.Shared.Charts
@attribute [Authorize(Roles = "Student")]

<PageTitle>Analiza Personala - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenCard Style="background: linear-gradient(to right, var(--rz-primary), var(--rz-primary-light)); padding: 1.5rem; color: white;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold; color: white;">Analiza Personala</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: rgba(255, 255, 255, 0.8);">@StudentName - @DateTime.Now.ToString("dd MMMM yyyy")</RadzenText>
            </RadzenStack>
            <RadzenIcon Icon="bar_chart" Style="font-size: 4rem; opacity: 0.2; color: white;" />
        </RadzenStack>
    </RadzenCard>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </RadzenStack>
    }
    else if (StudentId == Guid.Empty)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Nu esti asociat cu un profil de student</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Contul tau nu este asociat cu un profil de student in sistem.</RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else if (!HasData)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" ShowIcon="true">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Nu exista date de analiza</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Nu ai inca note sau prezente inregistrate. Datele vor aparea pe masura ce profesorii le introduc.</RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <!-- Stats Overview Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Media Generala -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Media Generala</RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@(Stats.AverageGrade > 0 ? Stats.AverageGrade.ToString("0.00") : "-")</RadzenText>
                                @if (GradeTrend != 0)
                                {
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="@(GradeTrend > 0 ? "trending_up" : "trending_down")" Style="@($"font-size: 1rem; color: var(--rz-{(GradeTrend > 0 ? "success" : "danger")});")" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="@($"margin: 0; color: var(--rz-{(GradeTrend > 0 ? "success" : "danger")});")">@Math.Abs(GradeTrend).ToString("0.0")%</RadzenText>
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-success-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="workspace_premium" Style="font-size: 1.5rem; color: var(--rz-success);" />
                        </div>
                    </RadzenStack>
                    <RadzenText TextStyle="TextStyle.Caption" Style="margin: 1rem 0 0 0; color: var(--rz-text-secondary-color);">@Stats.PassingGradeCount note promovate</RadzenText>
                </RadzenCard>
            </RadzenColumn>

            <!-- Rata Prezenta -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Rata Prezenta</RadzenText>
                            <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@Stats.AttendanceRate.ToString("0")%</RadzenText>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-primary-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="check_circle" Style="font-size: 1.5rem; color: var(--rz-primary);" />
                        </div>
                    </RadzenStack>
                    <RadzenStack Gap="0.25rem" Style="margin-top: 1rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">Progres</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@Stats.AttendanceRate.ToString("0")%</RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@((double)Stats.AttendanceRate)" ShowValue="false" Style="height: 0.5rem;" ProgressBarStyle="@GetAttendanceProgressStyle()" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Credite Acumulate -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Credite Acumulate</RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0; font-weight: bold;">@Stats.TotalCredits</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">/ 180</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                        <div style="width: 3rem; height: 3rem; background: rgba(var(--rz-info-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="menu_book" Style="font-size: 1.5rem; color: var(--rz-info);" />
                        </div>
                    </RadzenStack>
                    <RadzenStack Gap="0.25rem" Style="margin-top: 1rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">Progres</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">@((Stats.TotalCredits / 180m * 100).ToString("0"))%</RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@((double)(Stats.TotalCredits / 180m * 100))" ShowValue="false" Style="height: 0.5rem;" ProgressBarStyle="ProgressBarStyle.Info" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Nivel Risc -->
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="padding: 1.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Nivel Risc</RadzenText>
                            <RadzenText TextStyle="TextStyle.H4" Style="@($"margin: 0; font-weight: bold; color: var(--rz-{GetRiskColor()});")">@GetRiskLabel()</RadzenText>
                        </RadzenStack>
                        <div style="@($"width: 3rem; height: 3rem; background: rgba(var(--rz-{GetRiskColor()}-rgb), 0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;")">
                            <RadzenIcon Icon="shield" Style="@($"font-size: 1.5rem; color: var(--rz-{GetRiskColor()});")" />
                        </div>
                    </RadzenStack>
                    <RadzenText TextStyle="TextStyle.Caption" Style="margin: 1rem 0 0 0; color: var(--rz-text-secondary-color);">@Stats.CourseCount cursuri active</RadzenText>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Charts Row 1: Line Chart + Donut Chart -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Evolutie Medie -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Evolutie Medie</RadzenText>
                    @if (GradeEvolutionData.Any())
                    {
                        <SmuLineChart
                            Title=""
                            Data="@GradeEvolutionData"
                            YAxisLabel="Media"
                            Height="350"
                            IsLoading="@IsLoading" />
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem; background: var(--rz-base-200); border-radius: 0.5rem;">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Nu exista date suficiente pentru graficul evolutiei</RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>

            <!-- Distributie Note -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Distributie Note</RadzenText>
                    @if (GradeDistributionData.Any())
                    {
                        <SmuDonutChart
                            Title=""
                            Data="@GradeDistributionData"
                            Height="350"
                            ShowLegend="true"
                            IsLoading="@IsLoading" />
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem; background: var(--rz-base-200); border-radius: 0.5rem;">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Nu exista note pentru distributie</RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Charts Row 2: Radar Chart + Bar Chart -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Performanta per Curs -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Performanta per Curs</RadzenText>
                    @if (CoursePerformanceData.Any())
                    {
                        <SmuRadarChart
                            Title=""
                            Data="@CoursePerformanceData"
                            Height="400"
                            IsLoading="@IsLoading" />
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem; background: var(--rz-base-200); border-radius: 0.5rem;">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Nu exista date de performanta per curs</RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>

            <!-- Prezenta per Materie -->
            <RadzenColumn Size="12" SizeLG="6">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Prezenta per Materie</RadzenText>
                    @if (AttendanceByCourseData.Any())
                    {
                        <SmuBarChart
                            Title=""
                            Data="@AttendanceByCourseData"
                            YAxisLabel="Rata Prezenta (%)"
                            Height="400"
                            Horizontal="true"
                            IsLoading="@IsLoading" />
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem; background: var(--rz-base-200); border-radius: 0.5rem;">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Nu exista date de prezenta per materie</RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Heatmap Section -->
        @if (AttendanceHeatmapData.Any())
        {
            <RadzenCard Style="padding: 1.5rem;">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Calendar Prezente</RadzenText>
                <SmuHeatmapChart
                    Title=""
                    Data="@AttendanceHeatmapData"
                    Month="@DateTime.Now.Month"
                    Year="@DateTime.Now.Year"
                    Height="350"
                    IsLoading="@IsLoading" />
            </RadzenCard>
        }
    }
</RadzenStack>

@code {
    [Inject] private IAnalyticsService AnalyticsService { get; set; } = default!;
    [Inject] private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    private string StudentName = "Student";
    private Guid StudentId = Guid.Empty;
    private bool IsLoading = true;
    private bool HasData = false;
    private decimal GradeTrend = 0;

    // Stats
    private StudentAnalyticsDto Stats = new();

    // Chart Data
    private List<SmuLineChart.ChartDataPoint> GradeEvolutionData = new();
    private List<SmuDonutChart.ChartDataSegment> GradeDistributionData = new();
    private List<SmuRadarChart.ChartDataCategory> CoursePerformanceData = new();
    private List<SmuBarChart.ChartDataItem> AttendanceByCourseData = new();
    private Dictionary<DateTime, decimal> AttendanceHeatmapData = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;

            // Get authenticated user info
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            StudentName = user.FindFirst("FullName")?.Value ?? user.Identity?.Name ?? "Student";

            // Get StudentId from claims
            var studentIdClaim = user.FindFirst("StudentId")?.Value;
            if (Guid.TryParse(studentIdClaim, out var studentId))
            {
                StudentId = studentId;
                await LoadAnalyticsData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadAnalyticsData()
    {
        // Load student stats
        Stats = await AnalyticsService.GetStudentStatsAsync(StudentId);

        // Check if we have any meaningful data
        HasData = Stats.CourseCount > 0 || Stats.PassingGradeCount > 0 || Stats.FailingGradeCount > 0;

        if (!HasData) return;

        // Load grade evolution (12 months)
        var evolutionPoints = await AnalyticsService.GetGradeEvolutionAsync(StudentId, 12);
        GradeEvolutionData = evolutionPoints.Select(p => new SmuLineChart.ChartDataPoint
        {
            Date = p.Date,
            Value = p.Average
        }).ToList();

        // Calculate grade trend (comparing last 3 months to previous 3 months)
        if (evolutionPoints.Count >= 6)
        {
            var recentAvg = evolutionPoints.TakeLast(3).Average(p => p.Average);
            var previousAvg = evolutionPoints.Skip(Math.Max(0, evolutionPoints.Count - 6)).Take(3).Average(p => p.Average);
            GradeTrend = previousAvg > 0 ? ((recentAvg - previousAvg) / previousAvg * 100) : 0;
        }

        // Load attendance stats
        var attendanceStats = await AnalyticsService.GetAttendanceStatsAsync(StudentId);

        // Build grade distribution data from actual stats
        var totalGrades = Stats.PassingGradeCount + Stats.FailingGradeCount;
        if (totalGrades > 0)
        {
            GradeDistributionData = new List<SmuDonutChart.ChartDataSegment>
            {
                new() { Label = "Promovate (â‰¥5)", Value = Stats.PassingGradeCount, Color = "#10B981" },
                new() { Label = "Nepromovate (<5)", Value = Stats.FailingGradeCount, Color = "#EF4444" }
            };
        }

        // Build attendance by course data (from attendance stats)
        if (attendanceStats.RateByCourseType.Any())
        {
            AttendanceByCourseData = attendanceStats.RateByCourseType.Select(kvp => new SmuBarChart.ChartDataItem
            {
                Label = kvp.Key,
                Value = kvp.Value.Rate
            }).ToList();
        }

        // Note: CoursePerformanceData and AttendanceHeatmapData would require additional service methods
        // For now, these remain empty and the UI handles the empty state gracefully
    }

    private ProgressBarStyle GetAttendanceProgressStyle()
    {
        return Stats.AttendanceRate >= 85 ? ProgressBarStyle.Success :
               Stats.AttendanceRate >= 75 ? ProgressBarStyle.Warning :
               ProgressBarStyle.Danger;
    }

    private string GetRiskLabel()
    {
        return Stats.RiskLevel switch
        {
            RiskLevel.Low => "Scazut",
            RiskLevel.Medium => "Mediu",
            RiskLevel.High => "Ridicat",
            RiskLevel.Critical => "Critical",
            _ => "Necunoscut"
        };
    }

    private string GetRiskColor()
    {
        return Stats.RiskLevel switch
        {
            RiskLevel.Low => "success",
            RiskLevel.Medium => "warning",
            RiskLevel.High => "danger",
            RiskLevel.Critical => "danger",
            _ => "secondary"
        };
    }
}
