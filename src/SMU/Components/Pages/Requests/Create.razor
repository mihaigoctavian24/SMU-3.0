@page "/cereri/adauga"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Student")]
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject IDocumentRequestService RequestService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Cerere Nouă Document - SMU</PageTitle>

<div style="max-width: 800px; margin: 0 auto;">
    <RadzenStack Gap="1.5rem">
        <!-- Page Header -->
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenButton Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text"
                              Click="@(() => Navigation.NavigateTo("/cereri"))" />
                <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">
                    Cerere Nouă Document
                </RadzenText>
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Completează formularul pentru a solicita un document
            </RadzenText>
        </RadzenStack>

        <!-- Form Card -->
        <RadzenCard>
            <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <RadzenStack Gap="1.5rem">
                    <!-- Document Type -->
                    <RadzenFormField Text="Tip Document" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="Model.Type" Data="@documentTypes"
                                            TextProperty="Text" ValueProperty="Value"
                                            Placeholder="-- Selectează tipul documentului --"
                                            Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-danger">* Obligatoriu</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <!-- Document Type Descriptions -->
                    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" ShowIcon="true">
                        <RadzenStack Gap="0.75rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; font-weight: 600;">
                                Informații despre documentele disponibile:
                            </RadzenText>
                            <RadzenStack Gap="0.5rem">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">
                                        Adeverință de Student:
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                        Document care atestă calitatea de student activ
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">
                                        Adeverință cu Note:
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                        Document care conține situația academică (notele obținute)
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">
                                        Foaie Matricolă:
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                        Document oficial cu toate informațiile academice complete
                                    </RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">
                                        Altele:
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                        Alte tipuri de documente (specifică în observații)
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenAlert>

                    <!-- Notes -->
                    <RadzenFormField Text="Observații (opțional)" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextArea @bind-Value="Model.Notes" Rows="4"
                                            Placeholder="Adaugă detalii suplimentare despre cerere..."
                                            Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Dacă ai selectat "Altele", specifică aici ce document necesiți
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <!-- Error Message -->
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true">
                            @ErrorMessage
                        </RadzenAlert>
                    }

                    <!-- Success Message -->
                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" ShowIcon="true">
                            @SuccessMessage
                        </RadzenAlert>
                    }

                    <!-- Action Buttons -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Style="padding-top: 1rem;">
                        <RadzenButton Text="@(IsSubmitting ? "Se trimite..." : "Trimite Cererea")"
                                      Icon="@(IsSubmitting ? "" : "send")"
                                      ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit"
                                      Disabled="@IsSubmitting" Style="flex: 1;">
                            @if (IsSubmitting)
                            {
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate"
                                                           Size="ProgressBarCircularSize.Small" Style="width: 20px; height: 20px; margin-right: 8px;" />
                            }
                        </RadzenButton>
                        <RadzenButton Text="Anulează" Icon="close" ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => Navigation.NavigateTo("/cereri"))" Style="flex: 1;" />
                    </RadzenStack>
                </RadzenStack>
            </EditForm>
        </RadzenCard>
    </RadzenStack>
</div>

@code {
    private CreateDocumentRequestDto Model = new();
    private bool IsSubmitting = false;
    private string? ErrorMessage;
    private string? SuccessMessage;
    private Guid CurrentStudentId;

    private List<dynamic> documentTypes = new List<dynamic>
    {
        new { Text = "Adeverință de Student", Value = RequestType.StudentCertificate },
        new { Text = "Adeverință cu Note", Value = RequestType.GradeReport },
        new { Text = "Foaie Matricolă", Value = RequestType.EnrollmentProof },
        new { Text = "Altele", Value = RequestType.Other }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "");
            var student = await DbContext.Students.FirstOrDefaultAsync(s => s.UserId == userId);

            if (student == null)
            {
                ErrorMessage = "Nu s-a putut identifica studentul.";
                return;
            }

            CurrentStudentId = student.Id;
        }
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsSubmitting = true;

        try
        {
            var result = await RequestService.CreateAsync(Model, CurrentStudentId);

            if (result.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Cererea a fost trimisă cu succes!",
                    Duration = 4000
                });
                await Task.Delay(1500);
                Navigation.NavigateTo("/cereri");
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "A apărut o eroare la trimiterea cererii.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Eroare: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
