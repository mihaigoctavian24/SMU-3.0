@page "/cereri"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject IDocumentRequestService RequestService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Cereri Documente - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Page Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">
                @(CurrentRole == UserRole.Student ? "Cererile Mele" : "Cereri Documente")
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                @(CurrentRole == UserRole.Student ? "Gestionează cererile tale de documente" : "Procesează cererile studenților")
            </RadzenText>
        </RadzenStack>

        @if (CurrentRole == UserRole.Student)
        {
            <RadzenButton Text="Cerere Nouă" Icon="add" ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => Navigation.NavigateTo("/cereri/adauga"))" />
        }
    </RadzenStack>

    <!-- Filters (for Secretary/Admin) -->
    @if (CurrentRole != UserRole.Student)
    {
        <RadzenCard>
            <RadzenRow Gap="1rem" RowGap="1rem">
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenFormField Text="Tip Document" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="SelectedType" Data="@typeOptions" TextProperty="Text" ValueProperty="Value"
                                        Placeholder="Toate tipurile" Style="width: 100%;" />
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                        <RadzenDropDown @bind-Value="SelectedStatus" Data="@statusOptions" TextProperty="Text" ValueProperty="Value"
                                        Placeholder="Toate statusurile" Style="width: 100%;" />
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenStack Style="height: 100%;" JustifyContent="JustifyContent.End">
                        <RadzenButton Text="Aplică Filtre" Icon="filter_list" ButtonStyle="ButtonStyle.Primary"
                                      Click="@ApplyFilters" Style="width: 100%;" />
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    }

    <!-- Requests Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (IsLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                    Se încarcă cererile...
                </RadzenText>
            </RadzenStack>
        }
        else if (FilteredRequests.Count == 0)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="1rem">
                <RadzenIcon Icon="description" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Nu există cereri înregistrate</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                    @(CurrentRole == UserRole.Student ? "Creează prima ta cerere de documente." : "Nu există cereri în așteptare.")
                </RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenDataGrid @ref="grid" Data="@FilteredRequests" TItem="DocumentRequestDto"
                            AllowSorting="true" AllowPaging="false"
                            Style="border: none;">
                <Columns>
                    @if (CurrentRole != UserRole.Student)
                    {
                        <RadzenDataGridColumn TItem="DocumentRequestDto" Property="StudentName" Title="Student" Sortable="true">
                            <Template Context="request">
                                <RadzenStack Gap="0.125rem">
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@request.StudentName</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">@request.StudentNumber</RadzenText>
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    }

                    <RadzenDataGridColumn TItem="DocumentRequestDto" Property="TypeLabel" Title="Tip Document" Sortable="true" />

                    <RadzenDataGridColumn TItem="DocumentRequestDto" Property="Status" Title="Status" Width="130px" Sortable="true">
                        <Template Context="request">
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(request.Status)" Text="@request.StatusLabel" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="DocumentRequestDto" Property="CreatedAt" Title="Data Cererii" Width="150px" Sortable="true">
                        <Template Context="request">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                @request.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                            </RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    @if (CurrentRole != UserRole.Student)
                    {
                        <RadzenDataGridColumn TItem="DocumentRequestDto" Property="ProcessedByName" Title="Procesat De" Width="160px" Sortable="true">
                            <Template Context="request">
                                @if (request.ProcessedByName != null)
                                {
                                    <RadzenStack Gap="0.125rem">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@request.ProcessedByName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                            @request.ProcessedAt?.ToString("dd.MM.yyyy HH:mm")
                                        </RadzenText>
                                    </RadzenStack>
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">-</RadzenText>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    }

                    <RadzenDataGridColumn TItem="DocumentRequestDto" Title="Acțiuni" Width="180px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="request">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" JustifyContent="JustifyContent.End">
                                @if (CurrentRole == UserRole.Student && request.Status == RequestStatus.Pending)
                                {
                                    <RadzenButton Text="Anulează" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => CancelRequest(request.Id))" />
                                }
                                else if (CurrentRole != UserRole.Student && request.Status == RequestStatus.Pending)
                                {
                                    <RadzenButton Text="Procesează" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => Navigation.NavigateTo($"/cereri/proceseaza/{request.Id}"))" />
                                }
                                else if (CurrentRole != UserRole.Student && request.Status == RequestStatus.Approved)
                                {
                                    <RadzenButton Text="Finalizează" ButtonStyle="ButtonStyle.Success" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => CompleteRequest(request.Id))" />
                                }
                                @if (request.Status == RequestStatus.Completed && !string.IsNullOrEmpty(request.GeneratedDocumentPath))
                                {
                                    <RadzenButton Icon="download" ButtonStyle="ButtonStyle.Success" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => DownloadDocument(request.GeneratedDocumentPath))" />
                                }
                                @if (!string.IsNullOrEmpty(request.Notes))
                                {
                                    <RadzenButton Icon="info" ButtonStyle="ButtonStyle.Info" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => ShowDetails(request))" />
                                }
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenDataGrid<DocumentRequestDto>? grid;
    private List<DocumentRequestDto> Requests = new();
    private List<DocumentRequestDto> FilteredRequests = new();
    private bool IsLoading = true;
    private UserRole CurrentRole;
    private Guid CurrentUserId;
    private Guid? CurrentStudentId;

    // Filters
    private string? SelectedType;
    private string? SelectedStatus;

    // Filter options
    private List<dynamic> typeOptions = new List<dynamic>
    {
        new { Text = "Toate tipurile", Value = (string?)null },
        new { Text = "Adeverință de Student", Value = "StudentCertificate" },
        new { Text = "Adeverință cu Note", Value = "GradeReport" },
        new { Text = "Foaie Matricolă", Value = "EnrollmentProof" },
        new { Text = "Altele", Value = "Other" }
    };

    private List<dynamic> statusOptions = new List<dynamic>
    {
        new { Text = "Toate statusurile", Value = (string?)null },
        new { Text = "În așteptare", Value = "Pending" },
        new { Text = "În procesare", Value = "InProgress" },
        new { Text = "Aprobat", Value = "Approved" },
        new { Text = "Respins", Value = "Rejected" },
        new { Text = "Completat", Value = "Completed" }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "");
            var roleClaim = user.FindFirst("Role")?.Value;

            CurrentUserId = userId;
            CurrentRole = Enum.Parse<UserRole>(roleClaim ?? "Student");

            await LoadData();
        }
    }

    private async Task LoadData()
    {
        IsLoading = true;

        if (CurrentRole == UserRole.Student)
        {
            var student = await DbContext.Students.FirstOrDefaultAsync(s => s.UserId == CurrentUserId);
            if (student != null)
            {
                CurrentStudentId = student.Id;
                Requests = await RequestService.GetByStudentAsync(student.Id);
            }
        }
        else if (CurrentRole == UserRole.Secretary || CurrentRole == UserRole.Dean || CurrentRole == UserRole.Admin)
        {
            // Load all requests for staff, not just pending
            var filter = new DocumentRequestFilter();
            Requests = await RequestService.GetAllAsync(filter);
        }

        FilteredRequests = Requests;
        IsLoading = false;
    }

    private void ApplyFilters()
    {
        FilteredRequests = Requests;

        if (!string.IsNullOrEmpty(SelectedType))
        {
            var type = Enum.Parse<RequestType>(SelectedType);
            FilteredRequests = FilteredRequests.Where(r => r.Type == type).ToList();
        }

        if (!string.IsNullOrEmpty(SelectedStatus))
        {
            var status = Enum.Parse<RequestStatus>(SelectedStatus);
            FilteredRequests = FilteredRequests.Where(r => r.Status == status).ToList();
        }
    }

    private async Task CancelRequest(Guid requestId)
    {
        if (CurrentStudentId == null) return;

        var confirmed = await DialogService.Confirm(
            "Sigur doriți să anulați această cerere?",
            "Confirmare Anulare",
            new ConfirmOptions
            {
                OkButtonText = "Anulează Cererea",
                CancelButtonText = "Renunță"
            });

        if (confirmed == true)
        {
            var result = await RequestService.CancelAsync(requestId, CurrentStudentId.Value);
            if (result.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Cererea a fost anulată cu succes.",
                    Duration = 4000
                });
                await LoadData();
            }
            else
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = result.ErrorMessage ?? "Eroare la anularea cererii.",
                    Duration = 4000
                });
            }
        }
    }

    private async Task CompleteRequest(Guid requestId)
    {
        var confirmed = await DialogService.Confirm(
            "Sigur doriți să finalizați această cerere? Se va genera documentul PDF.",
            "Confirmare Finalizare",
            new ConfirmOptions
            {
                OkButtonText = "Finalizează",
                CancelButtonText = "Anulează"
            });

        if (confirmed == true)
        {
            var result = await RequestService.CompleteAsync(requestId, new CompleteDocumentRequestDto(), CurrentUserId);
            if (result.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Documentul a fost generat cu succes!",
                    Duration = 4000
                });
                await LoadData();
            }
            else
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = result.ErrorMessage ?? "Eroare la generarea documentului.",
                    Duration = 4000
                });
            }
        }
    }

    private async Task ShowDetails(DocumentRequestDto request)
    {
        await DialogService.OpenAsync<RequestDetailsDialog>("Detalii Cerere",
            new Dictionary<string, object> { { "Request", request } },
            new DialogOptions
            {
                Width = "500px",
                Height = "auto",
                CloseDialogOnOverlayClick = true
            });
    }

    private void DownloadDocument(string? documentPath)
    {
        if (string.IsNullOrEmpty(documentPath))
            return;

        Navigation.NavigateTo(documentPath, forceLoad: true);
    }

    private BadgeStyle GetStatusBadgeStyle(RequestStatus status) => status switch
    {
        RequestStatus.Pending => BadgeStyle.Warning,
        RequestStatus.InProgress => BadgeStyle.Info,
        RequestStatus.Approved => BadgeStyle.Success,
        RequestStatus.Rejected => BadgeStyle.Danger,
        RequestStatus.Completed => BadgeStyle.Success,
        _ => BadgeStyle.Light
    };
}
