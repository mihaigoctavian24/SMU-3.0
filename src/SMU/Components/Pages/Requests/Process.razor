@page "/cereri/proceseaza/{id:guid}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Secretary,Dean,Admin")]
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@inject IDocumentRequestService RequestService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService

<PageTitle>Procesare Cerere - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 900px; margin: 0 auto;">
    <!-- Page Header -->
    <RadzenStack Gap="0.5rem">
        <RadzenButton Text="Înapoi la Cereri" Icon="arrow_back" Variant="Variant.Text"
                      ButtonStyle="ButtonStyle.Secondary" Click="@(() => Navigation.NavigateTo("/cereri"))"
                      Style="align-self: flex-start; margin-bottom: 0.5rem;" />
        <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Procesare Cerere Document</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
            Aprobă sau respinge cererea studentului
        </RadzenText>
    </RadzenStack>

    @if (IsLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă...
            </RadzenText>
        </RadzenStack>
    }
    else if (Request == null)
    {
        <RadzenCard>
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" Style="padding: 2rem 0;">
                <RadzenIcon Icon="error_outline" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
                    Cererea nu a fost găsită.
                </RadzenText>
                <RadzenButton Text="Înapoi la lista de cereri" ButtonStyle="ButtonStyle.Primary"
                              Click="@(() => Navigation.NavigateTo("/cereri"))" />
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <!-- Request Details Card -->
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Detalii Cerere</RadzenText>

            <RadzenRow Gap="1.5rem" RowGap="1.5rem">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Student</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@Request.StudentName</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">@Request.StudentNumber</RadzenText>
                    </RadzenStack>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Tip Document</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@Request.TypeLabel</RadzenText>
                    </RadzenStack>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Status Curent</RadzenText>
                        <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(Request.Status)" Text="@Request.StatusLabel" IsPill="true" />
                    </RadzenStack>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Data Cererii</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@Request.CreatedAt.ToString("dd.MM.yyyy HH:mm")</RadzenText>
                    </RadzenStack>
                </RadzenColumn>

                @if (!string.IsNullOrEmpty(Request.Notes))
                {
                    <RadzenColumn Size="12">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Observații Student</RadzenText>
                            <RadzenCard Style="background-color: var(--rz-base-100); padding: 1rem; margin-top: 0.25rem;">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; white-space: pre-wrap;">@Request.Notes</RadzenText>
                            </RadzenCard>
                        </RadzenStack>
                    </RadzenColumn>
                }
            </RadzenRow>
        </RadzenCard>

        @if (Request.Status == RequestStatus.Pending)
        {
            <!-- Processing Form Card -->
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Procesare Cerere</RadzenText>

                <RadzenTemplateForm TItem="ProcessDocumentRequestDto" Data="@ProcessDto" Submit="@HandleSubmit">
                    <RadzenStack Gap="1.5rem">
                        <!-- Decision Radio Buttons -->
                        <RadzenStack Gap="0.75rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin: 0; font-weight: 500;">
                                Decizie <span style="color: var(--rz-danger);">*</span>
                            </RadzenText>

                            <RadzenRadioButtonList TValue="bool" @bind-Value="ProcessDto.Approved" Orientation="Orientation.Vertical">
                                <Items>
                                    <RadzenRadioButtonListItem TValue="bool" Value="true" Text="Aprobă Cererea" />
                                    <RadzenRadioButtonListItem TValue="bool" Value="false" Text="Respinge Cererea" />
                                </Items>
                            </RadzenRadioButtonList>
                        </RadzenStack>

                        <!-- Rejection Reason (shown only if rejecting) -->
                        @if (!ProcessDto.Approved)
                        {
                            <RadzenFormField Text="Motiv Respingere" Variant="Variant.Outlined" Style="width: 100%;">
                                <ChildContent>
                                    <RadzenTextArea @bind-Value="ProcessDto.RejectionReason" Rows="4"
                                                    Placeholder="Specifică motivul respingerii cererii..." Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                        Studentul va vedea acest mesaj
                                    </RadzenText>
                                </Helper>
                            </RadzenFormField>
                        }

                        <!-- Error Message -->
                        @if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true">
                                @ErrorMessage
                            </RadzenAlert>
                        }

                        <!-- Action Buttons -->
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem">
                            <RadzenButton Text="@(ProcessDto.Approved ? "Aprobă Cererea" : "Respinge Cererea")"
                                          ButtonType="ButtonType.Submit"
                                          ButtonStyle="@(ProcessDto.Approved ? ButtonStyle.Success : ButtonStyle.Danger)"
                                          Disabled="@IsSubmitting" Style="flex: 1;" />
                            <RadzenButton Text="Anulează" Variant="Variant.Outlined" ButtonStyle="ButtonStyle.Secondary"
                                          Click="@(() => Navigation.NavigateTo("/cereri"))" Style="flex: 1;" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenTemplateForm>
            </RadzenCard>
        }
        else
        {
            <!-- Already Processed Message -->
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" ShowIcon="true">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                        Această cerere a fost deja procesată.
                        @if (Request.ProcessedByName != null)
                        {
                            <text>Procesată de <strong>@Request.ProcessedByName</strong> pe @Request.ProcessedAt?.ToString("dd.MM.yyyy HH:mm").</text>
                        }
                    </RadzenText>
                </RadzenStack>
            </RadzenAlert>
        }
    }
</RadzenStack>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private DocumentRequestDto? Request;
    private ProcessDocumentRequestDto ProcessDto = new() { Approved = true };
    private bool IsLoading = true;
    private bool IsSubmitting = false;
    private string? ErrorMessage;
    private Guid CurrentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            CurrentUserId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "");
        }

        await LoadRequest();
    }

    private async Task LoadRequest()
    {
        IsLoading = true;
        Request = await RequestService.GetByIdAsync(Id);
        IsLoading = false;
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = null;

        // Validate rejection reason if rejecting
        if (!ProcessDto.Approved && string.IsNullOrWhiteSpace(ProcessDto.RejectionReason))
        {
            ErrorMessage = "Motivul respingerii este obligatoriu.";
            return;
        }

        var confirmed = await DialogService.Confirm(
            ProcessDto.Approved
                ? "Sigur doriți să aprobați această cerere?"
                : "Sigur doriți să respingeți această cerere?",
            "Confirmare",
            new ConfirmOptions { OkButtonText = "Da", CancelButtonText = "Nu" });

        if (confirmed != true) return;

        IsSubmitting = true;

        try
        {
            var result = await RequestService.ProcessAsync(Id, ProcessDto, CurrentUserId);

            if (result.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = ProcessDto.Approved
                        ? "Cererea a fost aprobată cu succes!"
                        : "Cererea a fost respinsă.",
                    Duration = 4000
                });
                Navigation.NavigateTo("/cereri");
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "A apărut o eroare la procesarea cererii.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Eroare: {ex.Message}";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private BadgeStyle GetStatusBadgeStyle(RequestStatus status) => status switch
    {
        RequestStatus.Pending => BadgeStyle.Warning,
        RequestStatus.InProgress => BadgeStyle.Info,
        RequestStatus.Approved => BadgeStyle.Success,
        RequestStatus.Rejected => BadgeStyle.Danger,
        RequestStatus.Completed => BadgeStyle.Success,
        _ => BadgeStyle.Light
    };

    private string GetDecisionCardStyle(bool isApprove)
    {
        var isSelected = isApprove == ProcessDto.Approved;
        var borderColor = isSelected
            ? (isApprove ? "var(--rz-success)" : "var(--rz-danger)")
            : "var(--rz-base-300)";
        var backgroundColor = isSelected
            ? (isApprove ? "var(--rz-success-lighter)" : "var(--rz-danger-lighter)")
            : "transparent";
        return $"border: 2px solid {borderColor}; background-color: {backgroundColor}; cursor: pointer; transition: all 0.2s;";
    }
}
