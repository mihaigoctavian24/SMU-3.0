@page "/grupe"
@using Microsoft.AspNetCore.Authorization
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Data.Entities
@attribute [Authorize(Policy = "CanManageGroups")]
@inject IGroupService GroupService
@inject IProgramService ProgramService
@inject NavigationManager Navigation
@inject Radzen.DialogService DialogService

<PageTitle>Grupe - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Grupe</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Gestionează grupele din universitate</RadzenText>
        </RadzenStack>
        <RadzenButton Text="Adaugă Grupă"
                      Icon="add"
                      ButtonStyle="ButtonStyle.Primary"
                      Click="@(() => Navigation.NavigateTo("/grupe/nou"))" />
    </RadzenStack>

    <!-- Filters & Search -->
    <RadzenCard Style="padding: 1.5rem;">
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenFormField Text="Căutare" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="searchTerm"
                                   Placeholder="Nume grupă..."
                                   @oninput="HandleSearchKeyUp" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Program Filter -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenFormField Text="Program" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedProgramId"
                                    Data="@programs"
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    AllowClear="true"
                                    Placeholder="Toate programele"
                                    Change="@(args => ApplyFilters())"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Status Filter -->
            <RadzenColumn Size="12" SizeMD="2">
                <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedStatus"
                                    Data="@statusOptions"
                                    TextProperty="Text"
                                    ValueProperty="Value"
                                    AllowClear="true"
                                    Placeholder="Toate"
                                    Change="@(args => ApplyFilters())"
                                    Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Export -->
            <RadzenColumn Size="12" SizeMD="3">
                <RadzenStack JustifyContent="JustifyContent.End" Style="height: 100%;">
                    <RadzenButton Text="Export CSV"
                                  Icon="download"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@ExportToCSV"
                                  Style="width: 100%;" />
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Groups Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            </RadzenStack>
        }
        else if (groups.Items.Any())
        {
            <RadzenDataGrid Data="@groups.Items" TItem="GroupListDto" AllowSorting="true" Style="border: none;">
                <Columns>
                    <RadzenDataGridColumn TItem="GroupListDto" Property="Name" Title="Nume" Sortable="true">
                        <Template Context="group">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@group.Name</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GroupListDto" Property="Year" Title="An" Width="80px">
                        <Template Context="group">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Anul @group.Year</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GroupListDto" Property="ProgramName" Title="Program" />

                    <RadzenDataGridColumn TItem="GroupListDto" Property="FacultyName" Title="Facultate" />

                    <RadzenDataGridColumn TItem="GroupListDto" Property="StudentsCount" Title="Studenți" Width="100px" TextAlign="TextAlign.Center">
                        <Template Context="group">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@group.StudentsCount</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GroupListDto" Property="MaxStudents" Title="Capacitate" Width="130px">
                        <Template Context="group">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@group.MaxStudents</RadzenText>
                                @if (group.StudentsCount >= group.MaxStudents)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Complet" IsPill="true" />
                                }
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GroupListDto" Property="IsActive" Title="Status" Width="100px">
                        <Template Context="group">
                            <RadzenBadge BadgeStyle="@(group.IsActive ? BadgeStyle.Success : BadgeStyle.Light)"
                                         Text="@(group.IsActive ? "Activ" : "Inactiv")"
                                         IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="GroupListDto" Title="Acțiuni" Width="180px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="group">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                                <RadzenButton Icon="visibility"
                                              ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/grupe/{group.Id}"))"
                                              title="Vezi" />
                                <RadzenButton Icon="edit"
                                              ButtonStyle="ButtonStyle.Light"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => Navigation.NavigateTo($"/grupe/{group.Id}/editare"))"
                                              title="Editează" />
                                <RadzenButton Icon="delete"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Variant="Variant.Text"
                                              Size="ButtonSize.Small"
                                              Click="@(() => ConfirmDelete(group.Id))"
                                              title="Șterge" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            <!-- Pagination -->
            <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--rz-border-color);">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Afișează</RadzenText>
                        <RadzenDropDown @bind-Value="pageSize"
                                        Data="@pageSizeOptions"
                                        Change="@(args => ApplyFilters())"
                                        Style="width: 80px;" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">din @groups.TotalCount grupe</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenButton Text="Anterior"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@PreviousPage"
                                      Disabled="@(!groups.HasPreviousPage)" />
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Pagina @groups.Page din @groups.TotalPages
                        </RadzenText>
                        <RadzenButton Text="Următorul"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@NextPage"
                                      Disabled="@(!groups.HasNextPage)" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        }
        else
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenIcon Icon="groups" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: var(--rz-text-secondary-color);">
                    Nu au fost găsite grupe
                </RadzenText>
            </RadzenStack>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private PagedResult<GroupListDto> groups = new();
    private List<StudyProgramListDto> programs = new();
    private bool isLoading = true;

    // Filters
    private string searchTerm = "";
    private Guid? selectedProgramId;
    private string? selectedStatus;
    private int currentPage = 1;
    private int pageSize = 25;

    // Options
    private List<int> pageSizeOptions = new() { 10, 25, 50 };
    private List<StatusOption> statusOptions = new()
    {
        new StatusOption { Text = "Activ", Value = "true" },
        new StatusOption { Text = "Inactiv", Value = "false" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadProgramsForFilter();
        await LoadGroups();
    }

    private async Task LoadProgramsForFilter()
    {
        var programsResult = await ProgramService.GetAllAsync(new StudyProgramFilter { IsActive = true }, 1, 100);
        programs = programsResult.Items;
    }

    private async Task LoadGroups()
    {
        isLoading = true;
        StateHasChanged();

        var filter = new GroupFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            ProgramId = selectedProgramId,
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        groups = await GroupService.GetAllAsync(filter, currentPage, pageSize);

        isLoading = false;
        StateHasChanged();
    }

    private System.Threading.Timer? searchTimer;

    private void HandleSearchKeyUp()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () => await LoadGroups());
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadGroups();
    }

    private async Task NextPage()
    {
        if (groups.HasNextPage)
        {
            currentPage++;
            await LoadGroups();
        }
    }

    private async Task PreviousPage()
    {
        if (groups.HasPreviousPage)
        {
            currentPage--;
            await LoadGroups();
        }
    }

    private async Task ConfirmDelete(Guid id)
    {
        var confirmed = await DialogService.Confirm(
            "Ești sigur că vrei să ștergi această grupă? Statusul va fi schimbat în \"Inactiv\".",
            "Confirmare Ștergere",
            new ConfirmOptions { OkButtonText = "Șterge", CancelButtonText = "Anulează" });

        if (confirmed == true)
        {
            var result = await GroupService.DeleteAsync(id);
            if (result.Succeeded)
            {
                await LoadGroups();
            }
        }
    }

    private async Task ExportToCSV()
    {
        var filter = new GroupFilter
        {
            Search = string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
            ProgramId = selectedProgramId,
            IsActive = string.IsNullOrWhiteSpace(selectedStatus) ? null : bool.Parse(selectedStatus)
        };

        var allGroups = await GroupService.ExportAsync(filter);

        var csv = "Nume,An,Program,Facultate,Studenți,Capacitate,Status\n";
        foreach (var group in allGroups)
        {
            csv += $"{group.Name},Anul {group.Year},{group.ProgramName},{group.FacultyName},{group.StudentsCount},{group.MaxStudents},{(group.IsActive ? "Activ" : "Inactiv")}\n";
        }

        Console.WriteLine($"CSV Export: {allGroups.Count} grupe");
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }

    private class StatusOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }
}
