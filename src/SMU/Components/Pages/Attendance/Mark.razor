@page "/prezente/marcheaza"
@using SMU.Services
@using SMU.Data.Entities
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IAttendanceService AttendanceService
@inject AuthService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService
@attribute [Authorize(Policy = "CanManageGrades")]

<PageTitle>Marchează Prezență - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 80rem; margin: 0 auto;">
    <!-- Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Marchează Prezență</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Înregistrează prezența studenților la curs</RadzenText>
        </RadzenStack>
        <RadzenLink Path="/prezente" Text="← Înapoi la Prezențe" Style="font-weight: 500;" />
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă...
            </RadzenText>
        </RadzenStack>
    }
    else
    {
        <!-- Progress Steps -->
        <RadzenCard>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                    <RadzenBadge BadgeStyle="@GetStepBadgeStyle(1)" Text="1. Curs" IsPill="true" />
                    <RadzenIcon Icon="chevron_right" />
                    <RadzenBadge BadgeStyle="@GetStepBadgeStyle(2)" Text="2. Dată" IsPill="true" />
                    <RadzenIcon Icon="chevron_right" />
                    <RadzenBadge BadgeStyle="@GetStepBadgeStyle(3)" Text="3. Studenți" IsPill="true" />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>

        <!-- Step Content -->
        @if (currentStep == 1)
        {
            <!-- Step 1: Select Course -->
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Selectează Cursul</RadzenText>
                    @if (!courses.Any())
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem 0;">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Nu aveți cursuri asociate.</RadzenText>
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenStack Gap="0.75rem">
                            @foreach (var course in courses)
                            {
                                <RadzenCard Style="@GetCourseCardStyle(course)" class="rz-border-radius-4" @onclick="@(() => SelectCourse(course))">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                        <RadzenStack Gap="0.25rem">
                                            <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 600;">@course.Name</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                                Cod: @course.Code | An @course.Year, Sem. @course.Semester
                                            </RadzenText>
                                        </RadzenStack>
                                        @if (selectedCourse?.Id == course.Id)
                                        {
                                            <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                                        }
                                    </RadzenStack>
                                </RadzenCard>
                            }
                        </RadzenStack>
                    }
                    @if (selectedCourse != null)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Style="margin-top: 1rem;">
                            <RadzenButton Text="Continuă" Icon="arrow_forward" ButtonStyle="ButtonStyle.Primary" Click="@NextStep" />
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenCard>
        }
        else if (currentStep == 2)
        {
            <!-- Step 2: Select Date -->
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Selectează Data</RadzenText>
                    <div style="max-width: 28rem;">
                        <RadzenStack Gap="0.25rem">
                            <RadzenLabel Text="Dată" />
                            <RadzenDatePicker @bind-Value="selectedDate" DateFormat="dd.MM.yyyy" Max="@DateTime.Now" Style="width: 100%;" />
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 0.5rem;">
                            Cursul selectat: <strong>@selectedCourse?.Name</strong>
                        </RadzenText>
                    </div>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" Style="margin-top: 1rem;">
                        <RadzenButton Text="Înapoi" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@PreviousStep" />
                        <RadzenButton Text="Continuă" Icon="arrow_forward" ButtonStyle="ButtonStyle.Primary" Click="@LoadStudents" Disabled="@(selectedDate == null)" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        }
        else if (currentStep == 3)
        {
            <!-- Step 3: Mark Attendance -->
            <RadzenCard>
                <RadzenStack Gap="1.5rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Marchează Prezența Studenților</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                @selectedCourse?.Name - @selectedDate?.ToString("dd.MM.yyyy")
                            </RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Toți Prezenți" Icon="check_circle" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                                          Click="@(() => MarkAll(AttendanceStatus.Present))" />
                            <RadzenButton Text="Toți Absenți" Icon="cancel" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                          Click="@(() => MarkAll(AttendanceStatus.Absent))" />
                        </RadzenStack>
                    </RadzenStack>

                    @if (isLoadingStudents)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        </RadzenStack>
                    }
                    else if (!students.Any())
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem 0;">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Nu există studenți înscriși la acest curs.</RadzenText>
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenDataGrid Data="@students" TItem="StudentInCourseDto"
                                        AllowSorting="true" AllowPaging="false">
                            <Columns>
                                <RadzenDataGridColumn TItem="StudentInCourseDto" Property="StudentName" Title="Student" />
                                <RadzenDataGridColumn TItem="StudentInCourseDto" Property="StudentNumber" Title="Nr. Matricol" Width="140px" />
                                <RadzenDataGridColumn TItem="StudentInCourseDto" Property="GroupName" Title="Grupă" Width="120px" />
                                <RadzenDataGridColumn TItem="StudentInCourseDto" Title="Status" Width="320px" TextAlign="TextAlign.Center">
                                    <Template Context="student">
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem">
                                            <RadzenButton Text="Prezent" Size="ButtonSize.Small"
                                                          ButtonStyle="@(GetStudentStatus(student) == AttendanceStatus.Present ? ButtonStyle.Success : ButtonStyle.Light)"
                                                          Variant="@(GetStudentStatus(student) == AttendanceStatus.Present ? Variant.Filled : Variant.Outlined)"
                                                          Click="@(() => SetStatus(student, AttendanceStatus.Present))" />
                                            <RadzenButton Text="Absent" Size="ButtonSize.Small"
                                                          ButtonStyle="@(GetStudentStatus(student) == AttendanceStatus.Absent ? ButtonStyle.Danger : ButtonStyle.Light)"
                                                          Variant="@(GetStudentStatus(student) == AttendanceStatus.Absent ? Variant.Filled : Variant.Outlined)"
                                                          Click="@(() => SetStatus(student, AttendanceStatus.Absent))" />
                                            <RadzenButton Text="Motivat" Size="ButtonSize.Small"
                                                          ButtonStyle="@(GetStudentStatus(student) == AttendanceStatus.Excused ? ButtonStyle.Info : ButtonStyle.Light)"
                                                          Variant="@(GetStudentStatus(student) == AttendanceStatus.Excused ? Variant.Filled : Variant.Outlined)"
                                                          Click="@(() => SetStatus(student, AttendanceStatus.Excused))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="StudentInCourseDto" Title="Notă" Width="200px">
                                    <Template Context="student">
                                        <RadzenTextBox @bind-Value="attendanceNotes[student.StudentId]" Placeholder="Opțional" Style="width: 100%;" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>

                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" Style="margin-top: 1rem;">
                            <RadzenButton Text="Înapoi" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@PreviousStep" />
                            <RadzenButton Text="@(isSaving ? "Se salvează..." : "Salvează Prezența")" Icon="save"
                                          ButtonStyle="ButtonStyle.Primary" Click="@SaveAttendance" Disabled="@isSaving" />
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenCard>
        }
    }
</RadzenStack>

@code {
    private bool isLoading = true;
    private bool isLoadingStudents = false;
    private bool isSaving = false;
    private bool showSuccess = false;
    private string? errorMessage;

    private Guid? currentProfessorId;
    private Guid? currentUserId;  // User ID for recording attendance (FK to asp_net_users)
    private int currentStep = 1;

    private List<CourseDto> courses = new();
    private CourseDto? selectedCourse;
    private DateOnly? selectedDate = DateOnly.FromDateTime(DateTime.Now);
    private List<StudentInCourseDto> students = new();

    private Dictionary<Guid, AttendanceStatus> attendanceStatuses = new();
    private Dictionary<Guid, string> attendanceNotes = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            // Use GetCurrentUserWithProfessorAsync to properly load Professor navigation property
            var appUser = await AuthService.GetCurrentUserWithProfessorAsync(user);
            if (appUser?.Professor != null)
            {
                currentProfessorId = appUser.Professor.Id;
                currentUserId = appUser.Id;  // Store the User ID for FK constraint
                courses = await AttendanceService.GetProfessorCoursesAsync(currentProfessorId.Value);
            }
        }

        isLoading = false;
    }

    private void SelectCourse(CourseDto course)
    {
        selectedCourse = course;
    }

    private void NextStep()
    {
        currentStep++;
    }

    private void PreviousStep()
    {
        currentStep--;
    }

    private async Task LoadStudents()
    {
        if (selectedCourse == null || selectedDate == null) return;

        currentStep = 3;
        isLoadingStudents = true;

        students = await AttendanceService.GetStudentsInCourseAsync(selectedCourse.Id);

        // Load existing attendance if any
        var existingAttendances = await AttendanceService.GetByCourseDateAsync(selectedCourse.Id, selectedDate.Value);

        attendanceStatuses.Clear();
        attendanceNotes.Clear();

        foreach (var student in students)
        {
            var existing = existingAttendances.FirstOrDefault(a => a.StudentId == student.StudentId);
            if (existing != null)
            {
                attendanceStatuses[student.StudentId] = existing.Status;
                attendanceNotes[student.StudentId] = existing.Notes ?? string.Empty;
            }
            else
            {
                attendanceStatuses[student.StudentId] = AttendanceStatus.Absent;
                attendanceNotes[student.StudentId] = string.Empty;
            }
        }

        isLoadingStudents = false;
    }

    private void SetStatus(StudentInCourseDto student, AttendanceStatus status)
    {
        attendanceStatuses[student.StudentId] = status;
    }

    private AttendanceStatus GetStudentStatus(StudentInCourseDto student)
    {
        return attendanceStatuses.GetValueOrDefault(student.StudentId, AttendanceStatus.Absent);
    }

    private void MarkAll(AttendanceStatus status)
    {
        foreach (var student in students)
        {
            attendanceStatuses[student.StudentId] = status;
        }
    }

    private async Task SaveAttendance()
    {
        if (selectedCourse == null || selectedDate == null || !currentUserId.HasValue)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Eroare",
                Detail = "Date incomplete pentru salvare.",
                Duration = 4000
            });
            return;
        }

        isSaving = true;
        errorMessage = null;

        try
        {
            var bulkDto = new BulkAttendanceDto
            {
                CourseId = selectedCourse.Id,
                Date = selectedDate.Value,
                Attendances = students.Select(s => new StudentAttendanceDto
                {
                    StudentId = s.StudentId,
                    Status = GetStudentStatus(s),
                    Notes = attendanceNotes.GetValueOrDefault(s.StudentId)
                }).ToList()
            };

            // Pass User ID (not Professor ID) - recorded_by FK references asp_net_users
            var result = await AttendanceService.BulkMarkAsync(bulkDto, currentUserId.Value);

            if (result.Succeeded)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Prezența a fost salvată cu succes!",
                    Duration = 4000
                });
                await Task.Delay(1000);
                Navigation.NavigateTo("/prezente");
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = result.ErrorMessage ?? "Eroare la salvarea prezenței.",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Eroare",
                Detail = "Eroare la salvarea prezenței: " + ex.Message,
                Duration = 4000
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    private BadgeStyle GetStepBadgeStyle(int step)
    {
        if (step == currentStep) return BadgeStyle.Primary;
        if (step < currentStep) return BadgeStyle.Success;
        return BadgeStyle.Light;
    }

    private string GetCourseCardStyle(CourseDto course)
    {
        var isSelected = selectedCourse?.Id == course.Id;
        return isSelected
            ? "cursor: pointer; border: 2px solid var(--rz-primary); background: var(--rz-primary-lighter);"
            : "cursor: pointer; border: 2px solid var(--rz-border-color);";
    }
}
