@using SMU.Components.Shared
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject IGradeService GradeService
@inject IScheduleService ScheduleService
@inject INotificationService NotificationService
@inject IStudentService StudentService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<RadzenStack Gap="1.5rem">
    @if (_isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă datele...
            </RadzenText>
        </RadzenStack>
    }
    else if (_studentId == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">
                    Nu ești autentificat ca student
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                    Contul tău nu este asociat cu un profil de student.
                </RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <!-- Welcome Header -->
        <RadzenCard Style="background: linear-gradient(135deg, var(--rz-primary) 0%, var(--rz-primary-dark) 100%); padding: 1.5rem;">
            <RadzenStack>
                <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; color: white; font-weight: 700;">
                    Bine ai venit, @UserName!
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: rgba(255,255,255,0.85);">
                    Iată un sumar al activității tale academice.
                </RadzenText>
            </RadzenStack>
        </RadzenCard>

        <!-- Stats Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Media Generală"
                    Value="@(AverageGrade > 0 ? AverageGrade.ToString("0.00") : "-")"
                    Subtitle="@(TotalCredits > 0 ? $"{TotalCredits} credite acumulate" : "Nicio notă înregistrată")"
                    IconType="academic"
                    IconBgClass="bg-success-100"
                    IconClass="text-success-600"
                    ShowTrend="@(GradeTrend != 0)"
                    TrendValue="@GradeTrend"
                    ActionLink="/note"
                    ActionText="Vezi toate notele" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Rata Prezență"
                    Value="@(AttendanceRate.ToString("0") + "%")"
                    Subtitle="@(TotalClasses > 0 ? $"{PresentClasses}/{TotalClasses} ore" : "Nicio prezență")"
                    IconType="attendance"
                    IconBgClass="bg-primary-100"
                    IconClass="text-primary-600"
                    ActionLink="/prezente"
                    ActionText="Vezi prezențele" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Credite Acumulate"
                    Value="@TotalCredits.ToString()"
                    Subtitle="@($"din {RequiredCredits} necesare")"
                    IconType="book"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Note Recente"
                    Value="@RecentGradesCount.ToString()"
                    Subtitle="în ultimele 30 de zile"
                    IconType="grades"
                    IconBgClass="bg-warning-100"
                    IconClass="text-warning-600"
                    ActionLink="/note"
                    ActionText="Vezi notele" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Content Grid -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Recent Grades -->
            <RadzenColumn Size="12" SizeLG="8">
                <RecentActivityList
                    Title="Ultimele Note"
                    Items="@RecentGrades"
                    ViewAllLink="/note"
                    EmptyMessage="Nu ai note înregistrate încă." />
            </RadzenColumn>

            <!-- Quick Actions & Notifications -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenStack Gap="1.5rem">
                    <!-- Quick Actions -->
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">
                            Acțiuni Rapide
                        </RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <QuickActionButton
                                Text="Vezi Orarul"
                                IconType="calendar"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/orar" />
                            <QuickActionButton
                                Text="Cererile Mele"
                                IconType="document"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/cereri" />
                            <QuickActionButton
                                Text="Solicită Document"
                                IconType="document"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/cereri/nou" />
                            <QuickActionButton
                                Text="Vezi Prezențele"
                                IconType="check"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/prezente" />
                        </RadzenStack>
                    </RadzenCard>

                    <!-- Notifications -->
                    <RadzenCard Style="padding: 0; overflow: hidden;">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                     Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Notificări</RadzenText>
                        </RadzenStack>
                        @if (Notifications.Any())
                        {
                            <RadzenStack Gap="0">
                                @foreach (var notification in Notifications.Take(3))
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="0.75rem"
                                                 Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-200);">
                                        <div style="@($"width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; background: {(notification.IsRead ? "var(--rz-base-400)" : "var(--rz-primary)")};")"></div>
                                        <RadzenStack Gap="0.25rem" Style="flex: 1; min-width: 0; cursor: pointer;"
                                                     Class="notification-content"
                                                     @onclick="@(() => HandleNotificationClick(notification))">
                                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                @notification.Title
                                            </RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-disabled-color);">
                                                @notification.CreatedAt.ToString("dd MMM, HH:mm")
                                            </RadzenText>
                                        </RadzenStack>
                                        <RadzenButton Icon="close"
                                                      ButtonStyle="ButtonStyle.Light"
                                                      Variant="Variant.Text"
                                                      Size="ButtonSize.Small"
                                                      Click="@(async (args) => await HandleDeleteNotification(notification.Id, args))"
                                                      Style="min-width: auto; padding: 0.25rem;" />
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        }
                        else
                        {
                            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="0.75rem">
                                <RadzenIcon Icon="notifications_none" Style="font-size: 40px; color: var(--rz-text-disabled-color);" />
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                    Nu ai notificări noi
                                </RadzenText>
                            </RadzenStack>
                        }
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

        <!-- Upcoming Schedule -->
        <RadzenCard Style="padding: 0; overflow: hidden;">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                         Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Orarul de Azi</RadzenText>
                <RadzenLink Path="/orar" Text="Vezi tot orarul" Style="font-weight: 500;" />
            </RadzenStack>
            @if (TodaySchedule.Any())
            {
                <RadzenStack Gap="0">
                    @foreach (var entry in TodaySchedule)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem"
                                     Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-200);">
                            <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600; width: 60px; text-align: center;">
                                @entry.StartTime.ToString(@"hh\:mm")
                            </RadzenText>
                            <div style="width: 4px; height: 48px; border-radius: 2px; background: var(--rz-primary);"></div>
                            <RadzenStack Gap="0.25rem" Style="flex: 1;">
                                <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">
                                    @entry.CourseName
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                    @entry.Room - @entry.TypeLabel
                                </RadzenText>
                            </RadzenStack>
                            <RadzenBadge BadgeStyle="@GetScheduleBadgeStyle(entry.Type)" Text="@entry.TypeLabel" IsPill="true" />
                        </RadzenStack>
                    }
                </RadzenStack>
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="1rem">
                    <RadzenIcon Icon="event_available" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" Style="margin: 0;">
                        Nu ai ore programate astăzi
                    </RadzenText>
                </RadzenStack>
            }
        </RadzenCard>
    }
</RadzenStack>

@code {
    [Parameter] public string UserName { get; set; } = "Student";

    // State
    private bool _isLoading = true;
    private Guid? _studentId;
    private Guid? _userId;

    // Stats
    private decimal AverageGrade = 0;
    private decimal GradeTrend = 0;
    private int TotalCredits = 0;
    private int RequiredCredits = 180;
    private decimal AttendanceRate = 0;
    private int PresentClasses = 0;
    private int TotalClasses = 0;
    private int RecentGradesCount = 0;

    // Data
    private List<RecentActivityList.ActivityItem> RecentGrades = new();
    private List<NotificationDto> Notifications = new();
    private List<ScheduleEntryDto> TodaySchedule = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Get current user claims
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Get StudentId from claims
            var studentIdClaim = user.FindFirst("StudentId")?.Value;
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (Guid.TryParse(studentIdClaim, out var studentId))
            {
                _studentId = studentId;
            }

            if (Guid.TryParse(userIdClaim, out var userId))
            {
                _userId = userId;
            }

            if (_studentId == null)
            {
                _isLoading = false;
                return;
            }

            // Load student details for stats
            var studentDetail = await StudentService.GetByIdAsync(_studentId.Value);
            if (studentDetail != null)
            {
                AverageGrade = studentDetail.AverageGrade ?? 0;
                AttendanceRate = studentDetail.AttendanceRate;
                TotalCredits = studentDetail.TotalCredits;
            }

            // Load grades
            var grades = await GradeService.GetByStudentAsync(_studentId.Value);
            var recentThreshold = DateOnly.FromDateTime(DateTime.UtcNow.AddDays(-30));
            var recentGradesList = grades.Where(g => g.ExamDate >= recentThreshold).ToList();
            RecentGradesCount = recentGradesList.Count;

            // Map grades to activity items
            RecentGrades = grades
                .OrderByDescending(g => g.ExamDate)
                .Take(5)
                .Select(g => new RecentActivityList.ActivityItem
                {
                    Title = g.CourseName,
                    Description = $"Nota: {g.Value} - {GetTypeLabel(g.Type)}",
                    Timestamp = g.ExamDate.ToDateTime(TimeOnly.MinValue),
                    Type = "grade",
                    Badge = g.Value.ToString("0"),
                    BadgeType = g.Value >= 5 ? "success" : "danger"
                })
                .ToList();

            // Load notifications
            if (_userId.HasValue)
            {
                Notifications = await NotificationService.GetRecentAsync(_userId.Value, 5);
            }

            // Load today's schedule
            TodaySchedule = await ScheduleService.GetTodayScheduleForStudentAsync(_studentId.Value);

            // Calculate attendance stats from student detail
            if (studentDetail != null)
            {
                PresentClasses = (int)Math.Round(studentDetail.AttendanceRate * studentDetail.GradesCount / 100);
                TotalClasses = studentDetail.GradesCount; // Approximation
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private BadgeStyle GetScheduleBadgeStyle(string type) => type switch
    {
        "Curs" => BadgeStyle.Primary,
        "Laborator" => BadgeStyle.Success,
        "Seminar" => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    private string GetTypeLabel(Data.Entities.GradeType type) => type switch
    {
        Data.Entities.GradeType.Exam => "Examen",
        Data.Entities.GradeType.Lab => "Laborator",
        Data.Entities.GradeType.Seminar => "Seminar",
        Data.Entities.GradeType.Project => "Proiect",
        Data.Entities.GradeType.Final => "Final",
        _ => type.ToString()
    };

    private async Task HandleNotificationClick(NotificationDto notification)
    {
        // Mark notification as read
        if (!notification.IsRead)
        {
            await NotificationService.MarkAsReadAsync(notification.Id);
            notification.IsRead = true;
        }

        // Navigate to link if provided
        if (!string.IsNullOrEmpty(notification.Link))
        {
            NavigationManager.NavigateTo(notification.Link);
        }
    }

    private async Task HandleDeleteNotification(Guid notificationId, MouseEventArgs args)
    {
        // Stop event propagation to prevent clicking the notification
        // (Blazor doesn't support stopPropagation directly, but the button click will be handled first)

        var result = await NotificationService.DeleteAsync(notificationId);

        if (result.Succeeded)
        {
            // Remove from local list to update UI
            Notifications.RemoveAll(n => n.Id == notificationId);
            StateHasChanged();
        }
    }

    private void OnNotificationHover(MouseEventArgs args, bool isEntering)
    {
        // Could add hover effects via JavaScript if needed
    }
}

<style>
    .notification-content {
        transition: background-color 0.2s ease;
    }

    .notification-content:hover {
        background-color: var(--rz-base-100) !important;
    }

    .notification-content:active {
        background-color: var(--rz-base-200) !important;
    }
</style>
