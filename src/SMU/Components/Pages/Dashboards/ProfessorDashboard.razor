@using SMU.Components.Shared
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject ICourseService CourseService
@inject IGradeService GradeService
@inject IScheduleService ScheduleService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<RadzenStack Gap="1.5rem">
    @if (_isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă datele...
            </RadzenText>
        </RadzenStack>
    }
    else if (_professorId == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="warning" Style="font-size: 48px;" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Nu ești autentificat ca profesor</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                    Contul tău nu este asociat cu un profil de profesor.
                </RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <!-- Welcome Header -->
        <RadzenCard Style="background: linear-gradient(135deg, var(--rz-secondary) 0%, var(--rz-secondary-dark, #1e40af) 100%); color: white; padding: 1.5rem;">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: white; font-weight: 700;">
                Bună ziua, Prof. @UserName!
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                Iată un sumar al activității dumneavoastră didactice.
            </RadzenText>
        </RadzenCard>

        <!-- Stats Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Cursuri Active"
                    Value="@ActiveCourses.ToString()"
                    Subtitle="în acest semestru"
                    IconType="book"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600"
                    ActionLink="/cursuri"
                    ActionText="Vezi cursurile" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Total Studenți"
                    Value="@TotalStudents.ToString()"
                    Subtitle="înscriși la cursuri"
                    IconType="users"
                    IconBgClass="bg-primary-100"
                    IconClass="text-primary-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Note de Introdus"
                    Value="@PendingGrades.ToString()"
                    Subtitle="@(PendingGrades > 0 ? "necesită atenție" : "totul la zi")"
                    IconType="grades"
                    IconBgClass="@(PendingGrades > 0 ? "bg-warning-100" : "bg-success-100")"
                    IconClass="@(PendingGrades > 0 ? "text-warning-600" : "text-success-600")"
                    ActionLink="/note/adauga"
                    ActionText="Adaugă note" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Ore Azi"
                    Value="@TodaySchedule.Count.ToString()"
                    Subtitle="ore programate"
                    IconType="attendance"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600"
                    ActionLink="/orar"
                    ActionText="Vezi orarul" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Content Grid -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Courses List -->
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenCard Style="padding: 0; overflow: hidden;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                 Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Cursurile Mele</RadzenText>
                        <RadzenLink Path="/cursuri" Text="Vezi toate" Style="font-weight: 500;" />
                    </RadzenStack>
                    @if (Courses.Any())
                    {
                        <RadzenStack Gap="0">
                            @foreach (var course in Courses.Take(5))
                            {
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                             Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-200); cursor: pointer;"
                                             @onclick="() => NavigateToCourse(course.Id)">
                                    <RadzenStack Gap="0.25rem" Style="flex: 1;">
                                        <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">@course.Name</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                            @course.ProgramName - Anul @course.Year
                                        </RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                        <RadzenStack Gap="0.125rem" Style="text-align: right;">
                                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@course.StudentsCount studenți</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">@course.Credits credite</RadzenText>
                                        </RadzenStack>
                                        <RadzenIcon Icon="chevron_right" Style="color: var(--rz-text-secondary-color);" />
                                    </RadzenStack>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="0.75rem">
                            <RadzenIcon Icon="menu_book" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                Nu aveți cursuri asignate
                            </RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>

            <!-- Quick Actions & Today's Schedule -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenStack Gap="1.5rem">
                    <!-- Quick Actions -->
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Acțiuni Rapide</RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <QuickActionButton
                                Text="Adaugă Note"
                                IconType="plus"
                                Variant="primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/note/adauga" />
                            <QuickActionButton
                                Text="Marchează Prezențe"
                                IconType="check"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/prezente/marcheaza" />
                            <QuickActionButton
                                Text="Vezi Orarul"
                                IconType="calendar"
                                Variant="outline"
                                FullWidth="true"
                                IsLink="true"
                                Link="/orar" />
                        </RadzenStack>
                    </RadzenCard>

                    <!-- Today's Schedule -->
                    <RadzenCard Style="padding: 0; overflow: hidden;">
                        <RadzenStack Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Orarul de Azi</RadzenText>
                        </RadzenStack>
                        @if (TodaySchedule.Any())
                        {
                            <RadzenStack Gap="0">
                                @foreach (var entry in TodaySchedule)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem"
                                                 Class="rz-p-3" Style="border-bottom: 1px solid var(--rz-base-200);">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500; width: 50px;">
                                            @entry.StartTime.ToString(@"hh\:mm")
                                        </RadzenText>
                                        <div style="@GetScheduleBarStyle(entry.Type)"></div>
                                        <RadzenStack Gap="0.125rem" Style="flex: 1;">
                                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@entry.CourseName</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                                @entry.Room - @entry.GroupName
                                            </RadzenText>
                                        </RadzenStack>
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        }
                        else
                        {
                            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-4">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                    Nu aveți ore programate astăzi
                                </RadzenText>
                            </RadzenStack>
                        }
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

        <!-- Pending Actions -->
        @if (PendingGrades > 0 || PendingAttendance > 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">Acțiuni în Așteptare</RadzenText>
                    <RadzenStack Gap="0.25rem">
                        @if (PendingGrades > 0)
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                • @PendingGrades note de introdus pentru evaluările recente
                            </RadzenText>
                        }
                        @if (PendingAttendance > 0)
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                                • @PendingAttendance ore cu prezențe nemarcate
                            </RadzenText>
                        }
                    </RadzenStack>
                </RadzenStack>
            </RadzenAlert>
        }
    }
</RadzenStack>

@code {
    [Parameter] public string UserName { get; set; } = "Profesor";

    // State
    private bool _isLoading = true;
    private Guid? _professorId;
    private Guid? _userId;

    // Stats
    private int ActiveCourses = 0;
    private int TotalStudents = 0;
    private int PendingGrades = 0;
    private int PendingAttendance = 0;

    // Data
    private List<CourseListDto> Courses = new();
    private List<ScheduleEntryDto> TodaySchedule = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Get current user claims
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Get ProfessorId from claims
            var professorIdClaim = user.FindFirst("ProfessorId")?.Value;
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (Guid.TryParse(professorIdClaim, out var professorId))
            {
                _professorId = professorId;
            }

            if (Guid.TryParse(userIdClaim, out var userId))
            {
                _userId = userId;
            }

            if (_professorId == null)
            {
                _isLoading = false;
                return;
            }

            // Load professor's courses
            Courses = await CourseService.GetByProfessorAsync(_professorId.Value);
            ActiveCourses = Courses.Count(c => c.IsActive);
            TotalStudents = Courses.Sum(c => c.StudentsCount);

            // Load today's schedule
            TodaySchedule = await ScheduleService.GetTodayScheduleForProfessorAsync(_professorId.Value);

            // For now, pending grades is a placeholder (would need a method to count ungraded exams)
            // This could be based on recent exam dates without grades entered
            PendingGrades = 0; // TODO: Implement when we have exam tracking
            PendingAttendance = 0; // TODO: Implement when we have attendance session tracking
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void NavigateToCourse(Guid courseId)
    {
        Navigation.NavigateTo($"/cursuri/{courseId}");
    }

    private string GetScheduleBarStyle(string type)
    {
        var color = type switch
        {
            "Curs" => "var(--rz-secondary)",
            "Laborator" => "var(--rz-success)",
            "Seminar" => "var(--rz-warning)",
            _ => "var(--rz-text-disabled-color)"
        };
        return $"height: 32px; width: 4px; border-radius: 2px; background: {color};";
    }
}
