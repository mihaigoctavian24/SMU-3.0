@using SMU.Components.Shared
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject IGradeService GradeService
@inject IAnalyticsService AnalyticsService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<RadzenStack Gap="1.5rem">
    @if (_isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă datele...
            </RadzenText>
        </RadzenStack>
    }
    else if (_facultyId == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="warning" Style="font-size: 48px;" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Nu ești asociat cu o facultate</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                    Contul tău nu este asociat cu o facultate.
                </RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <!-- Welcome Header -->
        <RadzenCard Style="background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); color: white; padding: 1.5rem;">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: white; font-weight: 700;">
                Bună ziua, Decan @UserName!
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                Iată un sumar al indicatorilor facultății.
            </RadzenText>
        </RadzenCard>

        <!-- Stats Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Total Studenți"
                    Value="@TotalStudents.ToString()"
                    Subtitle="înscriși în facultate"
                    IconType="users"
                    IconBgClass="bg-primary-100"
                    IconClass="text-primary-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Media Facultate"
                    Value="@(FacultyAverage > 0 ? FacultyAverage.ToString("0.00") : "-")"
                    Subtitle="medie generală"
                    IconType="academic"
                    IconBgClass="bg-success-100"
                    IconClass="text-success-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Rata Promovare"
                    Value="@(PassRate.ToString("0") + "%")"
                    Subtitle="sesiunea curentă"
                    IconType="attendance"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Note Pending"
                    Value="@PendingApprovals.ToString()"
                    Subtitle="@(PendingApprovals > 0 ? "necesită aprobare" : "nicio notă")"
                    IconType="grades"
                    IconBgClass="@(PendingApprovals > 0 ? "bg-warning-100" : "bg-success-100")"
                    IconClass="@(PendingApprovals > 0 ? "text-warning-600" : "text-success-600")"
                    ActionLink="/note/aprobare"
                    ActionText="Aprobă note" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Content Grid -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Grade Approvals -->
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenCard Style="padding: 0; overflow: hidden;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                 Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Note în Așteptare</RadzenText>
                        <RadzenLink Path="/note/aprobare" Text="Vezi toate" Style="font-weight: 500;" />
                    </RadzenStack>
                    @if (PendingGradesList.Any())
                    {
                        <RadzenStack Gap="0">
                            @foreach (var grade in PendingGradesList.Take(5))
                            {
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                             Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-200);">
                                    <RadzenStack Gap="0.25rem" Style="flex: 1;">
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">@grade.StudentName</RadzenText>
                                            <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@grade.Value.ToString("0")" IsPill="true" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">
                                            @grade.CourseName - @GetTypeLabel(grade.Type)
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-disabled-color);">
                                            Prof. @(grade.EnteredByName ?? "Necunoscut")
                                        </RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                                        <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Text" Size="ButtonSize.Small"
                                                      title="Aprobă" />
                                        <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                                      title="Respinge" />
                                    </RadzenStack>
                                </RadzenStack>
                            }
                        </RadzenStack>
                        @if (PendingApprovals > 5)
                        {
                            <RadzenStack AlignItems="AlignItems.Center" Class="rz-p-4" Style="background: var(--rz-base-100); border-top: 1px solid var(--rz-base-300);">
                                <RadzenLink Path="/note/aprobare" Text="@($"Vezi toate cele {PendingApprovals} note în așteptare")" Style="font-weight: 500;" />
                            </RadzenStack>
                        }
                    }
                    else
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="0.75rem">
                            <RadzenIcon Icon="check_circle" Style="font-size: 48px; color: var(--rz-success);" />
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                                Toate notele au fost aprobate
                            </RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>

            <!-- Quick Actions & Stats -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenStack Gap="1.5rem">
                    <!-- Quick Actions -->
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Acțiuni Rapide</RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <QuickActionButton
                                Text="Aprobă Note"
                                IconType="check"
                                Variant="primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/note/aprobare" />
                            <QuickActionButton
                                Text="Raport Facultate"
                                IconType="view"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/rapoarte/facultate" />
                            <QuickActionButton
                                Text="Statistici Programe"
                                IconType="view"
                                Variant="outline"
                                FullWidth="true"
                                IsLink="true"
                                Link="/rapoarte/programe" />
                        </RadzenStack>
                    </RadzenCard>

                    <!-- Program Statistics -->
                    <RadzenCard Style="padding: 0; overflow: hidden;">
                        <RadzenStack Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Statistici pe Programe</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="1rem" Class="rz-p-4">
                            @if (ProgramStats.Any())
                            {
                                @foreach (var program in ProgramStats)
                                {
                                    var percentage = TotalStudents > 0 ? Math.Round((decimal)program.StudentCount / TotalStudents * 100) : 0;
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@program.ProgramName</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">@program.StudentCount studenți</RadzenText>
                                        </RadzenStack>
                                        <RadzenProgressBar Value="@((int)percentage)" ShowValue="false" Style="height: 8px;" />
                                    </RadzenStack>
                                }
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0; text-align: center;">
                                    Nu există date despre programe.
                                </RadzenText>
                            }
                        </RadzenStack>
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

        <!-- At-Risk Students Alert -->
        @if (AtRiskStudents > 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">Studenți la Risc</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                        @AtRiskStudents studenți au media sub 5.00 sau prezența sub 50%.
                        Se recomandă intervenția pentru prevenirea abandonului.
                    </RadzenText>
                    <RadzenLink Path="/studenti/risc" Text="Vezi lista completă" Icon="chevron_right" Style="font-weight: 500;" />
                </RadzenStack>
            </RadzenAlert>
        }
    }
</RadzenStack>

@code {
    [Parameter] public string UserName { get; set; } = "Decan";

    // State
    private bool _isLoading = true;
    private Guid? _facultyId;
    private Guid? _userId;

    // Stats
    private int TotalStudents = 0;
    private decimal FacultyAverage = 0;
    private decimal PassRate = 0;
    private int PendingApprovals = 0;
    private int AtRiskStudents = 0;

    // Data
    private List<GradeListDto> PendingGradesList = new();
    private List<ProgramPerformanceDto> ProgramStats = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Get current user claims
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Get FacultyId from claims
            var facultyIdClaim = user.FindFirst("FacultyId")?.Value;
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (Guid.TryParse(facultyIdClaim, out var facultyId))
            {
                _facultyId = facultyId;
            }

            if (Guid.TryParse(userIdClaim, out var userId))
            {
                _userId = userId;
            }

            if (_facultyId == null)
            {
                _isLoading = false;
                return;
            }

            // Load faculty analytics
            var facultyStats = await AnalyticsService.GetFacultyStatsAsync(_facultyId.Value);
            TotalStudents = facultyStats.StudentCount;
            FacultyAverage = facultyStats.AverageGrade;
            PassRate = facultyStats.PassRate;

            // Load program statistics
            ProgramStats = await AnalyticsService.GetProgramPerformancesAsync(_facultyId.Value);

            // Load pending grades for approval
            PendingGradesList = await GradeService.GetPendingForApprovalAsync(_facultyId.Value);
            PendingApprovals = PendingGradesList.Count;

            // Calculate at-risk students based on passing rate
            // For now, estimate at-risk as students with failing grades
            if (PassRate < 100 && TotalStudents > 0)
            {
                AtRiskStudents = (int)Math.Round(TotalStudents * (100 - PassRate) / 100);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetTypeLabel(GradeType type) => type switch
    {
        GradeType.Exam => "Examen",
        GradeType.Lab => "Laborator",
        GradeType.Seminar => "Seminar",
        GradeType.Project => "Proiect",
        GradeType.Final => "Final",
        _ => type.ToString()
    };
}
