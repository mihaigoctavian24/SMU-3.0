@using SMU.Components.Shared
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject IUserService UserService
@inject IActivityFeedService ActivityFeedService
@inject IFacultyService FacultyService
@inject IProgramService ProgramService
@inject AuthenticationStateProvider AuthStateProvider

<RadzenStack Gap="1.5rem">
    @if (_isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă datele...
            </RadzenText>
        </RadzenStack>
    }
    else
    {
        <!-- Welcome Header -->
        <RadzenCard Style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%); color: white; padding: 1.5rem;">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: white; font-weight: 700;">
                Bine ai venit, @UserName!
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                Panou de administrare sistem SMU.
            </RadzenText>
        </RadzenCard>

        <!-- System Health -->
        <RadzenCard>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Style="margin-bottom: 1rem;">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Stare Sistem</RadzenText>
                <RadzenBadge BadgeStyle="@(SystemHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                             Text="@(SystemHealthy ? "Operational" : "Probleme detectate")" IsPill="true" />
            </RadzenStack>
            <RadzenRow Gap="1rem" RowGap="1rem">
                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                    <RadzenCard Style="background: var(--rz-base-100); padding: 1rem;">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Database</RadzenText>
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: @(DbHealthy ? "var(--rz-success)" : "var(--rz-danger)");"></div>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0.5rem 0 0 0; font-weight: 600;">@(DbHealthy ? "Online" : "Offline")</RadzenText>
                    </RadzenCard>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                    <RadzenCard Style="background: var(--rz-base-100); padding: 1rem;">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Supabase</RadzenText>
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: @(SupabaseHealthy ? "var(--rz-success)" : "var(--rz-danger)");"></div>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0.5rem 0 0 0; font-weight: 600;">@(SupabaseHealthy ? "Conectat" : "Deconectat")</RadzenText>
                    </RadzenCard>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                    <RadzenCard Style="background: var(--rz-base-100); padding: 1rem;">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">CPU Usage</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-disabled-color);">Server</RadzenText>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0.5rem 0 0 0; font-weight: 600;">@CpuUsage%</RadzenText>
                    </RadzenCard>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                    <RadzenCard Style="background: var(--rz-base-100); padding: 1rem;">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Memory</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-disabled-color);">Allocated</RadzenText>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0.5rem 0 0 0; font-weight: 600;">@MemoryUsage MB</RadzenText>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>

        <!-- Stats Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Total Utilizatori"
                    Value="@TotalUsers.ToString()"
                    Subtitle="conturi active"
                    IconType="users"
                    IconBgClass="bg-primary-100"
                    IconClass="text-primary-600"
                    ActionLink="/admin/utilizatori"
                    ActionText="Gestionează" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Utilizatori Activi"
                    Value="@ActiveUsersToday.ToString()"
                    Subtitle="acțiuni astăzi"
                    IconType="users"
                    IconBgClass="bg-success-100"
                    IconClass="text-success-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Facultăți"
                    Value="@TotalFaculties.ToString()"
                    Subtitle="@($"{TotalPrograms} programe de studiu")"
                    IconType="academic"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600"
                    ActionLink="/admin/facultati"
                    ActionText="Configurează" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Audit Logs"
                    Value="@AuditLogsToday.ToString()"
                    Subtitle="acțiuni înregistrate astăzi"
                    IconType="document"
                    IconBgClass="bg-warning-100"
                    IconClass="text-warning-600"
                    ActionLink="/admin/audit"
                    ActionText="Vezi loguri" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Content Grid -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- User Distribution -->
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenCard Style="padding: 0; overflow: hidden;">
                    <RadzenStack Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Distribuție Utilizatori per Rol</RadzenText>
                    </RadzenStack>
                    <RadzenStack Gap="1rem" Class="rz-p-4">
                        @if (UsersByRole.Any())
                        {
                            @foreach (var role in UsersByRole)
                            {
                                var percentage = TotalUsers > 0 ? Math.Round((decimal)role.UserCount / TotalUsers * 100, 1) : 0;
                                <RadzenStack Gap="0.25rem">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@role.RoleName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">@role.UserCount utilizatori</RadzenText>
                                    </RadzenStack>
                                    <RadzenProgressBar Value="@((double)percentage)" ShowValue="false" Style="height: 12px;"
                                                       ProgressBarStyle="@GetRoleProgressBarStyle(role.Role)" />
                                </RadzenStack>
                            }
                        }
                        else
                        {
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0; text-align: center; padding: 1rem 0;">
                                Nu există date despre utilizatori.
                            </RadzenText>
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- Quick Actions & System Info -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenStack Gap="1.5rem">
                    <!-- Quick Actions -->
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Acțiuni Admin</RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <QuickActionButton
                                Text="Adaugă Utilizator"
                                IconType="plus"
                                Variant="primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/admin/utilizatori/nou" />
                            <QuickActionButton
                                Text="Gestionează Roluri"
                                IconType="settings"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/admin/roluri" />
                            <QuickActionButton
                                Text="Configurare Facultăți"
                                IconType="edit"
                                Variant="outline"
                                FullWidth="true"
                                IsLink="true"
                                Link="/admin/facultati" />
                            <QuickActionButton
                                Text="Backup Database"
                                IconType="download"
                                Variant="outline"
                                FullWidth="true"
                                IsLink="true"
                                Link="/admin/backup" />
                        </RadzenStack>
                    </RadzenCard>

                    <!-- System Info -->
                    <RadzenCard Style="padding: 0; overflow: hidden;">
                        <RadzenStack Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Informații Sistem</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0" Class="rz-p-4">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0; border-bottom: 1px solid var(--rz-base-200);">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Versiune</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">SMU 3.0</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0; border-bottom: 1px solid var(--rz-base-200);">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Framework</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">.NET 10 Blazor</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0; border-bottom: 1px solid var(--rz-base-200);">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Database</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">PostgreSQL (Supabase)</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0;">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Ultima actualizare</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">@DateTime.Now.ToString("dd MMM yyyy")</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

        <!-- Recent Audit Logs -->
        <RecentActivityList
            Title="Audit Log Recent"
            Items="@RecentAuditLogs"
            ViewAllLink="/admin/audit"
            MaxItems="6"
            EmptyMessage="Nu există activitate recentă." />
    }
</RadzenStack>

@code {
    [Parameter] public string UserName { get; set; } = "Admin";

    // State
    private bool _isLoading = true;

    // System Health (these can be real health checks in production)
    private bool SystemHealthy = true;
    private bool DbHealthy = true;
    private bool SupabaseHealthy = true;
    private int CpuUsage = 0;
    private int MemoryUsage = 0;

    // Stats
    private int TotalUsers = 0;
    private int ActiveUsersToday = 0;
    private int TotalFaculties = 0;
    private int TotalPrograms = 0;
    private int AuditLogsToday = 0;

    // Data
    private List<RoleStatsDto> UsersByRole = new();
    private List<RecentActivityList.ActivityItem> RecentAuditLogs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Get system metrics
            var process = System.Diagnostics.Process.GetCurrentProcess();
            MemoryUsage = (int)(process.WorkingSet64 / 1024 / 1024); // Convert to MB
            CpuUsage = new Random().Next(15, 35); // Placeholder - real CPU monitoring would require more setup

            // Load role statistics
            UsersByRole = await UserService.GetRoleStatsAsync();
            TotalUsers = UsersByRole.Sum(r => r.UserCount);

            // Load activity statistics
            var activityStats = await ActivityFeedService.GetActivityStatsAsync();
            AuditLogsToday = activityStats.TodayActivities;
            ActiveUsersToday = activityStats.UniqueUsers;

            // Load faculty and program counts
            var faculties = await FacultyService.GetAllAsync(new FacultyFilter(), 1, 1000);
            TotalFaculties = faculties.TotalCount;

            var programs = await ProgramService.GetAllAsync(new StudyProgramFilter(), 1, 1000);
            TotalPrograms = programs.TotalCount;

            // Load recent audit logs
            var recentActivities = await ActivityFeedService.GetRecentActivitiesAsync(6);
            RecentAuditLogs = recentActivities
                .Select(a => new RecentActivityList.ActivityItem
                {
                    Title = GetActionTitle(a.ActionType),
                    Description = $"{a.UserName} - {a.EntityName ?? a.EntityType}",
                    Timestamp = a.CreatedAt,
                    Type = GetActivityType(a.EntityType),
                    Badge = a.ActionType.ToString(),
                    BadgeType = GetBadgeType(a.ActionType)
                })
                .ToList();

            // Check database health by verifying we got data
            DbHealthy = faculties.TotalCount >= 0;
            SupabaseHealthy = DbHealthy;
            SystemHealthy = DbHealthy && SupabaseHealthy;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
            SystemHealthy = false;
            DbHealthy = false;
            SupabaseHealthy = false;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private ProgressBarStyle GetRoleProgressBarStyle(UserRole role) => role switch
    {
        UserRole.Student => ProgressBarStyle.Primary,
        UserRole.Professor => ProgressBarStyle.Secondary,
        UserRole.Secretary => ProgressBarStyle.Info,
        UserRole.Dean => ProgressBarStyle.Warning,
        UserRole.Rector => ProgressBarStyle.Info,
        UserRole.Admin => ProgressBarStyle.Danger,
        _ => ProgressBarStyle.Light
    };

    private string GetActionTitle(ActivityAction action) => action switch
    {
        ActivityAction.LoggedIn => "Login reușit",
        ActivityAction.LoggedOut => "Logout",
        ActivityAction.Created => "Element creat",
        ActivityAction.Updated => "Element actualizat",
        ActivityAction.Deleted => "Element șters",
        ActivityAction.Viewed => "Element vizualizat",
        ActivityAction.Exported => "Export efectuat",
        ActivityAction.Approved => "Element aprobat",
        ActivityAction.Rejected => "Element respins",
        ActivityAction.Assigned => "Element asignat",
        _ => action.ToString()
    };

    private string GetActivityType(string entityType) => entityType.ToLower() switch
    {
        "student" => "user",
        "professor" => "user",
        "user" => "user",
        "grade" => "grade",
        "course" => "document",
        "attendance" => "attendance",
        "documentrequest" => "document",
        _ => "user"
    };

    private string GetBadgeType(ActivityAction action) => action switch
    {
        ActivityAction.LoggedIn or ActivityAction.LoggedOut => "success",
        ActivityAction.Created => "info",
        ActivityAction.Updated => "info",
        ActivityAction.Deleted => "danger",
        ActivityAction.Approved => "success",
        ActivityAction.Rejected => "danger",
        ActivityAction.Exported => "warning",
        ActivityAction.Assigned => "info",
        _ => "default"
    };
}
