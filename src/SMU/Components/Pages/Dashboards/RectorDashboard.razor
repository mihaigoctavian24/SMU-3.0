@using SMU.Components.Shared
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject IAnalyticsService AnalyticsService
@inject AuthenticationStateProvider AuthStateProvider

<RadzenStack Gap="1.5rem">
    @if (_isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă datele...
            </RadzenText>
        </RadzenStack>
    }
    else
    {
        <!-- Welcome Header -->
        <RadzenCard Style="background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%); color: white; padding: 1.5rem;">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: white; font-weight: 700;">
                Bună ziua, Rector @UserName!
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                Iată un sumar al indicatorilor universității.
            </RadzenText>
        </RadzenCard>

        <!-- University KPIs -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Total Studenți"
                    Value="@TotalStudents.ToString("N0")"
                    Subtitle="@($"{TotalFaculties} facultăți")"
                    IconType="users"
                    IconBgClass="bg-primary-100"
                    IconClass="text-primary-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Media Universitate"
                    Value="@(UniversityAverage > 0 ? UniversityAverage.ToString("0.00") : "-")"
                    Subtitle="medie generală"
                    IconType="academic"
                    IconBgClass="bg-success-100"
                    IconClass="text-success-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Rata Promovare"
                    Value="@(PassRate.ToString("0") + "%")"
                    Subtitle="an universitar curent"
                    IconType="attendance"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Total Profesori"
                    Value="@TotalProfessors.ToString()"
                    Subtitle="cadre didactice"
                    IconType="users"
                    IconBgClass="bg-secondary-100"
                    IconClass="text-secondary-600" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Faculty Comparison -->
        <RadzenCard Style="padding: 0; overflow: hidden;">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                         Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Comparație Facultăți</RadzenText>
                <RadzenLink Path="/rapoarte/facultati" Text="Raport detaliat" Style="font-weight: 500;" />
            </RadzenStack>
            @if (FacultyStats.Any())
            {
                <RadzenDataGrid Data="@FacultyStats" TItem="FacultyComparisonDto" AllowSorting="true" Style="border: none;">
                    <Columns>
                        <RadzenDataGridColumn TItem="FacultyComparisonDto" Title="Facultate" Sortable="true">
                            <Template Context="faculty">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                                    <div style="@GetFacultyBarStyle(faculty.FacultyCode)"></div>
                                    <RadzenStack Gap="0">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@faculty.FacultyName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">@faculty.ProgramCount programe</RadzenText>
                                    </RadzenStack>
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="FacultyComparisonDto" Property="StudentCount" Title="Studenți" TextAlign="TextAlign.Center" Sortable="true" />
                        <RadzenDataGridColumn TItem="FacultyComparisonDto" Property="ProfessorCount" Title="Profesori" TextAlign="TextAlign.Center" Sortable="true" />
                        <RadzenDataGridColumn TItem="FacultyComparisonDto" Title="Media" TextAlign="TextAlign.Center" Sortable="true" SortProperty="AverageGrade">
                            <Template Context="faculty">
                                <RadzenBadge BadgeStyle="@GetAverageBadgeStyle(faculty.AverageGrade)" IsPill="true"
                                             Text="@(faculty.AverageGrade > 0 ? faculty.AverageGrade.ToString("0.00") : "-")" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="FacultyComparisonDto" Title="Promovare" TextAlign="TextAlign.Center" Sortable="true" SortProperty="PassRate">
                            <Template Context="faculty">
                                @faculty.PassRate.ToString("0")%
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="FacultyComparisonDto" Title="Trend" TextAlign="TextAlign.Center">
                            <Template Context="faculty">
                                @if (faculty.Trend == "ascending")
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="trending_up" Style="color: var(--rz-success);" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-success);">@Math.Abs(faculty.TrendValue)%</RadzenText>
                                    </RadzenStack>
                                }
                                else if (faculty.Trend == "descending")
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="trending_down" Style="color: var(--rz-danger);" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-danger);">@Math.Abs(faculty.TrendValue)%</RadzenText>
                                    </RadzenStack>
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">-</RadzenText>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                        Nu există date despre facultăți.
                    </RadzenText>
                </RadzenStack>
            }
        </RadzenCard>

        <!-- Content Grid -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Quick Actions -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenCard>
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Rapoarte</RadzenText>
                    <RadzenStack Gap="0.75rem">
                        <QuickActionButton
                            Text="Raport Anual"
                            IconType="document"
                            Variant="primary"
                            FullWidth="true"
                            IsLink="true"
                            Link="/rapoarte/anual" />
                        <QuickActionButton
                            Text="Comparație Facultăți"
                            IconType="view"
                            Variant="outline-primary"
                            FullWidth="true"
                            IsLink="true"
                            Link="/rapoarte/facultati" />
                        <QuickActionButton
                            Text="Analiză Promovare"
                            IconType="view"
                            Variant="outline"
                            FullWidth="true"
                            IsLink="true"
                            Link="/rapoarte/promovare" />
                        <QuickActionButton
                            Text="Export Date"
                            IconType="download"
                            Variant="outline"
                            FullWidth="true"
                            IsLink="true"
                            Link="/rapoarte/export" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <!-- University Summary -->
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenCard Style="padding: 0; overflow: hidden;">
                    <RadzenStack Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Sumar Universitate</RadzenText>
                    </RadzenStack>
                    <RadzenStack Class="rz-p-4" Gap="1.5rem">
                        <RadzenRow Gap="1.5rem" RowGap="1rem">
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: var(--rz-primary); font-weight: 700;">@TotalFaculties</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Facultăți</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: var(--rz-secondary); font-weight: 700;">@TotalPrograms</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Programe</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: var(--rz-success); font-weight: 700;">@TotalCourses</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Cursuri</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6" SizeMD="3">
                                <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: var(--rz-info); font-weight: 700;">@TotalGroups</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Grupe</RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                        <RadzenRow Gap="1rem" Style="padding-top: 1rem; border-top: 1px solid var(--rz-base-200);">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenCard Style="background: var(--rz-base-100); padding: 1rem;">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">An universitar</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0.5rem 0 0 0; font-weight: 600;">@GetCurrentAcademicYear()</RadzenText>
                                </RadzenCard>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenCard Style="background: var(--rz-base-100); padding: 1rem;">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Semestru curent</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0.5rem 0 0 0; font-weight: 600;">@GetCurrentSemester()</RadzenText>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <!-- Alerts Section -->
        @if (AtRiskStudentsTotal > 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">Atenție: Studenți la Risc</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                        @AtRiskStudentsTotal studenți din întreaga universitate au indicatori sub pragul acceptabil.
                        Se recomandă monitorizare și intervenție la nivel de facultate.
                    </RadzenText>
                    <RadzenLink Path="/rapoarte/risc" Text="Vezi raport detaliat" Icon="chevron_right" Style="font-weight: 500;" />
                </RadzenStack>
            </RadzenAlert>
        }
    }
</RadzenStack>

@code {
    [Parameter] public string UserName { get; set; } = "";

    // State
    private bool _isLoading = true;

    // University KPIs
    private int TotalStudents = 0;
    private decimal UniversityAverage = 0;
    private decimal PassRate = 0;
    private int TotalProfessors = 0;
    private int TotalFaculties = 0;
    private int TotalPrograms = 0;
    private int TotalCourses = 0;
    private int TotalGroups = 0;
    private int AtRiskStudentsTotal = 0;

    // Data
    private List<FacultyComparisonDto> FacultyStats = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Load university-wide statistics
            var universityStats = await AnalyticsService.GetUniversityStatsAsync();
            TotalStudents = universityStats.TotalStudents;
            TotalProfessors = universityStats.TotalProfessors;
            TotalFaculties = universityStats.FacultyCount;
            TotalPrograms = universityStats.ProgramCount;
            TotalCourses = universityStats.CourseCount;
            TotalGroups = universityStats.GroupCount;
            UniversityAverage = universityStats.OverallAverage;
            PassRate = universityStats.PassRate;
            AtRiskStudentsTotal = universityStats.AtRiskStudentsCount;

            // Load faculty comparison data
            FacultyStats = await AnalyticsService.GetFacultyComparisonsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private BadgeStyle GetAverageBadgeStyle(decimal average) => average switch
    {
        >= 8.5m => BadgeStyle.Success,
        >= 7.0m => BadgeStyle.Info,
        >= 5.0m => BadgeStyle.Warning,
        _ => BadgeStyle.Danger
    };

    private string GetFacultyBarStyle(string code)
    {
        // Assign colors based on faculty code hash for consistency
        var hash = code.GetHashCode();
        var colors = new[] { "var(--rz-primary)", "var(--rz-success)", "var(--rz-warning)", "var(--rz-info)", "rgb(168, 85, 247)", "var(--rz-secondary)" };
        var color = colors[Math.Abs(hash) % colors.Length];
        return $"width: 4px; height: 32px; border-radius: 2px; background: {color};";
    }

    private string GetCurrentAcademicYear()
    {
        var now = DateTime.Now;
        var year = now.Month >= 9 ? now.Year : now.Year - 1;
        return $"{year} - {year + 1}";
    }

    private string GetCurrentSemester()
    {
        var month = DateTime.Now.Month;
        return month >= 2 && month <= 6 ? "Semestrul II" : "Semestrul I";
    }
}
