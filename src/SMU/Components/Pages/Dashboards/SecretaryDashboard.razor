@using SMU.Components.Shared
@using SMU.Data
@using SMU.Data.Entities
@using SMU.Services
@using SMU.Services.DTOs
@using SMU.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject IDocumentRequestService DocumentRequestService
@inject IStudentService StudentService
@inject IAnalyticsService AnalyticsService
@inject AuthenticationStateProvider AuthStateProvider

<RadzenStack Gap="1.5rem">
    @if (_isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                Se încarcă datele...
            </RadzenText>
        </RadzenStack>
    }
    else if (_facultyId == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Medium">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="warning" Style="font-size: 48px;" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Nu ești asociat cu o facultate</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                    Contul tău nu este asociat cu o facultate.
                </RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <!-- Welcome Header -->
        <RadzenCard Style="background: linear-gradient(135deg, var(--rz-info) 0%, var(--rz-info-dark, #1d4ed8) 100%); color: white; padding: 1.5rem;">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; color: white; font-weight: 700;">
                Bună ziua, @UserName!
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9);">
                Iată un sumar al activității secretariatului.
            </RadzenText>
        </RadzenCard>

        <!-- Stats Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Studenți Activi"
                    Value="@ActiveStudents.ToString()"
                    Subtitle="în facultate"
                    IconType="users"
                    IconBgClass="bg-primary-100"
                    IconClass="text-primary-600"
                    ActionLink="/studenti"
                    ActionText="Vezi studenți" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Cereri Pending"
                    Value="@PendingRequests.ToString()"
                    Subtitle="@(PendingRequests > 0 ? "necesită procesare" : "nicio cerere")"
                    IconType="document"
                    IconBgClass="@(PendingRequests > 0 ? "bg-warning-100" : "bg-success-100")"
                    IconClass="@(PendingRequests > 0 ? "text-warning-600" : "text-success-600")"
                    ActionLink="/cereri"
                    ActionText="Procesează cereri" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Documente Emise"
                    Value="@DocumentsIssuedThisMonth.ToString()"
                    Subtitle="luna aceasta"
                    IconType="document"
                    IconBgClass="bg-info-100"
                    IconClass="text-info-600" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <StatsCard
                    Label="Studenți Noi"
                    Value="@NewStudentsThisMonth.ToString()"
                    Subtitle="înregistrați luna aceasta"
                    IconType="users"
                    IconBgClass="bg-success-100"
                    IconClass="text-success-600" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Content Grid -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Pending Requests -->
            <RadzenColumn Size="12" SizeLG="8">
                <RecentActivityList
                    Title="Cereri de Procesat"
                    Items="@PendingRequestsList"
                    ViewAllLink="/cereri"
                    EmptyMessage="Nu există cereri în așteptare." />
            </RadzenColumn>

            <!-- Quick Actions & Statistics -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenStack Gap="1.5rem">
                    <!-- Quick Actions -->
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0 0 1rem 0; font-weight: 600;">Acțiuni Rapide</RadzenText>
                        <RadzenStack Gap="0.75rem">
                            <QuickActionButton
                                Text="Adaugă Student"
                                IconType="plus"
                                Variant="primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/studenti/nou" />
                            <QuickActionButton
                                Text="Procesează Cereri"
                                IconType="check"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/cereri" />
                            <QuickActionButton
                                Text="Emite Document"
                                IconType="document"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/documente/emite" />
                            <QuickActionButton
                                Text="Transfer Student"
                                IconType="arrow-right"
                                Variant="outline-primary"
                                FullWidth="true"
                                IsLink="true"
                                Link="/studenti/transfer" />
                        </RadzenStack>
                    </RadzenCard>

                    <!-- Statistics Summary -->
                    <RadzenCard Style="padding: 0; overflow: hidden;">
                        <RadzenStack Class="rz-p-4" Style="border-bottom: 1px solid var(--rz-base-300);">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 600;">Statistici Facultate</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0" Class="rz-p-4">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0; border-bottom: 1px solid var(--rz-base-200);">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Programe de studiu</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">@StudyPrograms</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0; border-bottom: 1px solid var(--rz-base-200);">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Profesori</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">@TotalProfessors</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0; border-bottom: 1px solid var(--rz-base-200);">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Media generală</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600;">
                                    @(AverageGrade > 0 ? AverageGrade.ToString("0.00") : "-")
                                </RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center"
                                         Style="padding: 0.75rem 0;">
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">Rata promovare</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 600; color: var(--rz-success);">
                                    @PassRate.ToString("0.0")%
                                </RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

        <!-- Recent Activity -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeLG="6">
                <RecentActivityList
                    Title="Studenți Recent Adăugați"
                    Items="@RecentStudents"
                    MaxItems="5"
                    EmptyMessage="Nu au fost adăugați studenți recent." />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeLG="6">
                <RecentActivityList
                    Title="Cereri Procesate Recent"
                    Items="@RecentProcessedRequests"
                    MaxItems="5"
                    EmptyMessage="Nu au fost procesate cereri recent." />
            </RadzenColumn>
        </RadzenRow>
    }
</RadzenStack>

@code {
    [Parameter] public string UserName { get; set; } = "Secretar";

    // State
    private bool _isLoading = true;
    private Guid? _facultyId;
    private Guid? _userId;

    // Stats
    private int ActiveStudents = 0;
    private int PendingRequests = 0;
    private int DocumentsIssuedThisMonth = 0;
    private int NewStudentsThisMonth = 0;
    private int StudyPrograms = 0;
    private int TotalProfessors = 0;
    private decimal AverageGrade = 0;
    private decimal PassRate = 0;

    // Data
    private List<RecentActivityList.ActivityItem> PendingRequestsList = new();
    private List<RecentActivityList.ActivityItem> RecentStudents = new();
    private List<RecentActivityList.ActivityItem> RecentProcessedRequests = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            _isLoading = true;

            // Get current user claims
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Get FacultyId from claims
            var facultyIdClaim = user.FindFirst("FacultyId")?.Value;
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (Guid.TryParse(facultyIdClaim, out var facultyId))
            {
                _facultyId = facultyId;
            }

            if (Guid.TryParse(userIdClaim, out var userId))
            {
                _userId = userId;
            }

            if (_facultyId == null)
            {
                _isLoading = false;
                return;
            }

            // Load faculty analytics
            var facultyStats = await AnalyticsService.GetFacultyStatsAsync(_facultyId.Value);
            ActiveStudents = facultyStats.StudentCount;
            TotalProfessors = facultyStats.ProfessorCount;
            StudyPrograms = facultyStats.ProgramCount;
            AverageGrade = facultyStats.AverageGrade;
            PassRate = facultyStats.PassRate;

            // Load pending document requests
            var pendingDocs = await DocumentRequestService.GetPendingAsync(_facultyId.Value);
            PendingRequests = pendingDocs.Count;

            // Map to activity items
            PendingRequestsList = pendingDocs
                .OrderByDescending(d => d.CreatedAt)
                .Take(5)
                .Select(d => new RecentActivityList.ActivityItem
                {
                    Title = d.TypeLabel,
                    Description = $"{d.StudentName} - {d.StudentNumber}",
                    Timestamp = d.CreatedAt,
                    Type = "document",
                    Badge = d.StatusLabel,
                    BadgeType = GetStatusBadgeType(d.Status),
                    ActionLink = $"/cereri/{d.Id}"
                })
                .ToList();

            // Load recent students
            var recentStudentsList = await StudentService.GetRecentAsync(5);
            RecentStudents = recentStudentsList
                .Select(s => new RecentActivityList.ActivityItem
                {
                    Title = s.FullName,
                    Description = $"{s.ProgramName} - {s.GroupName}",
                    Timestamp = DateTime.Now, // Approximate since CreatedAt is not on StudentListDto
                    Type = "user"
                })
                .ToList();

            // Load all documents and calculate stats
            var allDocs = await DocumentRequestService.GetAllAsync(new DocumentRequestFilter { FacultyId = _facultyId.Value });
            var thisMonth = DateTime.Now.AddDays(-30);
            DocumentsIssuedThisMonth = allDocs.Count(d => d.Status == RequestStatus.Completed && d.ProcessedAt >= thisMonth);

            // Recent processed for activity list
            RecentProcessedRequests = allDocs
                .Where(d => d.Status == RequestStatus.Completed && d.ProcessedAt != null)
                .OrderByDescending(d => d.ProcessedAt)
                .Take(5)
                .Select(d => new RecentActivityList.ActivityItem
                {
                    Title = d.TypeLabel,
                    Description = d.StudentName,
                    Timestamp = d.ProcessedAt ?? d.CreatedAt,
                    Type = "document",
                    Badge = "Finalizat",
                    BadgeType = "success"
                })
                .ToList();

            // New students this month (approximation based on recent list)
            NewStudentsThisMonth = recentStudentsList.Count;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetStatusBadgeType(RequestStatus status) => status switch
    {
        RequestStatus.Pending => "warning",
        RequestStatus.InProgress => "info",
        RequestStatus.Completed => "success",
        RequestStatus.Rejected => "danger",
        _ => "gray"
    };
}
