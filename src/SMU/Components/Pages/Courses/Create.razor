@page "/cursuri/nou"
@using SMU.Models
@using SMU.Services
@using Microsoft.AspNetCore.Authorization
@inject ICourseService CourseService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService
@attribute [Authorize(Policy = "CanManageStudents")]

<PageTitle>Curs Nou - SMU</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 900px; margin: 0 auto;">
    <!-- Header -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
        <RadzenButton Icon="arrow_back"
                      ButtonStyle="ButtonStyle.Light"
                      Variant="Variant.Text"
                      Click="@(() => Navigation.NavigateTo("/cursuri"))" />
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Adaugă Curs Nou</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">Completează formularul pentru a crea un curs nou</RadzenText>
        </RadzenStack>
    </RadzenStack>

    <!-- Error Message -->
    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Small">
            @errorMessage
        </RadzenAlert>
    }

    <!-- Form -->
    <RadzenCard Style="padding: 1.5rem;">
        <EditForm Model="@model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <RadzenStack Gap="1.5rem">
                <!-- Course Name -->
                <RadzenFormField Text="Nume Curs" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="model.Name" Placeholder="ex: Programare Orientată pe Obiecte" />
                    </ChildContent>
                    <Helper>
                        <ValidationMessage For="@(() => model.Name)" />
                    </Helper>
                </RadzenFormField>

                <!-- Course Code -->
                <RadzenFormField Text="Cod Curs" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="model.Code" Placeholder="ex: POO-101" Style="font-family: monospace;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">
                            Codul trebuie să fie unic în sistem
                        </RadzenText>
                        <ValidationMessage For="@(() => model.Code)" />
                    </Helper>
                </RadzenFormField>

                <!-- Program -->
                <RadzenFormField Text="Program de Studii" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="model.ProgramId"
                                        Data="@programs"
                                        TextProperty="DisplayName"
                                        ValueProperty="Id"
                                        Placeholder="Selectează programul"
                                        Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <ValidationMessage For="@(() => model.ProgramId)" />
                    </Helper>
                </RadzenFormField>

                <!-- Professor -->
                <RadzenFormField Text="Profesor (opțional)" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="selectedProfessorId"
                                        Data="@professors"
                                        TextProperty="DisplayName"
                                        ValueProperty="IdString"
                                        AllowClear="true"
                                        Placeholder="Neasignat"
                                        Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">
                            Poți asigna profesorul mai târziu
                        </RadzenText>
                    </Helper>
                </RadzenFormField>

                <!-- Credits, Year, Semester Row -->
                <RadzenRow Gap="1rem" RowGap="1rem">
                    <!-- Credits -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Credite ECTS" Variant="Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenNumeric @bind-Value="model.Credits" Min="1" Max="10" Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <ValidationMessage For="@(() => model.Credits)" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>

                    <!-- Year -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="An de Studiu" Variant="Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenDropDown @bind-Value="model.Year"
                                                Data="@yearOptions"
                                                TextProperty="Text"
                                                ValueProperty="Value"
                                                Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <ValidationMessage For="@(() => model.Year)" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>

                    <!-- Semester -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenFormField Text="Semestru" Variant="Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenDropDown @bind-Value="model.Semester"
                                                Data="@semesterOptions"
                                                TextProperty="Text"
                                                ValueProperty="Value"
                                                Style="width: 100%;" />
                            </ChildContent>
                            <Helper>
                                <ValidationMessage For="@(() => model.Semester)" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Description -->
                <RadzenFormField Text="Descriere (opțional)" Variant="Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="model.Description"
                                        Rows="4"
                                        Placeholder="Descriere scurtă a cursului, obiective, conținut..." />
                    </ChildContent>
                </RadzenFormField>

                <!-- Form Actions -->
                <div style="padding-top: 1rem; border-top: 1px solid var(--rz-border-color);">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.75rem">
                        <RadzenButton Text="Anulează"
                                      ButtonStyle="ButtonStyle.Light"
                                      Click="@(() => Navigation.NavigateTo("/cursuri"))" />
                        <RadzenButton Text="@(isSaving ? "Se salvează..." : "Salvează Curs")"
                                      Icon="@(isSaving ? "" : "check")"
                                      ButtonStyle="ButtonStyle.Primary"
                                      ButtonType="ButtonType.Submit"
                                      IsBusy="@isSaving"
                                      Disabled="@isSaving" />
                    </RadzenStack>
                </div>
            </RadzenStack>
        </EditForm>
    </RadzenCard>
</RadzenStack>

@code {
    private CreateCourseDto model = new() { Credits = 5, Year = 1, Semester = 1 };
    private List<ProgramOption> programs = new();
    private List<ProfessorOptionDisplay> professors = new();
    private string? selectedProfessorId;
    private bool isSaving = false;
    private string? errorMessage;

    private List<YearOption> yearOptions = new()
    {
        new YearOption { Text = "Anul 1", Value = 1 },
        new YearOption { Text = "Anul 2", Value = 2 },
        new YearOption { Text = "Anul 3", Value = 3 },
        new YearOption { Text = "Anul 4", Value = 4 }
    };

    private List<SemesterOption> semesterOptions = new()
    {
        new SemesterOption { Text = "Semestrul 1", Value = 1 },
        new SemesterOption { Text = "Semestrul 2", Value = 2 }
    };

    protected override async Task OnInitializedAsync()
    {
        var programsList = await CourseService.GetProgramOptionsAsync();
        programs = programsList.Select(p => new ProgramOption
        {
            Id = p.Id,
            Name = p.Name,
            Code = p.Code,
            DisplayName = $"{p.Name} ({p.Code})"
        }).ToList();

        var professorsList = await CourseService.GetProfessorOptionsAsync();
        professors = professorsList.Select(p => new ProfessorOptionDisplay
        {
            Id = p.Id,
            IdString = p.Id.ToString(),
            FullName = p.FullName,
            Title = p.Title,
            DisplayName = string.IsNullOrEmpty(p.Title) ? p.FullName : $"{p.FullName} ({p.Title})"
        }).ToList();
    }

    private async Task HandleSubmit()
    {
        isSaving = true;
        errorMessage = null;

        try
        {
            // Set professor ID if selected
            if (!string.IsNullOrEmpty(selectedProfessorId) && Guid.TryParse(selectedProfessorId, out var professorId))
            {
                model.ProfessorId = professorId;
            }

            var result = await CourseService.CreateAsync(model);

            if (result.Succeeded)
            {
                Navigation.NavigateTo($"/cursuri/{result.Data}");
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "A apărut o eroare neașteptată. Te rugăm să încerci din nou.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private class ProgramOption
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Code { get; set; } = "";
        public string DisplayName { get; set; } = "";
    }

    private class ProfessorOptionDisplay
    {
        public Guid Id { get; set; }
        public string IdString { get; set; } = "";
        public string FullName { get; set; } = "";
        public string? Title { get; set; }
        public string DisplayName { get; set; } = "";
    }

    private class YearOption
    {
        public string Text { get; set; } = "";
        public int Value { get; set; }
    }

    private class SemesterOption
    {
        public string Text { get; set; } = "";
        public int Value { get; set; }
    }
}
