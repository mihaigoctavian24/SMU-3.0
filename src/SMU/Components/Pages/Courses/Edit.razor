@page "/cursuri/{id:guid}/editare"
@using SMU.Models
@using SMU.Services
@using Microsoft.AspNetCore.Authorization
@inject ICourseService CourseService
@inject NavigationManager Navigation
@inject Radzen.NotificationService NotificationService
@attribute [Authorize(Policy = "CanManageStudents")]

<PageTitle>Editare Curs - SMU</PageTitle>

@if (isLoading)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        <RadzenText TextStyle="TextStyle.Body2" Style="margin-top: 1rem; color: var(--rz-text-secondary-color);">
            Se încarcă detaliile cursului...
        </RadzenText>
    </RadzenStack>
}
else if (course == null)
{
    <RadzenCard Style="padding: 3rem; text-align: center;">
        <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
            <RadzenIcon Icon="error_outline" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Curs negăsit</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">
                Cursul căutat nu există sau a fost șters.
            </RadzenText>
            <RadzenButton Text="Înapoi la Cursuri"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => Navigation.NavigateTo("/cursuri"))" />
        </RadzenStack>
    </RadzenCard>
}
else
{
    <RadzenStack Gap="1.5rem" Style="max-width: 900px; margin: 0 auto;">
        <!-- Header -->
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
            <RadzenButton Icon="arrow_back"
                          ButtonStyle="ButtonStyle.Light"
                          Variant="Variant.Text"
                          Click="@(() => Navigation.NavigateTo($"/cursuri/{Id}"))" />
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: bold;">Editare Curs</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: var(--rz-text-secondary-color);">
                    @course.Name • @course.Code
                </RadzenText>
            </RadzenStack>
        </RadzenStack>

        <!-- Error Message -->
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Small">
                @errorMessage
            </RadzenAlert>
        }

        <!-- Success Message -->
        @if (!string.IsNullOrWhiteSpace(successMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" ShowIcon="true" Size="AlertSize.Small">
                @successMessage
            </RadzenAlert>
        }

        <!-- Form -->
        <RadzenCard Style="padding: 1.5rem;">
            <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <RadzenStack Gap="1.5rem">
                    <!-- Program Info (Read-only) -->
                    <RadzenCard Variant="Variant.Flat" Style="background: var(--rz-base-200); padding: 1rem;">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; font-weight: 500; text-transform: uppercase; color: var(--rz-text-secondary-color);">
                                Program de Studii
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; font-weight: 500;">@course.ProgramName</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">
                                Programul nu poate fi modificat după creare
                            </RadzenText>
                        </RadzenStack>
                    </RadzenCard>

                    <!-- Course Name -->
                    <RadzenFormField Text="Nume Curs" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="model.Name" />
                        </ChildContent>
                        <Helper>
                            <ValidationMessage For="@(() => model.Name)" />
                        </Helper>
                    </RadzenFormField>

                    <!-- Course Code -->
                    <RadzenFormField Text="Cod Curs" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="model.Code" Style="font-family: monospace;" />
                        </ChildContent>
                        <Helper>
                            <ValidationMessage For="@(() => model.Code)" />
                        </Helper>
                    </RadzenFormField>

                    <!-- Professor -->
                    <RadzenFormField Text="Profesor" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="selectedProfessorId"
                                            Data="@professors"
                                            TextProperty="DisplayName"
                                            ValueProperty="IdString"
                                            AllowClear="true"
                                            Placeholder="Neasignat"
                                            Style="width: 100%;" />
                        </ChildContent>
                    </RadzenFormField>

                    <!-- Credits -->
                    <RadzenFormField Text="Credite ECTS" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.Credits" Min="1" Max="10" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <ValidationMessage For="@(() => model.Credits)" />
                        </Helper>
                    </RadzenFormField>

                    <!-- Description -->
                    <RadzenFormField Text="Descriere" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextArea @bind-Value="model.Description" Rows="4" />
                        </ChildContent>
                    </RadzenFormField>

                    <!-- Status -->
                    <RadzenStack Gap="0.25rem">
                        <RadzenCheckBox @bind-Value="model.IsActive" Name="isActive" />
                        <RadzenLabel Text="Curs activ" Component="isActive" Style="margin-left: 0.5rem;" />
                        <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; color: var(--rz-text-secondary-color);">
                            Cursurile inactive nu apar în listele de selecție
                        </RadzenText>
                    </RadzenStack>

                    <!-- Form Actions -->
                    <div style="padding-top: 1rem; border-top: 1px solid var(--rz-border-color);">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.75rem">
                            <RadzenButton Text="Anulează"
                                          ButtonStyle="ButtonStyle.Light"
                                          Click="@(() => Navigation.NavigateTo($"/cursuri/{Id}"))" />
                            <RadzenButton Text="@(isSaving ? "Se salvează..." : "Salvează Modificări")"
                                          Icon="@(isSaving ? "" : "check")"
                                          ButtonStyle="ButtonStyle.Primary"
                                          ButtonType="ButtonType.Submit"
                                          IsBusy="@isSaving"
                                          Disabled="@isSaving" />
                        </RadzenStack>
                    </div>
                </RadzenStack>
            </EditForm>
        </RadzenCard>
    </RadzenStack>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private CourseDetailDto? course;
    private UpdateCourseDto model = new();
    private List<ProfessorOptionDisplay> professors = new();
    private string? selectedProfessorId;
    private bool isLoading = true;
    private bool isSaving = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCourse();
        await LoadProfessors();
    }

    private async Task LoadCourse()
    {
        isLoading = true;
        try
        {
            course = await CourseService.GetByIdAsync(Id);

            if (course != null)
            {
                model = new UpdateCourseDto
                {
                    Name = course.Name,
                    Code = course.Code,
                    ProfessorId = course.ProfessorId,
                    Credits = course.Credits,
                    Description = course.Description,
                    IsActive = course.IsActive
                };

                selectedProfessorId = course.ProfessorId?.ToString() ?? "";
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadProfessors()
    {
        var professorsList = await CourseService.GetProfessorOptionsAsync();
        professors = professorsList.Select(p => new ProfessorOptionDisplay
        {
            Id = p.Id,
            IdString = p.Id.ToString(),
            FullName = p.FullName,
            Title = p.Title,
            DisplayName = string.IsNullOrEmpty(p.Title) ? p.FullName : $"{p.FullName} ({p.Title})"
        }).ToList();
    }

    private async Task HandleSubmit()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // Set professor ID if selected
            if (!string.IsNullOrEmpty(selectedProfessorId) && Guid.TryParse(selectedProfessorId, out var professorId))
            {
                model.ProfessorId = professorId;
            }
            else
            {
                model.ProfessorId = null;
            }

            var result = await CourseService.UpdateAsync(Id, model);

            if (result.Succeeded)
            {
                successMessage = "Cursul a fost actualizat cu succes!";
                await LoadCourse(); // Reload to get updated data
            }
            else
            {
                errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "A apărut o eroare neașteptată. Te rugăm să încerci din nou.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private class ProfessorOptionDisplay
    {
        public Guid Id { get; set; }
        public string IdString { get; set; } = "";
        public string FullName { get; set; } = "";
        public string? Title { get; set; }
        public string DisplayName { get; set; } = "";
    }
}
