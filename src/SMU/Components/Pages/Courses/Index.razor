@page "/cursuri"
@using SMU.Data.Entities
@using SMU.Models
@using SMU.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject ICourseService CourseService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject DialogService DialogService
@inject Radzen.NotificationService RadzenNotificationService
@attribute [Authorize]

<PageTitle>Cursuri - SMU</PageTitle>

<RadzenStack Gap="1.5rem">
    <!-- Header -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
        <RadzenStack Gap="0.25rem">
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Cursuri</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">@GetSubtitle()</RadzenText>
        </RadzenStack>
        @if (CanManageCourses)
        {
            <RadzenButton Text="Adaugă Curs" Icon="add" ButtonStyle="ButtonStyle.Primary"
                          Click="@NavigateToCreate" />
        }
    </RadzenStack>

    <!-- Filters -->
    <RadzenCard>
        <RadzenRow Gap="1rem" RowGap="1rem">
            <!-- Search -->
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenFormField Text="Caută" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="searchTerm" Placeholder="Nume sau cod curs..."
                                   @oninput="OnSearchChanged" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Year Filter -->
            <RadzenColumn Size="6" SizeMD="2">
                <RadzenFormField Text="An" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedYear" Data="@yearOptions" TextProperty="Text" ValueProperty="Value"
                                    Change="@(args => ApplyFilters())" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Semester Filter -->
            <RadzenColumn Size="6" SizeMD="2">
                <RadzenFormField Text="Semestru" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedSemester" Data="@semesterOptions" TextProperty="Text" ValueProperty="Value"
                                    Change="@(args => ApplyFilters())" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Status Filter -->
            <RadzenColumn Size="6" SizeMD="2">
                <RadzenFormField Text="Status" Variant="Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="selectedStatus" Data="@statusOptions" TextProperty="Text" ValueProperty="Value"
                                    Change="@(args => ApplyFilters())" Style="width: 100%;" />
                </RadzenFormField>
            </RadzenColumn>

            <!-- Results count -->
            <RadzenColumn Size="6" SizeMD="2">
                <RadzenStack Style="height: 100%;" JustifyContent="JustifyContent.End">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0; text-align: center;">
                        @filteredCourses.Count cursuri
                    </RadzenText>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Courses Table -->
    <RadzenCard Style="padding: 0; overflow: hidden;">
        @if (isLoading)
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
                    Se încarcă cursurile...
                </RadzenText>
            </RadzenStack>
        }
        else if (!filteredCourses.Any())
        {
            <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Class="rz-p-6" Gap="1rem">
                <RadzenIcon Icon="menu_book" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Niciun curs găsit</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">@GetEmptyMessage()</RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenDataGrid @ref="grid" Data="@filteredCourses" TItem="CourseListDto"
                            AllowSorting="true" AllowPaging="false"
                            Style="border: none;">
                <Columns>
                    <RadzenDataGridColumn TItem="CourseListDto" Property="Code" Title="Cod" Width="100px" Sortable="true">
                        <Template Context="course">
                            <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-family: monospace; font-weight: 500;">
                                @course.Code
                            </RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CourseListDto" Property="Name" Title="Nume" Sortable="true">
                        <Template Context="course">
                            <RadzenStack Gap="0.125rem">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@course.Name</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">@course.ProgramName</RadzenText>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CourseListDto" Property="ProfessorName" Title="Profesor" Sortable="true" />
                    <RadzenDataGridColumn TItem="CourseListDto" Property="Credits" Title="Credite" Width="100px" Sortable="true">
                        <Template Context="course">
                            <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@($"{course.Credits} ECTS")" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CourseListDto" Property="Year" Title="An/Sem" Width="100px" Sortable="true">
                        <Template Context="course">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">An @course.Year</RadzenText>
                                <RadzenBadge BadgeStyle="@GetSemesterBadgeStyle(course.Semester)" Text="@($"S{course.Semester}")" IsPill="true" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CourseListDto" Property="StudentsCount" Title="Studenți" Width="90px" Sortable="true" />
                    <RadzenDataGridColumn TItem="CourseListDto" Property="IsActive" Title="Status" Width="100px" Sortable="true">
                        <Template Context="course">
                            <RadzenBadge BadgeStyle="@(course.IsActive ? BadgeStyle.Success : BadgeStyle.Light)"
                                        Text="@(course.IsActive ? "Activ" : "Inactiv")" IsPill="true" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="CourseListDto" Title="Acțiuni" Width="180px" TextAlign="TextAlign.End" Sortable="false">
                        <Template Context="course">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" JustifyContent="JustifyContent.End">
                                <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Info" Variant="Variant.Text" Size="ButtonSize.Small"
                                              Click="@(() => NavigateToDetails(course.Id))" />
                                @if (CanManageCourses)
                                {
                                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Warning" Variant="Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => NavigateToEdit(course.Id))" />
                                    @if (course.IsActive)
                                    {
                                        <RadzenButton Icon="block" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small"
                                                      Click="@(() => ConfirmDeactivate(course))" />
                                    }
                                }
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </RadzenCard>
</RadzenStack>

@code {
    private RadzenDataGrid<CourseListDto>? grid;
    private List<CourseListDto> courses = new();
    private List<CourseListDto> filteredCourses = new();
    private bool isLoading = true;
    private bool CanManageCourses = false;
    private UserRole? currentUserRole;
    private Guid? currentProfessorId;

    private string searchTerm = "";
    private string? selectedYear;
    private string? selectedSemester;
    private string? selectedStatus;

    // Filter options
    private List<dynamic> yearOptions = new List<dynamic>
    {
        new { Text = "Toți anii", Value = (string?)null },
        new { Text = "Anul 1", Value = "1" },
        new { Text = "Anul 2", Value = "2" },
        new { Text = "Anul 3", Value = "3" },
        new { Text = "Anul 4", Value = "4" }
    };

    private List<dynamic> semesterOptions = new List<dynamic>
    {
        new { Text = "Ambele", Value = (string?)null },
        new { Text = "Semestrul 1", Value = "1" },
        new { Text = "Semestrul 2", Value = "2" }
    };

    private List<dynamic> statusOptions = new List<dynamic>
    {
        new { Text = "Toate", Value = (string?)null },
        new { Text = "Active", Value = "active" },
        new { Text = "Inactive", Value = "inactive" }
    };

    // Search debounce
    private System.Threading.Timer? searchTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRole();
        await LoadCourses();
    }

    private async Task LoadUserRole()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                currentUserRole = appUser.Role;
                CanManageCourses = appUser.Role == UserRole.Secretary ||
                                   appUser.Role == UserRole.Dean ||
                                   appUser.Role == UserRole.Admin;

                if (appUser.Role == UserRole.Professor && appUser.Professor != null)
                {
                    currentProfessorId = appUser.Professor.Id;
                }
            }
        }
    }

    private async Task LoadCourses()
    {
        isLoading = true;
        try
        {
            var filter = new CourseFilter();

            if (currentUserRole == UserRole.Professor && currentProfessorId.HasValue)
            {
                filter.ProfessorId = currentProfessorId.Value;
            }
            else if (currentUserRole == UserRole.Student)
            {
                filter.IsActive = true;
            }

            courses = await CourseService.GetAllAsync(filter);
            ApplyClientFilters();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        ApplyClientFilters();
    }

    private void ApplyClientFilters()
    {
        filteredCourses = courses.Where(c =>
        {
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                var search = searchTerm.ToLower();
                if (!c.Name.ToLower().Contains(search) && !c.Code.ToLower().Contains(search))
                    return false;
            }

            if (!string.IsNullOrWhiteSpace(selectedYear) && int.TryParse(selectedYear, out int year))
            {
                if (c.Year != year)
                    return false;
            }

            if (!string.IsNullOrWhiteSpace(selectedSemester) && int.TryParse(selectedSemester, out int semester))
            {
                if (c.Semester != semester)
                    return false;
            }

            if (!string.IsNullOrWhiteSpace(selectedStatus))
            {
                var isActive = selectedStatus == "active";
                if (c.IsActive != isActive)
                    return false;
            }

            return true;
        }).ToList();
    }

    private void OnSearchChanged(ChangeEventArgs args)
    {
        searchTerm = args.Value?.ToString() ?? "";
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                ApplyFilters();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task ConfirmDeactivate(CourseListDto course)
    {
        var result = await DialogService.Confirm(
            $"Sigur doriți să dezactivați cursul {course.Name}?",
            "Confirmare Dezactivare",
            new ConfirmOptions
            {
                OkButtonText = "Dezactivează",
                CancelButtonText = "Anulează"
            });

        if (result == true)
        {
            var deleteResult = await CourseService.DeleteAsync(course.Id);
            if (deleteResult.Succeeded)
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Succes",
                    Detail = "Cursul a fost dezactivat cu succes.",
                    Duration = 4000
                });
                await LoadCourses();
            }
            else
            {
                RadzenNotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Eroare",
                    Detail = deleteResult.ErrorMessage ?? "Nu s-a putut dezactiva cursul.",
                    Duration = 4000
                });
            }
        }
    }

    private void NavigateToCreate() => Navigation.NavigateTo("/cursuri/nou");
    private void NavigateToDetails(Guid id) => Navigation.NavigateTo($"/cursuri/{id}");
    private void NavigateToEdit(Guid id) => Navigation.NavigateTo($"/cursuri/{id}/editare");

    private BadgeStyle GetSemesterBadgeStyle(int semester)
    {
        return semester == 1 ? BadgeStyle.Info : BadgeStyle.Success;
    }

    private string GetSubtitle()
    {
        return currentUserRole switch
        {
            UserRole.Professor => "Cursurile tale",
            UserRole.Student => "Cursuri disponibile",
            _ => "Gestionează cursurile din sistem"
        };
    }

    private string GetEmptyMessage()
    {
        if (!string.IsNullOrWhiteSpace(searchTerm))
            return "Încearcă să modifici filtrele de căutare.";

        return currentUserRole switch
        {
            UserRole.Professor => "Nu ai cursuri asignate.",
            UserRole.Student => "Nu există cursuri disponibile pentru programul tău.",
            _ => "Nu există cursuri în sistem. Adaugă primul curs."
        };
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}
