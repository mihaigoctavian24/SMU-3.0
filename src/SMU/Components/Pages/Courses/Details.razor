@page "/cursuri/{id:guid}"
@using SMU.Models
@using SMU.Services
@using SMU.Data.Entities
@using Microsoft.AspNetCore.Authorization
@inject ICourseService CourseService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>@(course?.Name ?? "Detalii Curs") - SMU</PageTitle>

@if (isLoading)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 3rem 0;">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin-top: 1rem;">
            Se încarcă detaliile cursului...
        </RadzenText>
    </RadzenStack>
}
else if (course == null)
{
    <RadzenCard Style="text-align: center; padding: 3rem;">
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem">
            <RadzenIcon Icon="error_outline" Style="font-size: 48px; color: var(--rz-text-disabled-color);" />
            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Curs negăsit</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                Cursul căutat nu există sau a fost șters.
            </RadzenText>
            <RadzenButton Text="Înapoi la Cursuri" Icon="arrow_back" ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => Navigation.NavigateTo("/cursuri"))" Style="margin-top: 1rem;" />
        </RadzenStack>
    </RadzenCard>
}
else
{
    <RadzenStack Gap="1.5rem">
        <!-- Header -->
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Start">
                <RadzenButton Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text" Size="ButtonSize.Large"
                              Click="@(() => Navigation.NavigateTo("/cursuri"))" />
                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">@course.Name</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="margin: 0;">
                        @course.Code • @course.ProgramName
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>
            <RadzenBadge BadgeStyle="@(course.IsActive ? BadgeStyle.Success : BadgeStyle.Light)"
                        Text="@(course.IsActive ? "Activ" : "Inactiv")" IsPill="true" />
        </RadzenStack>

        <!-- Stats Cards -->
        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="height: 100%;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <div style="width: 48px; height: 48px; background: var(--rz-primary-lighter); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="groups" Style="color: var(--rz-primary);" />
                        </div>
                        <RadzenStack Gap="0.125rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Studenți Înscriși</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@course.Stats.EnrolledStudents</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="height: 100%;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <div style="width: 48px; height: 48px; background: var(--rz-success-lighter); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                        </div>
                        <RadzenStack Gap="0.125rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Medie Generală</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@course.Stats.AverageGrade.ToString("0.00")</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="height: 100%;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <div style="width: 48px; height: 48px; background: var(--rz-info-lighter); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="bar_chart" Style="color: var(--rz-info);" />
                        </div>
                        <RadzenStack Gap="0.125rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Rată Promovare</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@course.Stats.PassRate.ToString("0")%</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                <RadzenCard Style="height: 100%;">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                        <div style="width: 48px; height: 48px; background: var(--rz-warning-lighter); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                            <RadzenIcon Icon="event" Style="color: var(--rz-warning);" />
                        </div>
                        <RadzenStack Gap="0.125rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Total Cursuri</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; font-weight: 700;">@course.Stats.TotalClasses</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow Gap="1.5rem" RowGap="1.5rem">
            <!-- Course Information -->
            <RadzenColumn Size="12" SizeLG="8">
                <RadzenStack Gap="1.5rem">
                    <!-- Main Info -->
                    <RadzenCard>
                        <RadzenStack Gap="1rem">
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Informații Curs</RadzenText>

                            <RadzenRow Gap="1rem" RowGap="1rem">
                                <RadzenColumn Size="6">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Cod Curs</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-family: monospace;">@course.Code</RadzenText>
                                    </RadzenStack>
                                </RadzenColumn>
                                <RadzenColumn Size="6">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Credite ECTS</RadzenText>
                                        <div>
                                            <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@($"{course.Credits} ECTS")" IsPill="true" />
                                        </div>
                                    </RadzenStack>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenRow Gap="1rem" RowGap="1rem">
                                <RadzenColumn Size="6">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">An de Studiu</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">Anul @course.Year</RadzenText>
                                    </RadzenStack>
                                </RadzenColumn>
                                <RadzenColumn Size="6">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Semestru</RadzenText>
                                        <div>
                                            <RadzenBadge BadgeStyle="@GetSemesterBadgeStyle(course.Semester)"
                                                        Text="@($"Semestrul {course.Semester}")" IsPill="true" />
                                        </div>
                                    </RadzenStack>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Program de Studii</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@course.ProgramName</RadzenText>
                            </RadzenStack>

                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Facultate</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@course.FacultyName</RadzenText>
                            </RadzenStack>

                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Profesor</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@course.ProfessorName</RadzenText>
                            </RadzenStack>

                            @if (!string.IsNullOrWhiteSpace(course.Description))
                            {
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin: 0;">Descriere</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@course.Description</RadzenText>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </RadzenCard>

                    <!-- Recent Grades -->
                    @if (course.RecentGrades.Any())
                    {
                        <RadzenCard>
                            <RadzenStack Gap="1rem">
                                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Ultimele Note</RadzenText>
                                <RadzenDataGrid Data="@course.RecentGrades" TItem="RecentGradeDto"
                                                AllowSorting="false" AllowPaging="false">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="RecentGradeDto" Property="StudentName" Title="Student" />
                                        <RadzenDataGridColumn TItem="RecentGradeDto" Property="Value" Title="Notă" Width="100px">
                                            <Template Context="grade">
                                                <RadzenBadge BadgeStyle="@GetGradeBadgeStyle(grade.Value)"
                                                            Text="@grade.Value.ToString("0.00")" IsPill="true" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="RecentGradeDto" Property="Type" Title="Tip" Width="120px" />
                                        <RadzenDataGridColumn TItem="RecentGradeDto" Property="ExamDate" Title="Data" Width="120px">
                                            <Template Context="grade">
                                                @grade.ExamDate.ToString("dd.MM.yyyy")
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="RecentGradeDto" Property="Status" Title="Status" Width="120px">
                                            <Template Context="grade">
                                                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(grade.Status)"
                                                            Text="@grade.Status" IsPill="true" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            </RadzenStack>
                        </RadzenCard>
                    }
                </RadzenStack>
            </RadzenColumn>

            <!-- Quick Actions -->
            <RadzenColumn Size="12" SizeLG="4">
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Acțiuni Rapide</RadzenText>

                        <RadzenStack Gap="0.75rem">
                            <RadzenCard Style="cursor: pointer; border: 1px solid var(--rz-border-color);"
                                       @onclick="@(() => Navigation.NavigateTo($"/note?courseId={course.Id}"))">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                        <RadzenIcon Icon="description" />
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Vezi Note</RadzenText>
                                    </RadzenStack>
                                    <RadzenIcon Icon="chevron_right" />
                                </RadzenStack>
                            </RadzenCard>

                            <RadzenCard Style="cursor: pointer; border: 1px solid var(--rz-border-color);"
                                       @onclick="@(() => Navigation.NavigateTo($"/prezente?courseId={course.Id}"))">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                        <RadzenIcon Icon="assignment_turned_in" />
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Vezi Prezențe</RadzenText>
                                    </RadzenStack>
                                    <RadzenIcon Icon="chevron_right" />
                                </RadzenStack>
                            </RadzenCard>

                            <RadzenCard Style="cursor: pointer; border: 1px solid var(--rz-border-color);"
                                       @onclick="@(() => Navigation.NavigateTo($"/orar?courseId={course.Id}"))">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                        <RadzenIcon Icon="event" />
                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">Vezi Orar</RadzenText>
                                    </RadzenStack>
                                    <RadzenIcon Icon="chevron_right" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private CourseDetailDto? course;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCourse();
    }

    private async Task LoadCourse()
    {
        isLoading = true;
        try
        {
            course = await CourseService.GetByIdAsync(Id);
        }
        finally
        {
            isLoading = false;
        }
    }

    private BadgeStyle GetSemesterBadgeStyle(int semester)
    {
        return semester == 1 ? BadgeStyle.Info : BadgeStyle.Success;
    }

    private BadgeStyle GetGradeBadgeStyle(decimal value)
    {
        if (value >= 9) return BadgeStyle.Success;
        if (value >= 7) return BadgeStyle.Info;
        if (value >= 5) return BadgeStyle.Warning;
        return BadgeStyle.Danger;
    }

    private BadgeStyle GetStatusBadgeStyle(string status)
    {
        return status switch
        {
            "Approved" => BadgeStyle.Success,
            "Pending" => BadgeStyle.Warning,
            "Rejected" => BadgeStyle.Danger,
            _ => BadgeStyle.Light
        };
    }
}
